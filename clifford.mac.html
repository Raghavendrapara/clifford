<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/1999/REC-html401-19991224/strict.dtd">
<html>
<head>
<META http-equiv=Content-Type content="text/html; charset=UTF-8">
<title>Exported from Notepad++</title>
<style type="text/css">
span {
	font-family: 'Courier New';
	font-size: 10pt;
	color: #000000;
}
.sc0 {
	font-family: 'Arial';
	font-weight: bold;
}
.sc1 {
	font-style: italic;
	color: #008000;
}
.sc2 {
	color: #008000;
}
.sc3 {
}
.sc4 {
	font-family: 'Arial';
	font-weight: bold;
	font-style: italic;
	color: #0080FF;
}
.sc5 {
	font-family: 'Arial';
	font-weight: bold;
	font-style: italic;
	color: #800000;
}
.sc6 {
	color: #FF8000;
}
.sc7 {
	font-family: 'Arial';
	font-style: italic;
	color: #FF8000;
}
.sc8 {
	font-family: 'Arial';
	font-weight: bold;
	font-style: italic;
	color: #8000FF;
}
.sc9 {
	font-family: 'Arial';
	font-weight: bold;
	font-style: italic;
	color: #808000;
}
.sc12 {
	font-weight: bold;
}
.sc13 {
}
.sc24 {
}
</style>
</head>
<body>
<div style="float: left; white-space: pre; line-height: 1; background: #FFFFFF; "><span class="sc1">/*******************************
Clifford algebra
a lightweight package for performing Geometric Algebra calculations

 @version 
    2.4.5 Date 20 Feb 2019
    - bugfix in operpart
    
    2.4.4 Date 18 May 2018,
    - fix in clidual
    - fix in dual
    - grades function
    - countsym depreciation
    
    2.4.3 Date 23 Aug 2017
    - bugfixes in map usage
    
    2.4.2 Date 17 July 2017
    -bugfix in explodeop
    - change in oppart
    - dotexpand
    
    2.4.1 Date 17 Jun 2017
    - simplification of Clifford exponents
    - trigsimp inncorporated in cliffsimpall
    - solving 
    
    older log: changelog.txt
    
  @license This library is free software; you can redistribute it and/or
        modify it under the terms of the GNU Lesser General Public
        License as published by the Free Software Foundation; either
        version 2.1 of the License, or (at your option) any later version.
  
        This library is distributed in the hope that it will be useful,
        but WITHOUT ANY WARRANTY; without even the implied warranty of
        MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
         Lesser General Public License for more details.
  
        You should have received a copy of the GNU Lesser General Public
        License along with this library; if not, write to the Free Software
        Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA
 */</span><span class="sc24">

</span><span class="sc5">max_version</span><span class="sc12">:</span><span class="sc4">args</span><span class="sc13">(</span><span class="sc0">build_info</span><span class="sc24"> </span><span class="sc13">())</span><span class="sc0">[1];</span><span class="sc24">
</span><span class="sc4">if</span><span class="sc24"> </span><span class="sc5">orderlessp</span><span class="sc13">(</span><span class="sc5">max_version,</span><span class="sc2">"5.37"</span><span class="sc13">)</span><span class="sc24"> </span><span class="sc4">then</span><span class="sc24"> </span><span class="sc4">error</span><span class="sc13">(</span><span class="sc2">"Maxima verision "</span><span class="sc0">,</span><span class="sc24"> </span><span class="sc5">max_version,</span><span class="sc24"> </span><span class="sc2">" not supported"</span><span class="sc13">)</span><span class="sc0">;</span><span class="sc24">
 
</span><span class="sc7">ttyoff</span><span class="sc12">:</span><span class="sc8">true;</span><span class="sc24">
 
</span><span class="sc2">"vector symbol"</span><span class="sc0">;</span><span class="sc24">
</span><span class="sc0">asymbol</span><span class="sc12">:</span><span class="sc0">e;</span><span class="sc24">
</span><span class="sc2">"number of dimensions"</span><span class="sc0">;</span><span class="sc24">
</span><span class="sc0">ndim</span><span class="sc12">:</span><span class="sc0">0;</span><span class="sc24">
</span><span class="sc5">signature</span><span class="sc12">:</span><span class="sc0">[];</span><span class="sc24">
</span><span class="sc2">"pseudoscalar"</span><span class="sc0">;</span><span class="sc24">
</span><span class="sc8">%iv</span><span class="sc12">:</span><span class="sc0">1;</span><span class="sc24">
</span><span class="sc2">"squre of pseudoscalar"</span><span class="sc0">;</span><span class="sc24">
</span><span class="sc8">%ivnorm</span><span class="sc12">:</span><span class="sc0">1;</span><span class="sc24">
</span><span class="sc2">"elements of the algebra"</span><span class="sc0">;</span><span class="sc24">
</span><span class="sc8">%elements</span><span class="sc12">:</span><span class="sc0">[1];</span><span class="sc24">

</span><span class="sc0">_debug</span><span class="sc12">:</span><span class="sc8">false;</span><span class="sc24">
</span><span class="sc7">dotexptsimp</span><span class="sc24"> </span><span class="sc12">:</span><span class="sc8">false;</span><span class="sc24">
</span><span class="sc7">noundisp</span><span class="sc24"> </span><span class="sc12">:</span><span class="sc8">true;</span><span class="sc24">
</span><span class="sc7">dotscrules</span><span class="sc12">:</span><span class="sc8">true;</span><span class="sc24">
</span><span class="sc7">powerdisp</span><span class="sc12">:</span><span class="sc8">true;</span><span class="sc24">
</span><span class="sc7">dotconstrules</span><span class="sc12">:</span><span class="sc8">false;</span><span class="sc24">
</span><span class="sc5">prederror</span><span class="sc24"> </span><span class="sc12">:</span><span class="sc8">false;</span><span class="sc24">
</span><span class="sc5">stringdisp</span><span class="sc12">:</span><span class="sc8">true;</span><span class="sc24">
</span><span class="sc5">ratprint</span><span class="sc12">:</span><span class="sc8">false;</span><span class="sc24">
</span><span class="sc7">powerdisp</span><span class="sc12">:</span><span class="sc8">true;</span><span class="sc24">
</span><span class="sc7">pfeformat</span><span class="sc12">:</span><span class="sc24"> </span><span class="sc8">true;</span><span class="sc24">
</span><span class="sc1">/*
 custom operators
*/</span><span class="sc24">

    </span><span class="sc4">infix</span><span class="sc24"> </span><span class="sc13">(</span><span class="sc2">"xor"</span><span class="sc0">,</span><span class="sc24"> </span><span class="sc0">60,</span><span class="sc24"> </span><span class="sc3">60</span><span class="sc13">)</span><span class="sc0">;</span><span class="sc24">
    </span><span class="sc2">"xor"</span><span class="sc24"> </span><span class="sc13">(</span><span class="sc0">a,</span><span class="sc24"> </span><span class="sc0">b</span><span class="sc13">)</span><span class="sc12">:=</span><span class="sc24"> </span><span class="sc4">block</span><span class="sc24"> </span><span class="sc13">(</span><span class="sc0">[la</span><span class="sc12">:</span><span class="sc0">[],</span><span class="sc24"> </span><span class="sc0">lb</span><span class="sc12">:</span><span class="sc0">[]],</span><span class="sc24">
        </span><span class="sc4">if</span><span class="sc24"> </span><span class="sc5">listp</span><span class="sc13">(</span><span class="sc0">a</span><span class="sc13">)</span><span class="sc24"> </span><span class="sc4">and</span><span class="sc24"> </span><span class="sc5">listp</span><span class="sc13">(</span><span class="sc0">b</span><span class="sc13">)</span><span class="sc24"> </span><span class="sc4">then</span><span class="sc24"> </span><span class="sc13">(</span><span class="sc24">
            </span><span class="sc0">la</span><span class="sc12">:</span><span class="sc24"> </span><span class="sc5">sublist</span><span class="sc24"> </span><span class="sc13">(</span><span class="sc0">a,</span><span class="sc24">  </span><span class="sc4">lambda</span><span class="sc13">(</span><span class="sc0">[u],</span><span class="sc24"> </span><span class="sc4">not</span><span class="sc24"> </span><span class="sc5">member</span><span class="sc13">(</span><span class="sc0">u,</span><span class="sc24"> </span><span class="sc0">b</span><span class="sc13">))</span><span class="sc24"> </span><span class="sc13">)</span><span class="sc0">,</span><span class="sc24">
            </span><span class="sc0">lb</span><span class="sc12">:</span><span class="sc24"> </span><span class="sc5">sublist</span><span class="sc24"> </span><span class="sc13">(</span><span class="sc0">b,</span><span class="sc24">  </span><span class="sc4">lambda</span><span class="sc13">(</span><span class="sc0">[u],</span><span class="sc24"> </span><span class="sc4">not</span><span class="sc24"> </span><span class="sc5">member</span><span class="sc13">(</span><span class="sc0">u,</span><span class="sc24"> </span><span class="sc0">a</span><span class="sc13">))</span><span class="sc24"> </span><span class="sc13">)</span><span class="sc0">,</span><span class="sc24">
            </span><span class="sc5">append</span><span class="sc13">(</span><span class="sc0">la,</span><span class="sc24"> </span><span class="sc0">lb</span><span class="sc13">)</span><span class="sc24">
        </span><span class="sc13">)</span><span class="sc24"> </span><span class="sc4">else</span><span class="sc24"> 
        </span><span class="sc13">(</span><span class="sc0">a</span><span class="sc24"> </span><span class="sc4">or</span><span class="sc24"> </span><span class="sc0">b</span><span class="sc13">)</span><span class="sc24"> </span><span class="sc4">and</span><span class="sc24"> </span><span class="sc4">not</span><span class="sc24"> </span><span class="sc13">(</span><span class="sc0">a</span><span class="sc24"> </span><span class="sc4">and</span><span class="sc24"> </span><span class="sc0">b</span><span class="sc13">)</span><span class="sc24">
    </span><span class="sc13">)</span><span class="sc0">;</span><span class="sc24">

    </span><span class="sc1">/* 
    different types of products 
    */</span><span class="sc24">
    </span><span class="sc4">infix</span><span class="sc24"> </span><span class="sc13">(</span><span class="sc2">"|"</span><span class="sc0">,</span><span class="sc24"> </span><span class="sc0">135,</span><span class="sc24"> </span><span class="sc3">134</span><span class="sc13">)</span><span class="sc0">;</span><span class="sc24">  
    </span><span class="sc5">texput</span><span class="sc24"> </span><span class="sc13">(</span><span class="sc2">"|"</span><span class="sc0">,</span><span class="sc24"> </span><span class="sc2">" \\circ "</span><span class="sc0">,</span><span class="sc24"> </span><span class="sc4">infix</span><span class="sc13">)</span><span class="sc0">;</span><span class="sc24">
    
    </span><span class="sc0">wedgesimp</span><span class="sc12">:</span><span class="sc8">true;</span><span class="sc24">
    </span><span class="sc0">inprotype</span><span class="sc12">:</span><span class="sc0">sym;</span><span class="sc24">
    </span><span class="sc2">"Hestenes product type"</span><span class="sc0">;</span><span class="sc24">
    </span><span class="sc0">ipdecomp</span><span class="sc12">:</span><span class="sc8">false;</span><span class="sc24"> 
    
    </span><span class="sc4">declare</span><span class="sc13">(</span><span class="sc2">"|"</span><span class="sc0">,</span><span class="sc24"> </span><span class="sc9">additive</span><span class="sc13">)</span><span class="sc0">;</span><span class="sc24">
    </span><span class="sc2">"|"</span><span class="sc13">(</span><span class="sc0">a,</span><span class="sc24"> </span><span class="sc0">b</span><span class="sc13">)</span><span class="sc12">:=</span><span class="sc24"> </span><span class="sc4">block</span><span class="sc24"> </span><span class="sc13">(</span><span class="sc0">[l,r,</span><span class="sc24"> </span><span class="sc5">qq,</span><span class="sc24"> </span><span class="sc0">ret</span><span class="sc12">:</span><span class="sc0">0],</span><span class="sc24">
        </span><span class="sc4">if</span><span class="sc24"> </span><span class="sc0">ndim</span><span class="sc12">=</span><span class="sc3">0</span><span class="sc24"> </span><span class="sc4">then</span><span class="sc24"> </span><span class="sc4">return</span><span class="sc24"> </span><span class="sc13">(</span><span class="sc24"> </span><span class="sc4">buildq</span><span class="sc13">(</span><span class="sc0">[a,b],</span><span class="sc24"> </span><span class="sc2">"|"</span><span class="sc13">(</span><span class="sc0">a,</span><span class="sc24"> </span><span class="sc0">b</span><span class="sc13">)))</span><span class="sc0">,</span><span class="sc24">
        </span><span class="sc4">if</span><span class="sc24"> </span><span class="sc5">scalarp</span><span class="sc13">(</span><span class="sc0">a</span><span class="sc13">)</span><span class="sc24"> </span><span class="sc4">or</span><span class="sc24"> </span><span class="sc5">scalarp</span><span class="sc13">(</span><span class="sc0">b</span><span class="sc13">)</span><span class="sc24"> </span><span class="sc4">then</span><span class="sc24"> </span><span class="sc13">(</span><span class="sc24">
            </span><span class="sc4">if</span><span class="sc24"> </span><span class="sc0">inprotype</span><span class="sc12">='</span><span class="sc5">lc</span><span class="sc24"> </span><span class="sc4">then</span><span class="sc24"> 
                </span><span class="sc4">if</span><span class="sc24"> </span><span class="sc5">scalarp</span><span class="sc13">(</span><span class="sc0">a</span><span class="sc13">)</span><span class="sc24"> </span><span class="sc4">then</span><span class="sc24"> </span><span class="sc0">ret</span><span class="sc12">:</span><span class="sc24"> </span><span class="sc0">a</span><span class="sc12">*</span><span class="sc0">b</span><span class="sc24"> </span><span class="sc4">else</span><span class="sc24"> </span><span class="sc0">ret</span><span class="sc12">:</span><span class="sc3">0</span><span class="sc24">
            </span><span class="sc4">elseif</span><span class="sc24"> </span><span class="sc0">inprotype</span><span class="sc12">='</span><span class="sc0">rc</span><span class="sc24"> </span><span class="sc4">then</span><span class="sc24"> 
                </span><span class="sc4">if</span><span class="sc24"> </span><span class="sc5">scalarp</span><span class="sc13">(</span><span class="sc0">b</span><span class="sc13">)</span><span class="sc24"> </span><span class="sc4">then</span><span class="sc24"> </span><span class="sc0">ret</span><span class="sc12">:</span><span class="sc24"> </span><span class="sc0">a</span><span class="sc12">*</span><span class="sc0">b</span><span class="sc24"> </span><span class="sc4">else</span><span class="sc24"> </span><span class="sc0">ret</span><span class="sc12">:</span><span class="sc3">0</span><span class="sc24">
            </span><span class="sc4">elseif</span><span class="sc24"> </span><span class="sc0">inprotype</span><span class="sc12">='</span><span class="sc0">sym</span><span class="sc24"> </span><span class="sc4">then</span><span class="sc24"> </span><span class="sc0">ret</span><span class="sc12">:</span><span class="sc0">a.b,</span><span class="sc24">
            </span><span class="sc4">if</span><span class="sc24"> </span><span class="sc0">ipdecomp</span><span class="sc12">=</span><span class="sc8">true</span><span class="sc24"> </span><span class="sc4">and</span><span class="sc24">  </span><span class="sc13">(</span><span class="sc5">scalarp</span><span class="sc13">(</span><span class="sc0">a</span><span class="sc13">)</span><span class="sc24"> </span><span class="sc4">or</span><span class="sc24">  </span><span class="sc5">scalarp</span><span class="sc13">(</span><span class="sc0">b</span><span class="sc13">))</span><span class="sc24"> </span><span class="sc4">then</span><span class="sc24"> </span><span class="sc4">return</span><span class="sc13">(</span><span class="sc3">0</span><span class="sc13">)</span><span class="sc0">,</span><span class="sc24">
            </span><span class="sc4">return</span><span class="sc13">(</span><span class="sc0">ret</span><span class="sc13">)</span><span class="sc24">
        </span><span class="sc13">)</span><span class="sc0">,</span><span class="sc24">
        </span><span class="sc4">if</span><span class="sc24"> </span><span class="sc4">not</span><span class="sc24"> </span><span class="sc5">mapatom</span><span class="sc13">(</span><span class="sc0">a</span><span class="sc13">)</span><span class="sc24"> </span><span class="sc4">then</span><span class="sc24"> </span><span class="sc0">a</span><span class="sc12">:</span><span class="sc5">expand</span><span class="sc13">(</span><span class="sc0">a</span><span class="sc13">)</span><span class="sc0">,</span><span class="sc24">
        </span><span class="sc4">if</span><span class="sc24"> </span><span class="sc4">not</span><span class="sc24"> </span><span class="sc5">mapatom</span><span class="sc13">(</span><span class="sc0">b</span><span class="sc13">)</span><span class="sc24"> </span><span class="sc4">then</span><span class="sc24"> </span><span class="sc0">b</span><span class="sc12">:</span><span class="sc5">expand</span><span class="sc13">(</span><span class="sc0">b</span><span class="sc13">)</span><span class="sc0">,</span><span class="sc24">
        </span><span class="sc4">if</span><span class="sc24"> </span><span class="sc5">inop</span><span class="sc13">(</span><span class="sc0">a</span><span class="sc13">)</span><span class="sc12">=</span><span class="sc2">"+"</span><span class="sc24"> </span><span class="sc4">then</span><span class="sc24"> </span><span class="sc4">return</span><span class="sc24"> </span><span class="sc13">(</span><span class="sc5">map</span><span class="sc13">(</span><span class="sc24"> </span><span class="sc4">lambda</span><span class="sc24"> </span><span class="sc13">(</span><span class="sc0">[u],</span><span class="sc24">  </span><span class="sc0">u</span><span class="sc24"> </span><span class="sc12">|</span><span class="sc24"> </span><span class="sc0">b</span><span class="sc13">)</span><span class="sc0">,</span><span class="sc24"> </span><span class="sc0">a</span><span class="sc13">))</span><span class="sc0">,</span><span class="sc24">
        </span><span class="sc4">if</span><span class="sc24"> </span><span class="sc5">inop</span><span class="sc13">(</span><span class="sc0">b</span><span class="sc13">)</span><span class="sc12">=</span><span class="sc2">"+"</span><span class="sc24"> </span><span class="sc4">then</span><span class="sc24"> </span><span class="sc4">return</span><span class="sc24"> </span><span class="sc13">(</span><span class="sc5">map</span><span class="sc13">(</span><span class="sc24"> </span><span class="sc4">lambda</span><span class="sc24"> </span><span class="sc13">(</span><span class="sc0">[u],</span><span class="sc24">  </span><span class="sc0">a</span><span class="sc24"> </span><span class="sc12">|</span><span class="sc24"> </span><span class="sc0">u</span><span class="sc13">)</span><span class="sc0">,</span><span class="sc24"> </span><span class="sc0">b</span><span class="sc13">))</span><span class="sc0">,</span><span class="sc24"> 
        </span><span class="sc4">if</span><span class="sc24"> </span><span class="sc0">wedgesimp</span><span class="sc24"> </span><span class="sc4">then</span><span class="sc24"> </span><span class="sc13">(</span><span class="sc24">
            </span><span class="sc4">if</span><span class="sc24"> </span><span class="sc4">not</span><span class="sc24"> </span><span class="sc5">freeof</span><span class="sc13">(</span><span class="sc2">"."</span><span class="sc0">,</span><span class="sc24"> </span><span class="sc0">a</span><span class="sc13">)</span><span class="sc24"> </span><span class="sc4">then</span><span class="sc24">
                </span><span class="sc0">a</span><span class="sc12">:</span><span class="sc0">cliffsimp1</span><span class="sc13">(</span><span class="sc0">a</span><span class="sc13">)</span><span class="sc0">,</span><span class="sc24">
            </span><span class="sc4">if</span><span class="sc24"> </span><span class="sc4">not</span><span class="sc24"> </span><span class="sc5">freeof</span><span class="sc13">(</span><span class="sc2">"."</span><span class="sc0">,</span><span class="sc24"> </span><span class="sc0">b</span><span class="sc13">)</span><span class="sc24"> </span><span class="sc4">then</span><span class="sc24">
                </span><span class="sc0">b</span><span class="sc12">:</span><span class="sc0">cliffsimp1</span><span class="sc13">(</span><span class="sc0">b</span><span class="sc13">)</span><span class="sc24">
        </span><span class="sc13">)</span><span class="sc0">,</span><span class="sc24">
        </span><span class="sc0">l</span><span class="sc12">:</span><span class="sc5">maxgrade</span><span class="sc13">(</span><span class="sc0">a</span><span class="sc13">)</span><span class="sc0">,</span><span class="sc24">
        </span><span class="sc0">r</span><span class="sc12">:</span><span class="sc5">maxgrade</span><span class="sc13">(</span><span class="sc0">b</span><span class="sc13">)</span><span class="sc0">,</span><span class="sc24">
        </span><span class="sc5">qq</span><span class="sc12">:</span><span class="sc24"> </span><span class="sc0">l</span><span class="sc12">-</span><span class="sc0">r,</span><span class="sc24">
        </span><span class="sc1">/*display(l, r, qq),*/</span><span class="sc24">
        </span><span class="sc4">if</span><span class="sc24"> </span><span class="sc0">inprotype</span><span class="sc12">='</span><span class="sc0">rc</span><span class="sc24"> </span><span class="sc4">then</span><span class="sc24"> 
            </span><span class="sc4">if</span><span class="sc24"> </span><span class="sc5">qq</span><span class="sc12">&lt;</span><span class="sc3">0</span><span class="sc24"> </span><span class="sc4">then</span><span class="sc24"> </span><span class="sc4">return</span><span class="sc13">(</span><span class="sc3">0</span><span class="sc13">)</span><span class="sc24">
            </span><span class="sc4">elseif</span><span class="sc24"> </span><span class="sc5">qq</span><span class="sc12">&lt;=</span><span class="sc24"> </span><span class="sc0">l</span><span class="sc12">+</span><span class="sc0">r</span><span class="sc24"> </span><span class="sc4">then</span><span class="sc24"> 
                </span><span class="sc0">ret</span><span class="sc12">:</span><span class="sc0">cliffsimp1</span><span class="sc13">(</span><span class="sc0">a.b</span><span class="sc13">)</span><span class="sc0">,</span><span class="sc24">
        </span><span class="sc4">if</span><span class="sc24"> </span><span class="sc0">inprotype</span><span class="sc12">='</span><span class="sc5">lc</span><span class="sc24"> </span><span class="sc4">then</span><span class="sc24"> 
            </span><span class="sc4">if</span><span class="sc24"> </span><span class="sc5">qq</span><span class="sc12">&gt;</span><span class="sc3">0</span><span class="sc24"> </span><span class="sc4">then</span><span class="sc24"> </span><span class="sc4">return</span><span class="sc13">(</span><span class="sc3">0</span><span class="sc13">)</span><span class="sc24">
            </span><span class="sc4">else</span><span class="sc24"> </span><span class="sc13">(</span><span class="sc24">
                </span><span class="sc5">qq</span><span class="sc12">:-</span><span class="sc5">qq,</span><span class="sc24">
                </span><span class="sc4">if</span><span class="sc24"> </span><span class="sc5">qq</span><span class="sc12">&lt;=</span><span class="sc24"> </span><span class="sc0">l</span><span class="sc12">+</span><span class="sc0">r</span><span class="sc24"> </span><span class="sc4">then</span><span class="sc24"> 
                </span><span class="sc0">ret</span><span class="sc12">:</span><span class="sc0">cliffsimp1</span><span class="sc13">(</span><span class="sc0">a.b</span><span class="sc13">)</span><span class="sc24">
        </span><span class="sc13">)</span><span class="sc0">,</span><span class="sc24">
        </span><span class="sc4">if</span><span class="sc24"> </span><span class="sc0">inprotype</span><span class="sc12">='</span><span class="sc0">sym</span><span class="sc24"> </span><span class="sc4">then</span><span class="sc24"> </span><span class="sc13">(</span><span class="sc24">
            </span><span class="sc5">qq</span><span class="sc12">:</span><span class="sc5">abs</span><span class="sc13">(</span><span class="sc5">qq</span><span class="sc13">)</span><span class="sc0">,</span><span class="sc24">
            </span><span class="sc0">ret</span><span class="sc12">:</span><span class="sc0">cliffsimp1</span><span class="sc13">(</span><span class="sc0">a.b</span><span class="sc13">)</span><span class="sc24">
        </span><span class="sc13">)</span><span class="sc0">,</span><span class="sc24">
        </span><span class="sc4">if</span><span class="sc24"> </span><span class="sc0">inprotype</span><span class="sc12">='</span><span class="sc0">ic</span><span class="sc24"> </span><span class="sc4">then</span><span class="sc24"> </span><span class="sc13">(</span><span class="sc24">
            </span><span class="sc5">qq</span><span class="sc12">:</span><span class="sc5">abs</span><span class="sc13">(</span><span class="sc5">qq</span><span class="sc13">)</span><span class="sc0">,</span><span class="sc24">
            </span><span class="sc0">ret</span><span class="sc12">:</span><span class="sc0">cliffsimp1</span><span class="sc13">(</span><span class="sc0">a.</span><span class="sc24"> </span><span class="sc0">invautom</span><span class="sc13">(</span><span class="sc0">b</span><span class="sc13">))</span><span class="sc24">
        </span><span class="sc13">)</span><span class="sc0">,</span><span class="sc24">
        </span><span class="sc0">grpart</span><span class="sc13">(</span><span class="sc0">ret,</span><span class="sc24"> </span><span class="sc5">qq</span><span class="sc13">)</span><span class="sc24">
    </span><span class="sc13">)</span><span class="sc0">;</span><span class="sc24">  
    </span><span class="sc5">texput</span><span class="sc24"> </span><span class="sc13">(</span><span class="sc2">"\\"</span><span class="sc0">,</span><span class="sc24"> </span><span class="sc2">" \\circ "</span><span class="sc0">,</span><span class="sc24"> </span><span class="sc4">infix</span><span class="sc13">)</span><span class="sc0">;</span><span class="sc24">
    
    </span><span class="sc2">"alt-Grassman product type"</span><span class="sc0">;</span><span class="sc24">
    </span><span class="sc0">ipdecompalt</span><span class="sc12">:</span><span class="sc8">false;</span><span class="sc24">
    </span><span class="sc2">"outer product"</span><span class="sc0">;</span><span class="sc24">
    </span><span class="sc4">infix</span><span class="sc13">(</span><span class="sc2">"&amp;"</span><span class="sc0">,</span><span class="sc24"> </span><span class="sc0">135,</span><span class="sc24"> </span><span class="sc3">134</span><span class="sc13">)</span><span class="sc0">;</span><span class="sc24">
    </span><span class="sc4">declare</span><span class="sc13">(</span><span class="sc2">"&amp;"</span><span class="sc0">,</span><span class="sc24"> </span><span class="sc9">additive</span><span class="sc13">)</span><span class="sc0">;</span><span class="sc24">
    
    </span><span class="sc2">"&amp;"</span><span class="sc13">(</span><span class="sc0">a,</span><span class="sc24"> </span><span class="sc0">b</span><span class="sc13">)</span><span class="sc12">:=</span><span class="sc24"> </span><span class="sc4">block</span><span class="sc24"> </span><span class="sc13">(</span><span class="sc0">[l,r,</span><span class="sc24"> </span><span class="sc0">ret</span><span class="sc12">:</span><span class="sc0">0],</span><span class="sc24">
        </span><span class="sc4">if</span><span class="sc24"> </span><span class="sc0">ndim</span><span class="sc12">=</span><span class="sc3">0</span><span class="sc24"> </span><span class="sc4">then</span><span class="sc24"> </span><span class="sc4">return</span><span class="sc24"> </span><span class="sc13">(</span><span class="sc24"> </span><span class="sc4">buildq</span><span class="sc13">(</span><span class="sc0">[a,b],</span><span class="sc24"> </span><span class="sc2">"&amp;"</span><span class="sc13">(</span><span class="sc0">a,</span><span class="sc24"> </span><span class="sc0">b</span><span class="sc13">)))</span><span class="sc0">,</span><span class="sc24">
        </span><span class="sc4">if</span><span class="sc24"> </span><span class="sc0">ipdecompalt</span><span class="sc12">=</span><span class="sc8">true</span><span class="sc24"> </span><span class="sc4">and</span><span class="sc24"> </span><span class="sc13">(</span><span class="sc5">scalarp</span><span class="sc13">(</span><span class="sc0">a</span><span class="sc13">)</span><span class="sc24"> </span><span class="sc4">or</span><span class="sc24"> </span><span class="sc5">scalarp</span><span class="sc13">(</span><span class="sc0">b</span><span class="sc13">))</span><span class="sc24"> </span><span class="sc4">then</span><span class="sc24"> </span><span class="sc4">return</span><span class="sc13">(</span><span class="sc3">0</span><span class="sc13">)</span><span class="sc0">,</span><span class="sc24"> 
        </span><span class="sc4">if</span><span class="sc24"> </span><span class="sc4">not</span><span class="sc24"> </span><span class="sc5">mapatom</span><span class="sc13">(</span><span class="sc0">a</span><span class="sc13">)</span><span class="sc24"> </span><span class="sc4">then</span><span class="sc24"> </span><span class="sc0">a</span><span class="sc12">:</span><span class="sc5">expand</span><span class="sc13">(</span><span class="sc0">a</span><span class="sc13">)</span><span class="sc0">,</span><span class="sc24">
        </span><span class="sc4">if</span><span class="sc24"> </span><span class="sc4">not</span><span class="sc24"> </span><span class="sc5">mapatom</span><span class="sc13">(</span><span class="sc0">b</span><span class="sc13">)</span><span class="sc24"> </span><span class="sc4">then</span><span class="sc24"> </span><span class="sc0">b</span><span class="sc12">:</span><span class="sc5">expand</span><span class="sc13">(</span><span class="sc0">b</span><span class="sc13">)</span><span class="sc0">,</span><span class="sc24">
        </span><span class="sc4">if</span><span class="sc24"> </span><span class="sc5">inop</span><span class="sc13">(</span><span class="sc0">a</span><span class="sc13">)</span><span class="sc12">=</span><span class="sc2">"+"</span><span class="sc24"> </span><span class="sc4">then</span><span class="sc24"> </span><span class="sc4">return</span><span class="sc24"> </span><span class="sc13">(</span><span class="sc5">map</span><span class="sc13">(</span><span class="sc24"> </span><span class="sc4">lambda</span><span class="sc24"> </span><span class="sc13">(</span><span class="sc0">[u],</span><span class="sc24">  </span><span class="sc0">u</span><span class="sc24"> </span><span class="sc12">&amp;</span><span class="sc24"> </span><span class="sc0">b</span><span class="sc13">)</span><span class="sc0">,</span><span class="sc24"> </span><span class="sc0">a</span><span class="sc13">))</span><span class="sc0">,</span><span class="sc24">
        </span><span class="sc4">if</span><span class="sc24"> </span><span class="sc5">inop</span><span class="sc13">(</span><span class="sc0">b</span><span class="sc13">)</span><span class="sc12">=</span><span class="sc2">"+"</span><span class="sc24"> </span><span class="sc4">then</span><span class="sc24"> </span><span class="sc4">return</span><span class="sc24"> </span><span class="sc13">(</span><span class="sc5">map</span><span class="sc13">(</span><span class="sc24"> </span><span class="sc4">lambda</span><span class="sc24"> </span><span class="sc13">(</span><span class="sc0">[u],</span><span class="sc24">  </span><span class="sc0">a</span><span class="sc24"> </span><span class="sc12">&amp;</span><span class="sc24"> </span><span class="sc0">u</span><span class="sc13">)</span><span class="sc0">,</span><span class="sc24"> </span><span class="sc0">b</span><span class="sc13">))</span><span class="sc0">,</span><span class="sc24"> 
        </span><span class="sc4">if</span><span class="sc24"> </span><span class="sc0">wedgesimp</span><span class="sc24"> </span><span class="sc4">then</span><span class="sc24"> </span><span class="sc13">(</span><span class="sc24">
            </span><span class="sc4">if</span><span class="sc24"> </span><span class="sc4">not</span><span class="sc24"> </span><span class="sc5">freeof</span><span class="sc13">(</span><span class="sc2">"."</span><span class="sc0">,</span><span class="sc24"> </span><span class="sc0">a</span><span class="sc13">)</span><span class="sc24"> </span><span class="sc4">then</span><span class="sc24">
                </span><span class="sc0">a</span><span class="sc12">:</span><span class="sc0">cliffsimp1</span><span class="sc13">(</span><span class="sc0">a</span><span class="sc13">)</span><span class="sc0">,</span><span class="sc24">
            </span><span class="sc4">if</span><span class="sc24"> </span><span class="sc4">not</span><span class="sc24"> </span><span class="sc5">freeof</span><span class="sc13">(</span><span class="sc2">"."</span><span class="sc0">,</span><span class="sc24"> </span><span class="sc0">b</span><span class="sc13">)</span><span class="sc24"> </span><span class="sc4">then</span><span class="sc24">
                </span><span class="sc0">b</span><span class="sc12">:</span><span class="sc0">cliffsimp1</span><span class="sc13">(</span><span class="sc0">b</span><span class="sc13">)</span><span class="sc24">
        </span><span class="sc13">)</span><span class="sc0">,</span><span class="sc24">
        </span><span class="sc0">l</span><span class="sc12">:</span><span class="sc5">maxgrade</span><span class="sc13">(</span><span class="sc0">a</span><span class="sc13">)</span><span class="sc0">,</span><span class="sc24">
        </span><span class="sc0">r</span><span class="sc12">:</span><span class="sc5">maxgrade</span><span class="sc13">(</span><span class="sc0">b</span><span class="sc13">)</span><span class="sc0">,</span><span class="sc24">
        </span><span class="sc0">ret</span><span class="sc12">:</span><span class="sc0">cliffsimp1</span><span class="sc13">(</span><span class="sc0">a.b</span><span class="sc13">)</span><span class="sc0">,</span><span class="sc24">
        </span><span class="sc0">ret</span><span class="sc12">:</span><span class="sc0">grpart</span><span class="sc13">(</span><span class="sc0">ret,</span><span class="sc24"> </span><span class="sc0">l</span><span class="sc12">+</span><span class="sc0">r</span><span class="sc13">)</span><span class="sc0">,</span><span class="sc24">
        </span><span class="sc0">ret</span><span class="sc24">
    </span><span class="sc13">)</span><span class="sc0">;</span><span class="sc24">
    
    </span><span class="sc5">texput</span><span class="sc24"> </span><span class="sc13">(</span><span class="sc2">"&amp;"</span><span class="sc0">,</span><span class="sc24"> </span><span class="sc2">" \\wedge "</span><span class="sc0">,</span><span class="sc24"> </span><span class="sc4">infix</span><span class="sc13">)</span><span class="sc0">;</span><span class="sc24">
    
</span><span class="sc1">/*
 various products
*/</span><span class="sc24">

    </span><span class="sc0">outprod</span><span class="sc13">(</span><span class="sc0">a,</span><span class="sc24"> </span><span class="sc0">b</span><span class="sc13">)</span><span class="sc12">:=</span><span class="sc24"> </span><span class="sc4">block</span><span class="sc24"> </span><span class="sc13">(</span><span class="sc0">[ss</span><span class="sc12">:</span><span class="sc0">0,</span><span class="sc24"> </span><span class="sc0">ret</span><span class="sc12">:</span><span class="sc0">0,</span><span class="sc24"> </span><span class="sc0">lva,</span><span class="sc24"> </span><span class="sc0">lvb,</span><span class="sc24"> </span><span class="sc0">z,</span><span class="sc24"> </span><span class="sc0">lvu],</span><span class="sc24">
        </span><span class="sc4">if</span><span class="sc24"> </span><span class="sc0">ipdecompalt</span><span class="sc12">=</span><span class="sc8">true</span><span class="sc24"> </span><span class="sc4">and</span><span class="sc24"> </span><span class="sc13">(</span><span class="sc5">scalarp</span><span class="sc13">(</span><span class="sc0">a</span><span class="sc13">)</span><span class="sc24"> </span><span class="sc4">or</span><span class="sc24"> </span><span class="sc5">scalarp</span><span class="sc13">(</span><span class="sc0">b</span><span class="sc13">))</span><span class="sc24"> </span><span class="sc4">then</span><span class="sc24"> </span><span class="sc4">return</span><span class="sc13">(</span><span class="sc3">0</span><span class="sc13">)</span><span class="sc24">
        </span><span class="sc4">elseif</span><span class="sc24"> </span><span class="sc5">scalarp</span><span class="sc13">(</span><span class="sc0">a</span><span class="sc13">)</span><span class="sc24"> </span><span class="sc4">or</span><span class="sc24"> </span><span class="sc5">scalarp</span><span class="sc13">(</span><span class="sc0">b</span><span class="sc13">)</span><span class="sc24"> </span><span class="sc4">then</span><span class="sc24"> </span><span class="sc4">return</span><span class="sc13">(</span><span class="sc0">a</span><span class="sc12">*</span><span class="sc0">b</span><span class="sc13">)</span><span class="sc0">,</span><span class="sc24">
        </span><span class="sc4">if</span><span class="sc24"> </span><span class="sc4">not</span><span class="sc24"> </span><span class="sc5">mapatom</span><span class="sc13">(</span><span class="sc0">a</span><span class="sc13">)</span><span class="sc24"> </span><span class="sc4">then</span><span class="sc24"> </span><span class="sc0">a</span><span class="sc12">:</span><span class="sc5">expand</span><span class="sc13">(</span><span class="sc0">a</span><span class="sc13">)</span><span class="sc0">,</span><span class="sc24">
        </span><span class="sc4">if</span><span class="sc24"> </span><span class="sc4">not</span><span class="sc24"> </span><span class="sc5">mapatom</span><span class="sc13">(</span><span class="sc0">b</span><span class="sc13">)</span><span class="sc24"> </span><span class="sc4">then</span><span class="sc24"> </span><span class="sc0">b</span><span class="sc12">:</span><span class="sc5">expand</span><span class="sc13">(</span><span class="sc0">b</span><span class="sc13">)</span><span class="sc0">,</span><span class="sc24">
        </span><span class="sc4">if</span><span class="sc24"> </span><span class="sc5">inop</span><span class="sc13">(</span><span class="sc0">a</span><span class="sc13">)</span><span class="sc12">=</span><span class="sc2">"+"</span><span class="sc24"> </span><span class="sc4">then</span><span class="sc24"> </span><span class="sc4">return</span><span class="sc24"> </span><span class="sc13">(</span><span class="sc5">map</span><span class="sc13">(</span><span class="sc24"> </span><span class="sc4">lambda</span><span class="sc24"> </span><span class="sc13">(</span><span class="sc0">[u],</span><span class="sc24">  </span><span class="sc0">outprod</span><span class="sc13">(</span><span class="sc0">u</span><span class="sc24"> </span><span class="sc0">,</span><span class="sc24"> </span><span class="sc0">b</span><span class="sc13">))</span><span class="sc0">,</span><span class="sc24"> </span><span class="sc0">a</span><span class="sc13">))</span><span class="sc0">,</span><span class="sc24">
        </span><span class="sc4">if</span><span class="sc24"> </span><span class="sc5">inop</span><span class="sc13">(</span><span class="sc0">b</span><span class="sc13">)</span><span class="sc12">=</span><span class="sc2">"+"</span><span class="sc24"> </span><span class="sc4">then</span><span class="sc24"> </span><span class="sc4">return</span><span class="sc24"> </span><span class="sc13">(</span><span class="sc5">map</span><span class="sc13">(</span><span class="sc24"> </span><span class="sc4">lambda</span><span class="sc24"> </span><span class="sc13">(</span><span class="sc0">[u],</span><span class="sc24">  </span><span class="sc0">outprod</span><span class="sc13">(</span><span class="sc0">a</span><span class="sc24"> </span><span class="sc0">,</span><span class="sc24"> </span><span class="sc0">u</span><span class="sc13">))</span><span class="sc0">,</span><span class="sc24"> </span><span class="sc0">b</span><span class="sc13">))</span><span class="sc0">,</span><span class="sc24">    
        </span><span class="sc4">if</span><span class="sc24"> </span><span class="sc0">wedgesimp</span><span class="sc24"> </span><span class="sc4">then</span><span class="sc24"> </span><span class="sc13">(</span><span class="sc24">
            </span><span class="sc4">if</span><span class="sc24"> </span><span class="sc4">not</span><span class="sc24"> </span><span class="sc5">freeof</span><span class="sc13">(</span><span class="sc2">"."</span><span class="sc0">,</span><span class="sc24"> </span><span class="sc0">a</span><span class="sc13">)</span><span class="sc24"> </span><span class="sc4">then</span><span class="sc24">
                </span><span class="sc0">a</span><span class="sc12">:</span><span class="sc0">cliffsimp1</span><span class="sc13">(</span><span class="sc0">a</span><span class="sc13">)</span><span class="sc0">,</span><span class="sc24">
            </span><span class="sc4">if</span><span class="sc24"> </span><span class="sc4">not</span><span class="sc24"> </span><span class="sc5">freeof</span><span class="sc13">(</span><span class="sc2">"."</span><span class="sc0">,</span><span class="sc24"> </span><span class="sc0">b</span><span class="sc13">)</span><span class="sc24"> </span><span class="sc4">then</span><span class="sc24">
                </span><span class="sc0">b</span><span class="sc12">:</span><span class="sc0">cliffsimp1</span><span class="sc13">(</span><span class="sc0">b</span><span class="sc13">)</span><span class="sc24">
        </span><span class="sc13">)</span><span class="sc0">,</span><span class="sc24">
        </span><span class="sc0">lva</span><span class="sc12">:</span><span class="sc5">sublist</span><span class="sc13">(</span><span class="sc5">listofvars</span><span class="sc13">(</span><span class="sc0">a</span><span class="sc13">)</span><span class="sc0">,</span><span class="sc24"> </span><span class="sc4">lambda</span><span class="sc13">(</span><span class="sc0">[u],</span><span class="sc24"> </span><span class="sc4">not</span><span class="sc24"> </span><span class="sc5">freeof</span><span class="sc13">(</span><span class="sc0">asymbol,</span><span class="sc24"> </span><span class="sc0">u</span><span class="sc13">)))</span><span class="sc0">,</span><span class="sc24">
        </span><span class="sc0">lvb</span><span class="sc12">:</span><span class="sc5">sublist</span><span class="sc13">(</span><span class="sc5">listofvars</span><span class="sc13">(</span><span class="sc0">b</span><span class="sc13">)</span><span class="sc0">,</span><span class="sc24"> </span><span class="sc4">lambda</span><span class="sc13">(</span><span class="sc0">[u],</span><span class="sc24"> </span><span class="sc4">not</span><span class="sc24"> </span><span class="sc5">freeof</span><span class="sc13">(</span><span class="sc0">asymbol,</span><span class="sc24"> </span><span class="sc0">u</span><span class="sc13">)))</span><span class="sc0">,</span><span class="sc24">
        </span><span class="sc0">lvu</span><span class="sc12">:</span><span class="sc5">sublist</span><span class="sc24"> </span><span class="sc13">(</span><span class="sc0">lva,</span><span class="sc24">  </span><span class="sc4">lambda</span><span class="sc13">(</span><span class="sc0">[u],</span><span class="sc24">  </span><span class="sc5">member</span><span class="sc13">(</span><span class="sc0">u,</span><span class="sc24"> </span><span class="sc0">lvb</span><span class="sc13">))</span><span class="sc24"> </span><span class="sc13">)</span><span class="sc0">,</span><span class="sc24">
        </span><span class="sc0">z</span><span class="sc12">:</span><span class="sc24"> </span><span class="sc5">length</span><span class="sc13">(</span><span class="sc0">lvu</span><span class="sc13">)</span><span class="sc0">,</span><span class="sc24">
        </span><span class="sc4">if</span><span class="sc24"> </span><span class="sc0">z</span><span class="sc12">&gt;</span><span class="sc3">0</span><span class="sc24"> </span><span class="sc4">then</span><span class="sc24"> </span><span class="sc3">0</span><span class="sc24"> </span><span class="sc4">else</span><span class="sc13">(</span><span class="sc24">
            </span><span class="sc0">ret</span><span class="sc12">:</span><span class="sc0">cliffsimp1</span><span class="sc13">(</span><span class="sc0">a.b</span><span class="sc13">)</span><span class="sc0">,</span><span class="sc24">
            </span><span class="sc0">ss</span><span class="sc12">:</span><span class="sc5">scalarpart</span><span class="sc13">(</span><span class="sc0">ret</span><span class="sc13">)</span><span class="sc0">,</span><span class="sc24">
            </span><span class="sc0">ret</span><span class="sc12">-</span><span class="sc0">ss</span><span class="sc24">
        </span><span class="sc13">)</span><span class="sc24">
    </span><span class="sc13">)</span><span class="sc0">;</span><span class="sc24">
    
    </span><span class="sc0">scprod</span><span class="sc13">(</span><span class="sc0">xx,</span><span class="sc24"> </span><span class="sc0">yy</span><span class="sc13">)</span><span class="sc12">:=</span><span class="sc4">block</span><span class="sc24"> </span><span class="sc13">(</span><span class="sc0">[ret],</span><span class="sc24">
        </span><span class="sc0">ret</span><span class="sc12">:</span><span class="sc24"> </span><span class="sc5">dotsimpc</span><span class="sc13">(</span><span class="sc5">expand</span><span class="sc13">(</span><span class="sc0">xx.yy</span><span class="sc13">))</span><span class="sc0">,</span><span class="sc24">
        </span><span class="sc5">scalarpart</span><span class="sc13">(</span><span class="sc0">ret</span><span class="sc13">)</span><span class="sc24">
    </span><span class="sc13">)</span><span class="sc0">;</span><span class="sc24">
    
    </span><span class="sc1">/*dualcoeff(a):=dual(dotsimpc(a.a.a.dual(a)));*/</span><span class="sc24">
    </span><span class="sc0">dualcoeff</span><span class="sc13">(</span><span class="sc0">a</span><span class="sc13">)</span><span class="sc12">:=</span><span class="sc5">coeff</span><span class="sc13">(</span><span class="sc5">dotsimpc</span><span class="sc13">(</span><span class="sc0">a.a.a.dual</span><span class="sc13">(</span><span class="sc0">a</span><span class="sc13">))</span><span class="sc0">,</span><span class="sc24"> </span><span class="sc8">%iv</span><span class="sc13">)</span><span class="sc0">;</span><span class="sc24">
    
    </span><span class="sc1">/*infix ("lc", 135, 134);   */</span><span class="sc24">
    </span><span class="sc5">lcprod</span><span class="sc13">(</span><span class="sc0">a,</span><span class="sc24"> </span><span class="sc0">b</span><span class="sc13">)</span><span class="sc12">:=</span><span class="sc24">  </span><span class="sc4">block</span><span class="sc13">(</span><span class="sc0">[bi,</span><span class="sc24"> </span><span class="sc0">ss,</span><span class="sc24"> </span><span class="sc0">ret</span><span class="sc24"> </span><span class="sc0">],</span><span class="sc24">   
        </span><span class="sc0">bi</span><span class="sc12">:</span><span class="sc0">dual</span><span class="sc13">(</span><span class="sc0">b</span><span class="sc13">)</span><span class="sc0">,</span><span class="sc24">         
        </span><span class="sc0">ret</span><span class="sc12">:</span><span class="sc0">outprod</span><span class="sc13">(</span><span class="sc0">a,</span><span class="sc24"> </span><span class="sc0">bi</span><span class="sc13">)</span><span class="sc0">,</span><span class="sc24">
        </span><span class="sc0">ss</span><span class="sc12">:</span><span class="sc0">dualcoeff</span><span class="sc13">(</span><span class="sc0">a</span><span class="sc13">)</span><span class="sc0">,</span><span class="sc24">
        </span><span class="sc0">ss</span><span class="sc12">*</span><span class="sc0">dual</span><span class="sc13">(</span><span class="sc0">ret</span><span class="sc13">)</span><span class="sc24">
    </span><span class="sc13">)</span><span class="sc0">;</span><span class="sc24">
    
    </span><span class="sc0">rcprod</span><span class="sc13">(</span><span class="sc0">a,</span><span class="sc24"> </span><span class="sc0">b</span><span class="sc13">)</span><span class="sc12">:=</span><span class="sc24"> </span><span class="sc4">block</span><span class="sc13">(</span><span class="sc0">[ai,</span><span class="sc24"> </span><span class="sc0">ss,</span><span class="sc24"> </span><span class="sc0">ret</span><span class="sc24"> </span><span class="sc0">],</span><span class="sc24">        
        </span><span class="sc0">ai</span><span class="sc12">:</span><span class="sc0">dual</span><span class="sc13">(</span><span class="sc0">a</span><span class="sc13">)</span><span class="sc0">,</span><span class="sc24">         
        </span><span class="sc0">ret</span><span class="sc12">:</span><span class="sc0">outprod</span><span class="sc13">(</span><span class="sc0">ai,</span><span class="sc24"> </span><span class="sc0">b</span><span class="sc13">)</span><span class="sc0">,</span><span class="sc24">
        </span><span class="sc0">ss</span><span class="sc12">:</span><span class="sc0">dualcoeff</span><span class="sc13">(</span><span class="sc0">b</span><span class="sc13">)</span><span class="sc0">,</span><span class="sc24">
        </span><span class="sc0">ss</span><span class="sc12">*</span><span class="sc0">dual</span><span class="sc13">(</span><span class="sc0">ret</span><span class="sc13">)</span><span class="sc24">
    </span><span class="sc13">)</span><span class="sc0">;</span><span class="sc24">
    
    </span><span class="sc0">dotproduct</span><span class="sc13">(</span><span class="sc0">a,b</span><span class="sc13">)</span><span class="sc12">:=</span><span class="sc4">block</span><span class="sc13">(</span><span class="sc0">[</span><span class="sc24"> </span><span class="sc0">ret,</span><span class="sc24"> </span><span class="sc0">u,</span><span class="sc24"> </span><span class="sc0">ss,</span><span class="sc24"> </span><span class="sc0">ai,</span><span class="sc24"> </span><span class="sc0">bi],</span><span class="sc24">   
        </span><span class="sc0">ret</span><span class="sc12">:</span><span class="sc5">lcprod</span><span class="sc13">(</span><span class="sc0">a,</span><span class="sc24"> </span><span class="sc0">b</span><span class="sc13">)</span><span class="sc24"> </span><span class="sc12">+</span><span class="sc24"> </span><span class="sc0">rcprod</span><span class="sc13">(</span><span class="sc0">a,</span><span class="sc24"> </span><span class="sc0">b</span><span class="sc13">)</span><span class="sc0">,</span><span class="sc24">
        </span><span class="sc0">u</span><span class="sc12">:</span><span class="sc0">scprod</span><span class="sc13">(</span><span class="sc0">a,</span><span class="sc24"> </span><span class="sc0">b</span><span class="sc13">)</span><span class="sc0">,</span><span class="sc24">
        </span><span class="sc0">ret</span><span class="sc24"> </span><span class="sc12">-</span><span class="sc0">u</span><span class="sc24">
    </span><span class="sc13">)</span><span class="sc0">;</span><span class="sc24">
    
    </span><span class="sc0">regproduct</span><span class="sc13">(</span><span class="sc0">a,</span><span class="sc24"> </span><span class="sc0">b</span><span class="sc13">)</span><span class="sc12">:=</span><span class="sc4">block</span><span class="sc13">(</span><span class="sc0">[ai,</span><span class="sc24"> </span><span class="sc0">bi,</span><span class="sc24"> </span><span class="sc0">ss],</span><span class="sc24">
        </span><span class="sc0">ai</span><span class="sc12">:</span><span class="sc13">(</span><span class="sc0">dual</span><span class="sc13">(</span><span class="sc0">a</span><span class="sc13">))</span><span class="sc0">,</span><span class="sc24">
        </span><span class="sc0">bi</span><span class="sc12">:</span><span class="sc13">(</span><span class="sc0">dual</span><span class="sc13">(</span><span class="sc0">b</span><span class="sc13">))</span><span class="sc0">,</span><span class="sc24">
        </span><span class="sc0">ss</span><span class="sc12">:</span><span class="sc0">dualcoeff</span><span class="sc13">(</span><span class="sc0">a</span><span class="sc13">)</span><span class="sc12">*</span><span class="sc0">dualcoeff</span><span class="sc13">(</span><span class="sc0">b</span><span class="sc13">)</span><span class="sc12">*</span><span class="sc8">%ivnorm,</span><span class="sc24">
        </span><span class="sc0">ss</span><span class="sc12">*</span><span class="sc0">dual</span><span class="sc13">(</span><span class="sc0">ai</span><span class="sc24"> </span><span class="sc12">&amp;</span><span class="sc24"> </span><span class="sc0">bi</span><span class="sc13">)</span><span class="sc24"> 
    </span><span class="sc13">)</span><span class="sc0">;</span><span class="sc24">
    
    </span><span class="sc0">regproduct2</span><span class="sc13">(</span><span class="sc0">a,</span><span class="sc24"> </span><span class="sc0">b</span><span class="sc13">)</span><span class="sc12">:=</span><span class="sc4">block</span><span class="sc13">(</span><span class="sc0">[ai,</span><span class="sc24"> </span><span class="sc0">bi,</span><span class="sc24"> </span><span class="sc0">ss],</span><span class="sc24">
        </span><span class="sc0">ai</span><span class="sc12">:</span><span class="sc13">(</span><span class="sc0">dual</span><span class="sc13">(</span><span class="sc0">a</span><span class="sc13">))</span><span class="sc0">,</span><span class="sc24">
        </span><span class="sc0">bi</span><span class="sc12">:</span><span class="sc13">(</span><span class="sc0">dual</span><span class="sc13">(</span><span class="sc0">b</span><span class="sc13">))</span><span class="sc0">,</span><span class="sc24">
        </span><span class="sc0">ss</span><span class="sc12">:</span><span class="sc0">dualcoeff</span><span class="sc13">(</span><span class="sc0">a</span><span class="sc13">)</span><span class="sc12">*</span><span class="sc0">dualcoeff</span><span class="sc13">(</span><span class="sc0">b</span><span class="sc13">)</span><span class="sc12">*</span><span class="sc8">%ivnorm,</span><span class="sc24">
        </span><span class="sc0">ss</span><span class="sc12">*</span><span class="sc5">dotsimpc</span><span class="sc24"> </span><span class="sc13">(</span><span class="sc24"> </span><span class="sc0">ai</span><span class="sc24"> </span><span class="sc12">&amp;</span><span class="sc24"> </span><span class="sc0">bi</span><span class="sc24"> </span><span class="sc13">)</span><span class="sc24">
    </span><span class="sc13">)</span><span class="sc0">;</span><span class="sc24">

</span><span class="sc1">/*
 This part implements a generic partition split operation 
*/</span><span class="sc24">
</span><span class="sc5">inop</span><span class="sc13">(</span><span class="sc5">expr</span><span class="sc13">)</span><span class="sc12">:=</span><span class="sc24"> </span><span class="sc4">if</span><span class="sc24"> </span><span class="sc4">not</span><span class="sc24"> </span><span class="sc5">mapatom</span><span class="sc24"> </span><span class="sc13">(</span><span class="sc5">expr</span><span class="sc13">)</span><span class="sc24">  </span><span class="sc4">then</span><span class="sc24"> </span><span class="sc5">inpart</span><span class="sc13">(</span><span class="sc5">expr,</span><span class="sc24"> </span><span class="sc3">0</span><span class="sc13">)</span><span class="sc24"> </span><span class="sc4">else</span><span class="sc24"> </span><span class="sc12">'</span><span class="sc8">nil;</span><span class="sc24">

</span><span class="sc5">inargs</span><span class="sc13">(</span><span class="sc5">expr</span><span class="sc13">)</span><span class="sc12">:=</span><span class="sc24"> </span><span class="sc4">if</span><span class="sc24"> </span><span class="sc4">not</span><span class="sc24"> </span><span class="sc5">mapatom</span><span class="sc24"> </span><span class="sc13">(</span><span class="sc5">expr</span><span class="sc13">)</span><span class="sc24">  </span><span class="sc4">then</span><span class="sc24">  </span><span class="sc5">substinpart</span><span class="sc13">(</span><span class="sc24"> </span><span class="sc2">"["</span><span class="sc0">,</span><span class="sc24"> </span><span class="sc5">expr,</span><span class="sc24"> </span><span class="sc3">0</span><span class="sc13">)</span><span class="sc24"> </span><span class="sc4">else</span><span class="sc24"> </span><span class="sc12">'</span><span class="sc8">nil;</span><span class="sc24">

</span><span class="sc1">/*
partition by predicate with expression reconstruction
literal meaning
*/</span><span class="sc24">
</span><span class="sc5">oppart</span><span class="sc13">(</span><span class="sc5">expr,</span><span class="sc24"> </span><span class="sc5">predf</span><span class="sc13">)</span><span class="sc12">:=</span><span class="sc4">block</span><span class="sc13">(</span><span class="sc24">
    </span><span class="sc0">[sop,</span><span class="sc24"> </span><span class="sc0">lst,</span><span class="sc24"> </span><span class="sc0">lsttrue</span><span class="sc12">:</span><span class="sc0">[],</span><span class="sc24"> </span><span class="sc0">lstfalse</span><span class="sc12">:</span><span class="sc0">[],</span><span class="sc24"> </span><span class="sc0">ltrue,</span><span class="sc24"> </span><span class="sc0">lfalse,</span><span class="sc24"> </span><span class="sc0">err</span><span class="sc24"> </span><span class="sc0">],</span><span class="sc24">
    </span><span class="sc4">mode_declare</span><span class="sc13">(</span><span class="sc0">[lsttrue,</span><span class="sc24"> </span><span class="sc0">lstfalse,</span><span class="sc24"> </span><span class="sc0">lst,</span><span class="sc24"> </span><span class="sc0">err],</span><span class="sc24"> </span><span class="sc0">list</span><span class="sc13">)</span><span class="sc0">,</span><span class="sc24">
    </span><span class="sc4">if</span><span class="sc24"> </span><span class="sc5">mapatom</span><span class="sc13">(</span><span class="sc5">expr</span><span class="sc13">)</span><span class="sc24"> </span><span class="sc4">then</span><span class="sc24"> </span><span class="sc13">(</span><span class="sc24">
        </span><span class="sc4">if</span><span class="sc24"> </span><span class="sc5">apply</span><span class="sc13">(</span><span class="sc5">predf,</span><span class="sc24"> </span><span class="sc0">[expr]</span><span class="sc13">)</span><span class="sc24"> </span><span class="sc4">then</span><span class="sc24"> </span><span class="sc13">(</span><span class="sc0">ltrue</span><span class="sc12">:</span><span class="sc5">expr,</span><span class="sc24"> </span><span class="sc0">lfalse</span><span class="sc12">:'</span><span class="sc8">nil</span><span class="sc13">)</span><span class="sc24">
        </span><span class="sc4">else</span><span class="sc24"> </span><span class="sc13">(</span><span class="sc0">lfalse</span><span class="sc12">:</span><span class="sc5">expr,</span><span class="sc24"> </span><span class="sc0">ltrue</span><span class="sc12">:'</span><span class="sc8">nil</span><span class="sc13">)</span><span class="sc0">,</span><span class="sc24">
        </span><span class="sc4">return</span><span class="sc13">(</span><span class="sc24"> </span><span class="sc0">[ltrue,</span><span class="sc24"> </span><span class="sc0">lfalse]</span><span class="sc13">)</span><span class="sc24">
    </span><span class="sc13">)</span><span class="sc24"> </span><span class="sc4">else</span><span class="sc24"> </span><span class="sc13">(</span><span class="sc24">
        </span><span class="sc0">sop</span><span class="sc12">:</span><span class="sc5">inop</span><span class="sc13">(</span><span class="sc5">expr</span><span class="sc13">)</span><span class="sc0">,</span><span class="sc24">
        </span><span class="sc5">expr</span><span class="sc12">:</span><span class="sc5">rest</span><span class="sc13">(</span><span class="sc5">expr,</span><span class="sc24"> </span><span class="sc3">0</span><span class="sc13">)</span><span class="sc0">,</span><span class="sc24">
        </span><span class="sc0">lst</span><span class="sc12">:</span><span class="sc24"> </span><span class="sc5">inargs</span><span class="sc13">(</span><span class="sc5">expr</span><span class="sc13">)</span><span class="sc0">,</span><span class="sc24">
        </span><span class="sc4">if</span><span class="sc24"> </span><span class="sc0">_debug</span><span class="sc12">=</span><span class="sc8">true</span><span class="sc24"> </span><span class="sc4">then</span><span class="sc24"> </span><span class="sc5">display</span><span class="sc13">(</span><span class="sc24"> </span><span class="sc0">sop,</span><span class="sc24"> </span><span class="sc0">lst</span><span class="sc13">)</span><span class="sc0">,</span><span class="sc24"> 
        </span><span class="sc4">for</span><span class="sc24"> </span><span class="sc0">v</span><span class="sc24"> </span><span class="sc4">in</span><span class="sc24"> </span><span class="sc0">lst</span><span class="sc24"> </span><span class="sc4">do</span><span class="sc24"> </span><span class="sc13">(</span><span class="sc24">
            </span><span class="sc4">if</span><span class="sc24"> </span><span class="sc5">apply</span><span class="sc13">(</span><span class="sc5">predf,</span><span class="sc24"> </span><span class="sc0">[v]</span><span class="sc13">)</span><span class="sc24"> </span><span class="sc4">then</span><span class="sc24"> </span><span class="sc5">push</span><span class="sc13">(</span><span class="sc0">v,</span><span class="sc24"> </span><span class="sc0">lsttrue</span><span class="sc13">)</span><span class="sc24"> 
            </span><span class="sc4">else</span><span class="sc24"> </span><span class="sc5">push</span><span class="sc13">(</span><span class="sc0">v,</span><span class="sc24"> </span><span class="sc0">lstfalse</span><span class="sc13">)</span><span class="sc24">
        </span><span class="sc13">)</span><span class="sc0">,</span><span class="sc24">
        </span><span class="sc0">lsttrue</span><span class="sc12">:</span><span class="sc5">reverse</span><span class="sc13">(</span><span class="sc0">lsttrue</span><span class="sc13">)</span><span class="sc0">,</span><span class="sc24">
        </span><span class="sc0">lstfalse</span><span class="sc12">:</span><span class="sc5">reverse</span><span class="sc13">(</span><span class="sc0">lstfalse</span><span class="sc13">)</span><span class="sc0">,</span><span class="sc24">
        </span><span class="sc4">if</span><span class="sc24"> </span><span class="sc0">_debug</span><span class="sc12">=</span><span class="sc8">true</span><span class="sc24"> </span><span class="sc4">then</span><span class="sc24"> </span><span class="sc5">display</span><span class="sc13">(</span><span class="sc0">lsttrue,</span><span class="sc24"> </span><span class="sc0">lstfalse</span><span class="sc13">)</span><span class="sc0">,</span><span class="sc24">  
        </span><span class="sc0">err</span><span class="sc12">:</span><span class="sc4">errcatch</span><span class="sc24"> </span><span class="sc13">(</span><span class="sc24">
            </span><span class="sc0">ltrue</span><span class="sc12">:</span><span class="sc4">if</span><span class="sc24"> </span><span class="sc4">not</span><span class="sc24"> </span><span class="sc5">emptyp</span><span class="sc13">(</span><span class="sc0">lsttrue</span><span class="sc13">)</span><span class="sc24"> </span><span class="sc4">then</span><span class="sc24"> 
                </span><span class="sc1">/*substinpart(sop, lsttrue, 0) */</span><span class="sc24">
                </span><span class="sc0">implodeop</span><span class="sc13">(</span><span class="sc0">lsttrue,</span><span class="sc24"> </span><span class="sc0">sop</span><span class="sc13">)</span><span class="sc24">
                </span><span class="sc4">else</span><span class="sc24"> </span><span class="sc12">'</span><span class="sc8">nil,</span><span class="sc24">
            </span><span class="sc0">lfalse</span><span class="sc12">:</span><span class="sc4">if</span><span class="sc24"> </span><span class="sc4">not</span><span class="sc24"> </span><span class="sc5">emptyp</span><span class="sc13">(</span><span class="sc0">lstfalse</span><span class="sc13">)</span><span class="sc24"> </span><span class="sc4">then</span><span class="sc24"> 
                </span><span class="sc1">/*substinpart(sop, lstfalse, 0) */</span><span class="sc24">
                </span><span class="sc0">implodeop</span><span class="sc13">(</span><span class="sc0">lstfalse,</span><span class="sc24"> </span><span class="sc0">sop</span><span class="sc13">)</span><span class="sc24">
                </span><span class="sc4">else</span><span class="sc24"> </span><span class="sc12">'</span><span class="sc8">nil,</span><span class="sc24">
            </span><span class="sc4">if</span><span class="sc24"> </span><span class="sc0">_debug</span><span class="sc12">=</span><span class="sc8">true</span><span class="sc24"> </span><span class="sc4">then</span><span class="sc24"> </span><span class="sc5">display</span><span class="sc13">(</span><span class="sc24"> </span><span class="sc0">ltrue,</span><span class="sc24"> </span><span class="sc0">lfalse</span><span class="sc13">)</span><span class="sc0">,</span><span class="sc24"> 
            </span><span class="sc0">lst</span><span class="sc12">:</span><span class="sc0">[</span><span class="sc24"> </span><span class="sc0">ltrue,</span><span class="sc24"> </span><span class="sc0">lfalse]</span><span class="sc24">
        </span><span class="sc13">)</span><span class="sc0">,</span><span class="sc24">
        </span><span class="sc4">if</span><span class="sc24"> </span><span class="sc0">_debug</span><span class="sc12">=</span><span class="sc8">true</span><span class="sc24"> </span><span class="sc4">then</span><span class="sc24"> </span><span class="sc5">display</span><span class="sc13">(</span><span class="sc0">err</span><span class="sc13">)</span><span class="sc0">,</span><span class="sc24">  
        </span><span class="sc4">if</span><span class="sc24"> </span><span class="sc5">emptyp</span><span class="sc13">(</span><span class="sc0">err</span><span class="sc13">)</span><span class="sc24"> </span><span class="sc4">then</span><span class="sc24"> </span><span class="sc0">lst</span><span class="sc12">:</span><span class="sc0">[</span><span class="sc12">'</span><span class="sc8">nil,</span><span class="sc24"> </span><span class="sc12">'</span><span class="sc8">nil</span><span class="sc24"> </span><span class="sc0">]</span><span class="sc24">
    </span><span class="sc13">)</span><span class="sc0">,</span><span class="sc24">
    </span><span class="sc0">lst</span><span class="sc24">
</span><span class="sc13">)</span><span class="sc0">;</span><span class="sc24">

</span><span class="sc1">/* 
splits an expression by occurencess of an operator
*/</span><span class="sc24">
</span><span class="sc5">explodeop</span><span class="sc13">(</span><span class="sc5">expr,</span><span class="sc24"> </span><span class="sc0">sop</span><span class="sc13">)</span><span class="sc12">:=</span><span class="sc4">block</span><span class="sc13">(</span><span class="sc0">[lst,</span><span class="sc24"> </span><span class="sc0">w],</span><span class="sc24">
    </span><span class="sc4">if</span><span class="sc24"> </span><span class="sc5">mapatom</span><span class="sc13">(</span><span class="sc5">expr</span><span class="sc13">)</span><span class="sc24"> </span><span class="sc4">then</span><span class="sc24"> </span><span class="sc4">return</span><span class="sc24"> </span><span class="sc13">(</span><span class="sc0">[expr]</span><span class="sc13">)</span><span class="sc0">,</span><span class="sc24"> 
    </span><span class="sc0">lst</span><span class="sc12">:</span><span class="sc24"> </span><span class="sc5">inargs</span><span class="sc13">(</span><span class="sc5">expr</span><span class="sc13">)</span><span class="sc0">,</span><span class="sc24">
    </span><span class="sc5">lreduce</span><span class="sc13">(</span><span class="sc5">append,</span><span class="sc24"> </span><span class="sc5">map</span><span class="sc13">(</span><span class="sc4">lambda</span><span class="sc13">(</span><span class="sc0">[w],</span><span class="sc24">   </span><span class="sc5">explodeop</span><span class="sc13">(</span><span class="sc0">w,</span><span class="sc24"> </span><span class="sc0">sop</span><span class="sc13">))</span><span class="sc0">,</span><span class="sc24"> </span><span class="sc0">lst</span><span class="sc13">))</span><span class="sc24">
</span><span class="sc13">)</span><span class="sc0">;</span><span class="sc24">

</span><span class="sc1">/*
combinees a list by operator
*/</span><span class="sc24">
</span><span class="sc0">implodeop</span><span class="sc13">(</span><span class="sc0">lsta,</span><span class="sc24"> </span><span class="sc0">sop</span><span class="sc13">)</span><span class="sc12">:=</span><span class="sc4">block</span><span class="sc13">(</span><span class="sc0">[w],</span><span class="sc24">
    </span><span class="sc4">if</span><span class="sc24"> </span><span class="sc4">not</span><span class="sc24"> </span><span class="sc5">listp</span><span class="sc13">(</span><span class="sc0">lsta</span><span class="sc13">)</span><span class="sc24"> </span><span class="sc4">then</span><span class="sc24"> </span><span class="sc4">return</span><span class="sc24"> </span><span class="sc13">(</span><span class="sc0">lsta</span><span class="sc13">)</span><span class="sc0">,</span><span class="sc24">
    </span><span class="sc5">xreduce</span><span class="sc13">(</span><span class="sc0">sop,</span><span class="sc24"> </span><span class="sc5">maplist</span><span class="sc13">(</span><span class="sc4">lambda</span><span class="sc13">(</span><span class="sc0">[w],</span><span class="sc24"> </span><span class="sc0">implodeop</span><span class="sc13">(</span><span class="sc0">w,</span><span class="sc24"> </span><span class="sc0">sop</span><span class="sc13">))</span><span class="sc0">,</span><span class="sc24"> </span><span class="sc0">lsta</span><span class="sc13">))</span><span class="sc24">
</span><span class="sc13">)</span><span class="sc0">;</span><span class="sc24">

</span><span class="sc1">/*
expands recursivly the geometric product
*/</span><span class="sc24">
</span><span class="sc0">dotexpand</span><span class="sc13">(</span><span class="sc5">expr</span><span class="sc13">)</span><span class="sc12">:=</span><span class="sc4">block</span><span class="sc13">(</span><span class="sc0">[</span><span class="sc24"> </span><span class="sc0">sop],</span><span class="sc24">
    </span><span class="sc0">sop</span><span class="sc12">:</span><span class="sc5">inop</span><span class="sc13">(</span><span class="sc5">expr</span><span class="sc13">)</span><span class="sc0">,</span><span class="sc24">
    </span><span class="sc4">if</span><span class="sc24"> </span><span class="sc0">sop</span><span class="sc12">#</span><span class="sc2">"."</span><span class="sc24"> </span><span class="sc4">then</span><span class="sc24"> 
        </span><span class="sc4">if</span><span class="sc24"> </span><span class="sc0">sop</span><span class="sc12">=</span><span class="sc2">"+"</span><span class="sc24"> </span><span class="sc4">then</span><span class="sc24"> </span><span class="sc4">return</span><span class="sc13">(</span><span class="sc5">map</span><span class="sc13">(</span><span class="sc0">dotexpand,</span><span class="sc24"> </span><span class="sc5">expr</span><span class="sc13">))</span><span class="sc24">
        </span><span class="sc4">else</span><span class="sc24"> </span><span class="sc4">return</span><span class="sc13">(</span><span class="sc5">expr</span><span class="sc13">)</span><span class="sc0">,</span><span class="sc24">
    </span><span class="sc5">first</span><span class="sc13">(</span><span class="sc5">expr</span><span class="sc13">)</span><span class="sc24"> </span><span class="sc12">|</span><span class="sc24"> </span><span class="sc0">dotexpand</span><span class="sc13">(</span><span class="sc5">rest</span><span class="sc13">(</span><span class="sc5">expr</span><span class="sc13">))</span><span class="sc24"> </span><span class="sc12">+</span><span class="sc24"> </span><span class="sc5">first</span><span class="sc13">(</span><span class="sc5">expr</span><span class="sc13">)</span><span class="sc24"> </span><span class="sc12">&amp;</span><span class="sc24"> </span><span class="sc0">dotexpand</span><span class="sc13">(</span><span class="sc5">rest</span><span class="sc13">(</span><span class="sc5">expr</span><span class="sc13">))</span><span class="sc24">
</span><span class="sc13">)</span><span class="sc0">;</span><span class="sc24">

</span><span class="sc1">/*
real predicate
*/</span><span class="sc24">
</span><span class="sc9">realp</span><span class="sc24"> </span><span class="sc13">(</span><span class="sc0">x</span><span class="sc13">)</span><span class="sc12">:=</span><span class="sc24"> </span><span class="sc5">featurep</span><span class="sc13">(</span><span class="sc0">x,</span><span class="sc24"> </span><span class="sc9">real</span><span class="sc13">)</span><span class="sc0">;</span><span class="sc24">

</span><span class="sc1">/*
returns scalar variables
*/</span><span class="sc24">
</span><span class="sc9">scalarsym</span><span class="sc13">()</span><span class="sc12">:=</span><span class="sc5">sublist</span><span class="sc13">(</span><span class="sc5">props,</span><span class="sc24"> </span><span class="sc4">lambda</span><span class="sc13">(</span><span class="sc24"> </span><span class="sc0">[z],</span><span class="sc24"> </span><span class="sc4">if</span><span class="sc24"> </span><span class="sc5">symbolp</span><span class="sc13">(</span><span class="sc0">z</span><span class="sc13">)</span><span class="sc24"> </span><span class="sc4">then</span><span class="sc24"> </span><span class="sc5">scalarp</span><span class="sc13">(</span><span class="sc0">z</span><span class="sc13">)</span><span class="sc24"> </span><span class="sc4">else</span><span class="sc24"> </span><span class="sc8">false</span><span class="sc13">))</span><span class="sc0">;</span><span class="sc24">

</span><span class="sc1">/*
returns cliffod variables
*/</span><span class="sc24">
</span><span class="sc0">clivars</span><span class="sc13">()</span><span class="sc12">:=</span><span class="sc24"> </span><span class="sc4">block</span><span class="sc13">(</span><span class="sc0">[</span><span class="sc24"> </span><span class="sc0">uu],</span><span class="sc24"> 
    </span><span class="sc5">sublist</span><span class="sc13">(</span><span class="sc7">values,</span><span class="sc24"> </span><span class="sc4">lambda</span><span class="sc13">(</span><span class="sc0">[z],</span><span class="sc24"> </span><span class="sc0">uu</span><span class="sc12">:</span><span class="sc4">ev</span><span class="sc13">(</span><span class="sc0">z</span><span class="sc13">)</span><span class="sc0">,</span><span class="sc24"> </span><span class="sc4">not</span><span class="sc24"> </span><span class="sc5">freeof</span><span class="sc13">(</span><span class="sc0">asymbol,</span><span class="sc24"> </span><span class="sc0">uu</span><span class="sc24"> </span><span class="sc13">)))</span><span class="sc24">
</span><span class="sc13">)</span><span class="sc0">;</span><span class="sc24">

</span><span class="sc1">/*
returns cliffod symbols
*/</span><span class="sc24">
</span><span class="sc0">clisym</span><span class="sc13">()</span><span class="sc12">:=</span><span class="sc5">sublist</span><span class="sc13">(</span><span class="sc5">props,</span><span class="sc24"> </span><span class="sc4">lambda</span><span class="sc13">(</span><span class="sc24"> </span><span class="sc0">[z],</span><span class="sc24"> </span><span class="sc4">if</span><span class="sc24"> </span><span class="sc5">symbolp</span><span class="sc13">(</span><span class="sc0">z</span><span class="sc13">)</span><span class="sc24"> </span><span class="sc4">then</span><span class="sc24"> </span><span class="sc4">not</span><span class="sc24"> </span><span class="sc5">freeof</span><span class="sc13">(</span><span class="sc0">asymbol,</span><span class="sc24"> </span><span class="sc0">z</span><span class="sc13">)</span><span class="sc24"> </span><span class="sc4">else</span><span class="sc24"> </span><span class="sc8">false</span><span class="sc13">))</span><span class="sc0">;</span><span class="sc24">

</span><span class="sc1">/*
simplification of dot-products, ordergreat
*/</span><span class="sc24">
</span><span class="sc5">dotsimp1</span><span class="sc13">(</span><span class="sc0">ab</span><span class="sc13">)</span><span class="sc12">:=</span><span class="sc4">block</span><span class="sc13">(</span><span class="sc0">[a,</span><span class="sc24"> </span><span class="sc0">b],</span><span class="sc24">
  </span><span class="sc4">if</span><span class="sc24"> </span><span class="sc5">mapatom</span><span class="sc13">(</span><span class="sc0">ab</span><span class="sc13">)</span><span class="sc24"> </span><span class="sc4">or</span><span class="sc24"> </span><span class="sc5">op</span><span class="sc13">(</span><span class="sc0">ab</span><span class="sc13">)</span><span class="sc12">#</span><span class="sc2">"."</span><span class="sc24"> </span><span class="sc4">then</span><span class="sc24"> </span><span class="sc4">return</span><span class="sc13">(</span><span class="sc0">ab</span><span class="sc13">)</span><span class="sc0">,</span><span class="sc24">
  </span><span class="sc0">a</span><span class="sc12">:</span><span class="sc5">inpart</span><span class="sc13">(</span><span class="sc0">ab,1</span><span class="sc13">)</span><span class="sc0">,</span><span class="sc24">
  </span><span class="sc0">b</span><span class="sc12">:</span><span class="sc5">rest</span><span class="sc13">(</span><span class="sc0">ab</span><span class="sc13">)</span><span class="sc0">,</span><span class="sc24">
 </span><span class="sc4">if</span><span class="sc24"> </span><span class="sc5">orderlessp</span><span class="sc13">(</span><span class="sc0">a,b</span><span class="sc13">)</span><span class="sc24"> </span><span class="sc4">then</span><span class="sc24"> </span><span class="sc12">-</span><span class="sc0">b.a</span><span class="sc24"> </span><span class="sc4">else</span><span class="sc24"> </span><span class="sc0">ab</span><span class="sc24">
</span><span class="sc13">)</span><span class="sc0">;</span><span class="sc24">

</span><span class="sc1">/*
simplification of dot-products, orderless
*/</span><span class="sc24">
</span><span class="sc5">dotsimp2</span><span class="sc13">(</span><span class="sc0">ab</span><span class="sc13">)</span><span class="sc12">:=</span><span class="sc4">block</span><span class="sc13">(</span><span class="sc0">[a,</span><span class="sc24"> </span><span class="sc0">b],</span><span class="sc24">
  </span><span class="sc4">if</span><span class="sc24"> </span><span class="sc5">mapatom</span><span class="sc13">(</span><span class="sc0">ab</span><span class="sc13">)</span><span class="sc24"> </span><span class="sc4">or</span><span class="sc24"> </span><span class="sc5">op</span><span class="sc13">(</span><span class="sc0">ab</span><span class="sc13">)</span><span class="sc12">#</span><span class="sc2">"."</span><span class="sc24"> </span><span class="sc4">then</span><span class="sc24"> </span><span class="sc4">return</span><span class="sc13">(</span><span class="sc0">ab</span><span class="sc13">)</span><span class="sc0">,</span><span class="sc24">
  </span><span class="sc0">a</span><span class="sc12">:</span><span class="sc5">inpart</span><span class="sc13">(</span><span class="sc0">ab,1</span><span class="sc13">)</span><span class="sc0">,</span><span class="sc24">
  </span><span class="sc0">b</span><span class="sc12">:</span><span class="sc5">rest</span><span class="sc13">(</span><span class="sc0">ab</span><span class="sc13">)</span><span class="sc0">,</span><span class="sc24">
  </span><span class="sc4">if</span><span class="sc24"> </span><span class="sc5">ordergreatp</span><span class="sc13">(</span><span class="sc0">a,b</span><span class="sc13">)</span><span class="sc24"> </span><span class="sc4">then</span><span class="sc24"> </span><span class="sc12">-</span><span class="sc0">b.a</span><span class="sc24"> </span><span class="sc4">else</span><span class="sc24"> </span><span class="sc0">ab</span><span class="sc24">
</span><span class="sc13">)</span><span class="sc0">;</span><span class="sc24">

</span><span class="sc1">/*
toggles debugging
*/</span><span class="sc24">
</span><span class="sc0">toggle_debug</span><span class="sc13">()</span><span class="sc12">:=</span><span class="sc24"> </span><span class="sc0">_debug</span><span class="sc12">:</span><span class="sc24"> </span><span class="sc4">not</span><span class="sc24"> </span><span class="sc0">_debug;</span><span class="sc24">

</span><span class="sc0">clv</span><span class="sc13">(</span><span class="sc5">expr</span><span class="sc13">)</span><span class="sc12">:=</span><span class="sc13">(</span><span class="sc24">
    </span><span class="sc5">sublist</span><span class="sc13">(</span><span class="sc5">listofvars</span><span class="sc13">(</span><span class="sc5">expr</span><span class="sc13">)</span><span class="sc0">,</span><span class="sc24"> </span><span class="sc4">lambda</span><span class="sc13">(</span><span class="sc0">[u],</span><span class="sc24"> </span><span class="sc4">not</span><span class="sc24"> </span><span class="sc5">freeof</span><span class="sc13">(</span><span class="sc0">asymbol,</span><span class="sc24"> </span><span class="sc0">u</span><span class="sc13">)))</span><span class="sc24">
</span><span class="sc13">)</span><span class="sc0">;</span><span class="sc24">

</span><span class="sc1">/*
simplification of dot-products
*/</span><span class="sc24">
</span><span class="sc4">declare</span><span class="sc24"> </span><span class="sc13">(</span><span class="sc5">dotsimpc,</span><span class="sc24"> </span><span class="sc7">evfun</span><span class="sc13">)</span><span class="sc0">;</span><span class="sc24">
 
</span><span class="sc5">dotsimpc</span><span class="sc13">(</span><span class="sc0">ab</span><span class="sc13">)</span><span class="sc12">:=</span><span class="sc4">block</span><span class="sc13">(</span><span class="sc0">[ba,</span><span class="sc24"> </span><span class="sc0">c</span><span class="sc12">:</span><span class="sc0">1,</span><span class="sc24"> </span><span class="sc0">v,</span><span class="sc24"> </span><span class="sc0">w</span><span class="sc12">:</span><span class="sc0">1,</span><span class="sc24"> </span><span class="sc0">q,</span><span class="sc24"> </span><span class="sc0">r,</span><span class="sc24"> </span><span class="sc0">l,</span><span class="sc24"> </span><span class="sc0">sop],</span><span class="sc24">
  </span><span class="sc4">mode_declare</span><span class="sc13">(</span><span class="sc0">w,</span><span class="sc24"> </span><span class="sc5">fixnum</span><span class="sc13">)</span><span class="sc0">,</span><span class="sc24">
  </span><span class="sc4">mode_declare</span><span class="sc13">(</span><span class="sc0">[r,l],</span><span class="sc24"> </span><span class="sc9">any</span><span class="sc13">)</span><span class="sc0">,</span><span class="sc24">
  </span><span class="sc0">sop</span><span class="sc12">:</span><span class="sc5">inop</span><span class="sc13">(</span><span class="sc0">ab</span><span class="sc13">)</span><span class="sc0">,</span><span class="sc24">
   </span><span class="sc4">if</span><span class="sc24"> </span><span class="sc5">mapatom</span><span class="sc13">(</span><span class="sc0">ab</span><span class="sc13">)</span><span class="sc24"> </span><span class="sc4">or</span><span class="sc24"> </span><span class="sc5">freeof</span><span class="sc13">(</span><span class="sc2">"."</span><span class="sc0">,</span><span class="sc24"> </span><span class="sc0">ab</span><span class="sc13">)</span><span class="sc24"> </span><span class="sc4">or</span><span class="sc24"> </span><span class="sc0">sop</span><span class="sc12">='</span><span class="sc8">nil</span><span class="sc24"> </span><span class="sc4">or</span><span class="sc24"> </span><span class="sc0">sop</span><span class="sc12">=</span><span class="sc2">"^"</span><span class="sc24">  </span><span class="sc4">or</span><span class="sc24"> </span><span class="sc0">sop</span><span class="sc12">=</span><span class="sc2">"^^"</span><span class="sc24"> </span><span class="sc4">then</span><span class="sc24"> </span><span class="sc4">return</span><span class="sc13">(</span><span class="sc0">ab</span><span class="sc13">)</span><span class="sc0">,</span><span class="sc24">
  </span><span class="sc4">if</span><span class="sc24"> </span><span class="sc0">sop</span><span class="sc12">=</span><span class="sc2">"+"</span><span class="sc24"> </span><span class="sc4">then</span><span class="sc24"> 
    </span><span class="sc5">map</span><span class="sc13">(</span><span class="sc5">dotsimpc,</span><span class="sc24"> </span><span class="sc0">ab</span><span class="sc13">)</span><span class="sc24">
  </span><span class="sc4">else</span><span class="sc24"> </span><span class="sc4">if</span><span class="sc24"> </span><span class="sc0">sop</span><span class="sc12">=</span><span class="sc2">"*"</span><span class="sc24"> </span><span class="sc4">then</span><span class="sc24"> </span><span class="sc13">(</span><span class="sc24">
    </span><span class="sc0">[r,l]</span><span class="sc12">:</span><span class="sc24"> </span><span class="sc5">oppart</span><span class="sc13">(</span><span class="sc0">ab,</span><span class="sc24"> </span><span class="sc4">lambda</span><span class="sc13">(</span><span class="sc0">[u],</span><span class="sc24"> </span><span class="sc5">freeof</span><span class="sc13">(</span><span class="sc2">"."</span><span class="sc0">,</span><span class="sc24"> </span><span class="sc0">u</span><span class="sc13">)))</span><span class="sc0">,</span><span class="sc24">
     </span><span class="sc4">if</span><span class="sc24"> </span><span class="sc0">_debug</span><span class="sc12">=</span><span class="sc8">true</span><span class="sc24"> </span><span class="sc4">then</span><span class="sc24"> </span><span class="sc5">display</span><span class="sc13">(</span><span class="sc0">sop,</span><span class="sc24"> </span><span class="sc0">r,</span><span class="sc24"> </span><span class="sc0">l</span><span class="sc13">)</span><span class="sc0">,</span><span class="sc24">
     </span><span class="sc0">r</span><span class="sc12">:</span><span class="sc5">subst</span><span class="sc13">(</span><span class="sc8">nil</span><span class="sc12">=</span><span class="sc0">1,</span><span class="sc24"> </span><span class="sc0">r</span><span class="sc13">)</span><span class="sc0">,</span><span class="sc24">
     </span><span class="sc0">l</span><span class="sc12">:</span><span class="sc5">subst</span><span class="sc13">(</span><span class="sc2">"."</span><span class="sc0">,</span><span class="sc2">"*"</span><span class="sc0">,l</span><span class="sc13">)</span><span class="sc0">,</span><span class="sc24">
    </span><span class="sc0">r</span><span class="sc12">*</span><span class="sc5">dotsimpc</span><span class="sc13">(</span><span class="sc0">l</span><span class="sc13">)</span><span class="sc24">
  </span><span class="sc13">)</span><span class="sc24"> </span><span class="sc4">else</span><span class="sc24"> </span><span class="sc13">(</span><span class="sc24">
    </span><span class="sc1">/*ba:copy(ab),*/</span><span class="sc24">
    </span><span class="sc0">v</span><span class="sc12">:</span><span class="sc4">copy</span><span class="sc13">(</span><span class="sc5">inargs</span><span class="sc13">(</span><span class="sc0">ab</span><span class="sc13">))</span><span class="sc0">,</span><span class="sc24">
    </span><span class="sc4">if</span><span class="sc24"> </span><span class="sc0">_debug</span><span class="sc12">=</span><span class="sc8">true</span><span class="sc24"> </span><span class="sc4">then</span><span class="sc24"> </span><span class="sc5">display</span><span class="sc13">(</span><span class="sc0">sop,</span><span class="sc24"> </span><span class="sc0">v</span><span class="sc13">)</span><span class="sc0">,</span><span class="sc24">
    </span><span class="sc0">w</span><span class="sc12">:</span><span class="sc5">sublist</span><span class="sc13">(</span><span class="sc24"> </span><span class="sc0">v,</span><span class="sc24"> </span><span class="sc4">lambda</span><span class="sc24"> </span><span class="sc13">(</span><span class="sc0">[z],</span><span class="sc24"> </span><span class="sc4">not</span><span class="sc24"> </span><span class="sc5">freeof</span><span class="sc13">(</span><span class="sc0">asymbol,z</span><span class="sc13">)</span><span class="sc24"> </span><span class="sc4">and</span><span class="sc24"> </span><span class="sc5">mapatom</span><span class="sc13">(</span><span class="sc0">z</span><span class="sc13">)))</span><span class="sc0">,</span><span class="sc24">
    </span><span class="sc0">w</span><span class="sc12">:</span><span class="sc0">permsign</span><span class="sc13">(</span><span class="sc0">w</span><span class="sc13">)</span><span class="sc0">,</span><span class="sc24">
    </span><span class="sc4">if</span><span class="sc24"> </span><span class="sc0">w</span><span class="sc12">#</span><span class="sc3">0</span><span class="sc24"> </span><span class="sc4">then</span><span class="sc24"> </span><span class="sc13">(</span><span class="sc24">
     </span><span class="sc0">v</span><span class="sc12">:</span><span class="sc5">sort</span><span class="sc13">(</span><span class="sc0">v</span><span class="sc13">)</span><span class="sc0">,</span><span class="sc24">
     </span><span class="sc4">for</span><span class="sc24"> </span><span class="sc0">q</span><span class="sc24"> </span><span class="sc4">in</span><span class="sc24"> </span><span class="sc0">v</span><span class="sc24"> </span><span class="sc4">do</span><span class="sc24"> </span><span class="sc0">c</span><span class="sc12">:</span><span class="sc0">c.q,</span><span class="sc24">
     </span><span class="sc4">if</span><span class="sc24"> </span><span class="sc0">_debug</span><span class="sc12">=</span><span class="sc8">true</span><span class="sc24"> </span><span class="sc4">then</span><span class="sc24">  </span><span class="sc5">display</span><span class="sc13">(</span><span class="sc0">w,</span><span class="sc24"> </span><span class="sc0">v</span><span class="sc13">)</span><span class="sc0">,</span><span class="sc24">
     </span><span class="sc0">w</span><span class="sc12">*</span><span class="sc0">c</span><span class="sc24">
    </span><span class="sc13">)</span><span class="sc24"> </span><span class="sc4">else</span><span class="sc24"> </span><span class="sc0">ab</span><span class="sc24">
  </span><span class="sc13">)</span><span class="sc24">
</span><span class="sc13">)</span><span class="sc0">;</span><span class="sc24">

</span><span class="sc1">/*
internal function: parity of permutation calculation
*/</span><span class="sc24">
</span><span class="sc0">permsign</span><span class="sc13">(</span><span class="sc0">arr</span><span class="sc13">)</span><span class="sc12">:=</span><span class="sc4">block</span><span class="sc13">(</span><span class="sc0">[k</span><span class="sc12">:</span><span class="sc0">0,</span><span class="sc24"> </span><span class="sc0">len,</span><span class="sc24"> </span><span class="sc0">ret</span><span class="sc12">:</span><span class="sc3">0</span><span class="sc24"> </span><span class="sc0">]</span><span class="sc24"> </span><span class="sc0">,</span><span class="sc24">
    </span><span class="sc4">mode_declare</span><span class="sc13">(</span><span class="sc0">[k,</span><span class="sc24"> </span><span class="sc0">len],</span><span class="sc24"> </span><span class="sc5">fixnum</span><span class="sc13">)</span><span class="sc0">,</span><span class="sc24">
    </span><span class="sc4">if</span><span class="sc24"> </span><span class="sc4">not</span><span class="sc24"> </span><span class="sc5">listp</span><span class="sc13">(</span><span class="sc0">arr</span><span class="sc13">)</span><span class="sc24"> </span><span class="sc4">then</span><span class="sc24"> </span><span class="sc4">return</span><span class="sc24"> </span><span class="sc13">(</span><span class="sc8">false</span><span class="sc13">)</span><span class="sc0">,</span><span class="sc24">
    </span><span class="sc0">len</span><span class="sc12">:</span><span class="sc5">length</span><span class="sc13">(</span><span class="sc0">arr</span><span class="sc13">)</span><span class="sc0">,</span><span class="sc24">
    </span><span class="sc4">for</span><span class="sc24"> </span><span class="sc0">i</span><span class="sc12">:</span><span class="sc3">1</span><span class="sc24"> </span><span class="sc4">thru</span><span class="sc24"> </span><span class="sc0">len</span><span class="sc24"> </span><span class="sc4">do</span><span class="sc24"> </span><span class="sc13">(</span><span class="sc24">
        </span><span class="sc4">if</span><span class="sc24"> </span><span class="sc4">not</span><span class="sc24"> </span><span class="sc5">mapatom</span><span class="sc13">(</span><span class="sc0">arr[i]</span><span class="sc13">)</span><span class="sc24"> </span><span class="sc4">then</span><span class="sc24"> </span><span class="sc0">ret</span><span class="sc12">:</span><span class="sc8">nil,</span><span class="sc24">
        </span><span class="sc4">for</span><span class="sc24"> </span><span class="sc0">j</span><span class="sc12">:</span><span class="sc0">i</span><span class="sc12">+</span><span class="sc3">1</span><span class="sc24"> </span><span class="sc4">thru</span><span class="sc24"> </span><span class="sc0">len</span><span class="sc24"> </span><span class="sc4">do</span><span class="sc24"> 
            </span><span class="sc4">if</span><span class="sc24"> </span><span class="sc5">ordergreatp</span><span class="sc13">(</span><span class="sc0">arr[i],</span><span class="sc24"> </span><span class="sc0">arr[j]</span><span class="sc13">)</span><span class="sc24"> </span><span class="sc4">then</span><span class="sc24"> </span><span class="sc0">k</span><span class="sc12">:</span><span class="sc0">k</span><span class="sc12">+</span><span class="sc3">1</span><span class="sc24">
    </span><span class="sc13">)</span><span class="sc0">,</span><span class="sc24">
    </span><span class="sc4">if</span><span class="sc24"> </span><span class="sc0">ret</span><span class="sc12">#</span><span class="sc8">nil</span><span class="sc24"> </span><span class="sc4">then</span><span class="sc24"> 
        </span><span class="sc4">if</span><span class="sc24"> </span><span class="sc5">evenp</span><span class="sc13">(</span><span class="sc0">k</span><span class="sc13">)</span><span class="sc24">  </span><span class="sc4">then</span><span class="sc24"> </span><span class="sc3">1</span><span class="sc24"> </span><span class="sc4">else</span><span class="sc24"> </span><span class="sc3">-1</span><span class="sc24">
    </span><span class="sc4">else</span><span class="sc24"> </span><span class="sc3">0</span><span class="sc24">
</span><span class="sc13">)</span><span class="sc0">;</span><span class="sc24">

</span><span class="sc1">/*
Abstract Cliford algebra construction
*/</span><span class="sc24">
</span><span class="sc5">matchdeclare</span><span class="sc13">(</span><span class="sc0">[aa,</span><span class="sc24"> </span><span class="sc0">ee],</span><span class="sc24"> </span><span class="sc4">lambda</span><span class="sc13">(</span><span class="sc0">[u],</span><span class="sc24"> </span><span class="sc4">not</span><span class="sc24"> </span><span class="sc5">freeof</span><span class="sc13">(</span><span class="sc0">asymbol,u</span><span class="sc13">)</span><span class="sc24"> </span><span class="sc4">and</span><span class="sc24"> </span><span class="sc5">freeof</span><span class="sc24"> </span><span class="sc13">(</span><span class="sc2">"+"</span><span class="sc0">,</span><span class="sc24"> </span><span class="sc0">u</span><span class="sc13">)</span><span class="sc24"> </span><span class="sc4">and</span><span class="sc24"> </span><span class="sc4">not</span><span class="sc24"> </span><span class="sc5">scalarp</span><span class="sc13">(</span><span class="sc0">u</span><span class="sc13">)</span><span class="sc24"> </span><span class="sc13">)</span><span class="sc0">,</span><span class="sc24"> </span><span class="sc0">[bb,cc],</span><span class="sc24"> </span><span class="sc8">true,</span><span class="sc24"> 
            </span><span class="sc0">[kk,</span><span class="sc24"> </span><span class="sc0">mm,</span><span class="sc24"> </span><span class="sc0">nn],</span><span class="sc24"> </span><span class="sc4">lambda</span><span class="sc13">(</span><span class="sc24"> </span><span class="sc0">[z],</span><span class="sc24">  </span><span class="sc5">integerp</span><span class="sc13">(</span><span class="sc0">z</span><span class="sc13">)</span><span class="sc24"> </span><span class="sc4">and</span><span class="sc24"> </span><span class="sc0">z</span><span class="sc12">&gt;</span><span class="sc3">0</span><span class="sc13">))</span><span class="sc0">;</span><span class="sc24">  
            
</span><span class="sc4">if</span><span class="sc24"> </span><span class="sc5">get</span><span class="sc13">(</span><span class="sc12">'</span><span class="sc0">clifford,</span><span class="sc12">'</span><span class="sc0">version</span><span class="sc13">)</span><span class="sc12">=</span><span class="sc8">false</span><span class="sc24"> </span><span class="sc4">then</span><span class="sc24"> </span><span class="sc13">(</span><span class="sc24">
    </span><span class="sc6">simp</span><span class="sc12">:</span><span class="sc8">false,</span><span class="sc24">
    </span><span class="sc5">tellsimp</span><span class="sc13">(</span><span class="sc0">aa[kk].aa[kk],</span><span class="sc24"> </span><span class="sc5">signature[kk]</span><span class="sc24"> </span><span class="sc13">)</span><span class="sc0">,</span><span class="sc24">
    </span><span class="sc5">tellsimpafter</span><span class="sc13">(</span><span class="sc0">aa[kk].aa[mm],</span><span class="sc24"> </span><span class="sc5">dotsimp2</span><span class="sc13">(</span><span class="sc0">aa[kk].aa[mm]</span><span class="sc13">))</span><span class="sc0">,</span><span class="sc24">
    </span><span class="sc5">tellsimpafter</span><span class="sc13">(</span><span class="sc0">bb.ee.cc,</span><span class="sc24"> </span><span class="sc5">dotsimpc</span><span class="sc13">(</span><span class="sc0">bb.ee.cc</span><span class="sc13">))</span><span class="sc0">,</span><span class="sc24">
    </span><span class="sc5">tellsimpafter</span><span class="sc13">(</span><span class="sc0">aa[kk]</span><span class="sc12">^^</span><span class="sc0">nn,</span><span class="sc24"> </span><span class="sc0">powsimp</span><span class="sc13">(</span><span class="sc0">aa[kk]</span><span class="sc12">^^</span><span class="sc0">nn</span><span class="sc13">))</span><span class="sc0">,</span><span class="sc24">
    </span><span class="sc6">simp</span><span class="sc12">:</span><span class="sc8">true</span><span class="sc24">
</span><span class="sc13">)</span><span class="sc0">;</span><span class="sc24">

</span><span class="sc1">/*  experimental code*/</span><span class="sc24">
</span><span class="sc4">if</span><span class="sc24"> </span><span class="sc5">get</span><span class="sc13">(</span><span class="sc12">'</span><span class="sc0">clifford,</span><span class="sc12">'</span><span class="sc0">version</span><span class="sc13">)</span><span class="sc12">=</span><span class="sc8">false</span><span class="sc24"> </span><span class="sc4">then</span><span class="sc24"> </span><span class="sc13">(</span><span class="sc24">
    </span><span class="sc1">/* simplification of  involution*/</span><span class="sc24">
    </span><span class="sc5">tellsimpafter</span><span class="sc13">(</span><span class="sc12">'</span><span class="sc0">cinvolve</span><span class="sc13">(</span><span class="sc12">'</span><span class="sc0">cinvolve</span><span class="sc13">(</span><span class="sc0">bb</span><span class="sc13">))</span><span class="sc0">,</span><span class="sc24"> </span><span class="sc0">bb</span><span class="sc13">)</span><span class="sc24">
</span><span class="sc13">)</span><span class="sc0">;</span><span class="sc24">          
            
</span><span class="sc1">/*
simplification rules
*/</span><span class="sc24">          
</span><span class="sc5">matchdeclare</span><span class="sc13">(</span><span class="sc0">dd,</span><span class="sc24"> </span><span class="sc4">lambda</span><span class="sc13">(</span><span class="sc0">[u],</span><span class="sc24">  </span><span class="sc5">freeof</span><span class="sc13">(</span><span class="sc0">asymbol,</span><span class="sc24"> </span><span class="sc0">u</span><span class="sc13">))</span><span class="sc0">,</span><span class="sc24"> </span><span class="sc0">[gg,</span><span class="sc24"> </span><span class="sc0">hh],</span><span class="sc24"> </span><span class="sc4">lambda</span><span class="sc13">(</span><span class="sc0">[u],</span><span class="sc24">  </span><span class="sc4">not</span><span class="sc24"> </span><span class="sc5">freeof</span><span class="sc13">(</span><span class="sc0">asymbol,</span><span class="sc24"> </span><span class="sc0">u</span><span class="sc13">)))</span><span class="sc0">;</span><span class="sc24"> 
</span><span class="sc5">matchdeclare</span><span class="sc13">(</span><span class="sc0">ds,</span><span class="sc24"> </span><span class="sc4">lambda</span><span class="sc13">(</span><span class="sc0">[u],</span><span class="sc24">  </span><span class="sc4">not</span><span class="sc24"> </span><span class="sc5">freeof</span><span class="sc13">(</span><span class="sc0">asymbol,</span><span class="sc24"> </span><span class="sc0">u</span><span class="sc13">)</span><span class="sc24"> </span><span class="sc4">and</span><span class="sc24"> </span><span class="sc4">not</span><span class="sc24"> </span><span class="sc13">(</span><span class="sc5">freeof</span><span class="sc13">(</span><span class="sc2">"^"</span><span class="sc0">,</span><span class="sc24"> </span><span class="sc0">u</span><span class="sc13">)</span><span class="sc24"> </span><span class="sc4">or</span><span class="sc24"> </span><span class="sc5">freeof</span><span class="sc13">(</span><span class="sc2">"^^"</span><span class="sc0">,</span><span class="sc24"> </span><span class="sc0">u</span><span class="sc13">)</span><span class="sc24"> </span><span class="sc13">)</span><span class="sc24"> </span><span class="sc13">)</span><span class="sc0">,</span><span class="sc24"> </span><span class="sc0">rn,</span><span class="sc24"> </span><span class="sc5">numberp</span><span class="sc13">)</span><span class="sc0">;</span><span class="sc24">
    
</span><span class="sc5">defrule</span><span class="sc24"> </span><span class="sc13">(</span><span class="sc0">clifsimp1,</span><span class="sc24"> </span><span class="sc0">dd</span><span class="sc12">*</span><span class="sc0">bb,</span><span class="sc24"> </span><span class="sc0">dd.dotsimpc</span><span class="sc13">(</span><span class="sc0">bb</span><span class="sc13">))</span><span class="sc0">;</span><span class="sc24">
</span><span class="sc5">defrule</span><span class="sc24"> </span><span class="sc13">(</span><span class="sc0">clifsimp11,</span><span class="sc24"> </span><span class="sc0">bb.cc,</span><span class="sc24"> </span><span class="sc0">bb.dotsimpc</span><span class="sc13">(</span><span class="sc0">cc</span><span class="sc13">))</span><span class="sc0">;</span><span class="sc24">
</span><span class="sc5">defrule</span><span class="sc24"> </span><span class="sc13">(</span><span class="sc0">clifsimp10,</span><span class="sc24"> </span><span class="sc0">bb,</span><span class="sc24"> </span><span class="sc5">dotsimpc</span><span class="sc13">(</span><span class="sc0">bb</span><span class="sc13">))</span><span class="sc0">;</span><span class="sc24">
</span><span class="sc5">defrule</span><span class="sc24"> </span><span class="sc13">(</span><span class="sc0">clifsimp21,</span><span class="sc24"> </span><span class="sc0">bb</span><span class="sc12">/</span><span class="sc0">gg,</span><span class="sc24"> </span><span class="sc0">bb</span><span class="sc24"> </span><span class="sc0">.</span><span class="sc24"> </span><span class="sc0">dotinvsimp</span><span class="sc13">(</span><span class="sc3">1</span><span class="sc12">/</span><span class="sc0">gg</span><span class="sc13">))</span><span class="sc0">;</span><span class="sc24">
</span><span class="sc5">defrule</span><span class="sc24"> </span><span class="sc13">(</span><span class="sc0">clifsimp3,</span><span class="sc24"> </span><span class="sc0">ds,</span><span class="sc24">  </span><span class="sc0">powsimp</span><span class="sc13">(</span><span class="sc0">ds</span><span class="sc13">))</span><span class="sc0">;</span><span class="sc24">
</span><span class="sc5">defrule</span><span class="sc24"> </span><span class="sc13">(</span><span class="sc0">clifsimp4,</span><span class="sc24"> </span><span class="sc5">exp</span><span class="sc13">(</span><span class="sc0">gg</span><span class="sc13">)</span><span class="sc0">.</span><span class="sc24"> </span><span class="sc5">exp</span><span class="sc13">(</span><span class="sc0">hh</span><span class="sc13">)</span><span class="sc0">,</span><span class="sc24">  </span><span class="sc5">exp</span><span class="sc13">(</span><span class="sc0">gg</span><span class="sc12">+</span><span class="sc0">hh</span><span class="sc13">))</span><span class="sc0">;</span><span class="sc24">


</span><span class="sc4">declare</span><span class="sc24"> </span><span class="sc13">(</span><span class="sc0">cliexpsimp,</span><span class="sc24"> </span><span class="sc7">evfun</span><span class="sc13">)</span><span class="sc0">;</span><span class="sc24">
</span><span class="sc0">cliexpsimp</span><span class="sc13">(</span><span class="sc5">expr</span><span class="sc13">)</span><span class="sc12">:=</span><span class="sc4">block</span><span class="sc13">(</span><span class="sc0">[l,r,</span><span class="sc24"> </span><span class="sc0">ret</span><span class="sc12">:</span><span class="sc0">1],</span><span class="sc24">
    </span><span class="sc4">if</span><span class="sc24"> </span><span class="sc5">inop</span><span class="sc13">(</span><span class="sc5">expr</span><span class="sc13">)</span><span class="sc12">=</span><span class="sc2">"+"</span><span class="sc24"> </span><span class="sc4">or</span><span class="sc24"> </span><span class="sc5">listp</span><span class="sc13">(</span><span class="sc5">expr</span><span class="sc13">)</span><span class="sc24"> </span><span class="sc4">then</span><span class="sc24"> 
        </span><span class="sc5">expr</span><span class="sc12">:</span><span class="sc5">map</span><span class="sc13">(</span><span class="sc0">cliexpsimp,</span><span class="sc24"> </span><span class="sc5">expr</span><span class="sc24"> </span><span class="sc13">)</span><span class="sc0">,</span><span class="sc24">
    </span><span class="sc4">if</span><span class="sc24"> </span><span class="sc4">not</span><span class="sc24"> </span><span class="sc5">freeof</span><span class="sc13">(</span><span class="sc8">%e,</span><span class="sc24"> </span><span class="sc5">expr</span><span class="sc13">)</span><span class="sc24"> </span><span class="sc4">then</span><span class="sc24"> </span><span class="sc13">(</span><span class="sc24">
        </span><span class="sc0">[l,r]</span><span class="sc12">:</span><span class="sc5">oppart</span><span class="sc13">(</span><span class="sc5">expr,</span><span class="sc24"> </span><span class="sc4">lambda</span><span class="sc13">(</span><span class="sc0">[u],</span><span class="sc24"> </span><span class="sc5">freeof</span><span class="sc13">(</span><span class="sc8">%e,</span><span class="sc24"> </span><span class="sc0">u</span><span class="sc13">)))</span><span class="sc0">,</span><span class="sc24">
        </span><span class="sc1">/*display(l,r),*/</span><span class="sc24">
        </span><span class="sc0">r</span><span class="sc12">:</span><span class="sc5">apply1</span><span class="sc13">(</span><span class="sc24"> </span><span class="sc0">r,</span><span class="sc24"> </span><span class="sc0">clifsimp4</span><span class="sc13">)</span><span class="sc0">,</span><span class="sc24">
        </span><span class="sc4">if</span><span class="sc24"> </span><span class="sc4">not</span><span class="sc24"> </span><span class="sc5">freeof</span><span class="sc13">(</span><span class="sc0">asymbol,</span><span class="sc24"> </span><span class="sc0">l</span><span class="sc13">)</span><span class="sc24"> </span><span class="sc4">then</span><span class="sc24">
            </span><span class="sc0">l</span><span class="sc12">:</span><span class="sc5">dotsimpc</span><span class="sc13">(</span><span class="sc0">l</span><span class="sc13">)</span><span class="sc0">,</span><span class="sc24">  
        </span><span class="sc4">if</span><span class="sc24"> </span><span class="sc4">not</span><span class="sc24"> </span><span class="sc5">freeof</span><span class="sc13">(</span><span class="sc8">%e,</span><span class="sc24"> </span><span class="sc0">r</span><span class="sc13">)</span><span class="sc24"> </span><span class="sc4">then</span><span class="sc24"> 
            </span><span class="sc0">r</span><span class="sc12">:</span><span class="sc24"> </span><span class="sc0">cliexpsimp</span><span class="sc13">(</span><span class="sc0">r</span><span class="sc13">)</span><span class="sc0">,</span><span class="sc24"> 
        </span><span class="sc0">ret</span><span class="sc12">:</span><span class="sc5">subst</span><span class="sc13">(</span><span class="sc8">nil</span><span class="sc12">=</span><span class="sc0">1,</span><span class="sc24"> </span><span class="sc0">l</span><span class="sc13">)</span><span class="sc12">*</span><span class="sc0">r</span><span class="sc24">   
    </span><span class="sc13">)</span><span class="sc24"> </span><span class="sc4">else</span><span class="sc24"> </span><span class="sc0">ret</span><span class="sc12">:</span><span class="sc5">expr,</span><span class="sc24">
    </span><span class="sc0">ret</span><span class="sc24">
</span><span class="sc13">)</span><span class="sc0">;</span><span class="sc24">


</span><span class="sc0">trigp</span><span class="sc13">(</span><span class="sc5">expr</span><span class="sc13">)</span><span class="sc12">:=</span><span class="sc4">block</span><span class="sc13">(</span><span class="sc0">[u,</span><span class="sc24"> </span><span class="sc8">%trigf</span><span class="sc12">:</span><span class="sc24"> </span><span class="sc12">'</span><span class="sc5">sin</span><span class="sc24"> </span><span class="sc4">or</span><span class="sc24"> </span><span class="sc12">'</span><span class="sc5">cos</span><span class="sc24"> </span><span class="sc4">or</span><span class="sc24"> </span><span class="sc12">'</span><span class="sc5">tan</span><span class="sc24"> </span><span class="sc4">or</span><span class="sc24"> </span><span class="sc12">'</span><span class="sc5">cot],</span><span class="sc24">
    </span><span class="sc5">map</span><span class="sc13">(</span><span class="sc4">lambda</span><span class="sc13">(</span><span class="sc0">[u],</span><span class="sc24">   </span><span class="sc4">not</span><span class="sc24"> </span><span class="sc5">freeof</span><span class="sc13">(</span><span class="sc0">u,</span><span class="sc24"> </span><span class="sc5">expr</span><span class="sc13">))</span><span class="sc0">,</span><span class="sc24"> </span><span class="sc8">%trigf</span><span class="sc13">)</span><span class="sc24">
</span><span class="sc13">)</span><span class="sc0">;</span><span class="sc24">

</span><span class="sc1">/*
full simplification of expressions
inncludes dot-products and inverses
*/</span><span class="sc24">
</span><span class="sc4">declare</span><span class="sc24"> </span><span class="sc13">(</span><span class="sc0">cliffsimpall,</span><span class="sc24"> </span><span class="sc7">evfun</span><span class="sc13">)</span><span class="sc0">;</span><span class="sc24">
</span><span class="sc0">cliffsimpall</span><span class="sc13">(</span><span class="sc5">expr</span><span class="sc13">)</span><span class="sc12">:=</span><span class="sc4">block</span><span class="sc13">(</span><span class="sc0">[res,</span><span class="sc24"> </span><span class="sc0">aa,</span><span class="sc24"> </span><span class="sc0">bb,</span><span class="sc24"> </span><span class="sc0">sop,</span><span class="sc24"> </span><span class="sc6">simp</span><span class="sc12">:</span><span class="sc8">true],</span><span class="sc24">
    </span><span class="sc0">sop</span><span class="sc12">:</span><span class="sc5">inop</span><span class="sc13">(</span><span class="sc5">expr</span><span class="sc13">)</span><span class="sc0">,</span><span class="sc24">
    </span><span class="sc4">if</span><span class="sc24"> </span><span class="sc4">equal</span><span class="sc13">(</span><span class="sc0">sop,</span><span class="sc24"> </span><span class="sc2">"="</span><span class="sc13">)</span><span class="sc24"> </span><span class="sc4">then</span><span class="sc24"> </span><span class="sc13">(</span><span class="sc24">
        </span><span class="sc0">aa</span><span class="sc12">:</span><span class="sc0">cliffsimpall</span><span class="sc13">(</span><span class="sc5">lhs</span><span class="sc13">(</span><span class="sc5">expr</span><span class="sc13">))</span><span class="sc0">,</span><span class="sc24">
        </span><span class="sc0">bb</span><span class="sc12">:</span><span class="sc0">cliffsimpall</span><span class="sc13">(</span><span class="sc5">rhs</span><span class="sc13">(</span><span class="sc5">expr</span><span class="sc13">))</span><span class="sc0">,</span><span class="sc24">
        </span><span class="sc4">return</span><span class="sc13">(</span><span class="sc24"> </span><span class="sc0">aa</span><span class="sc24"> </span><span class="sc12">=</span><span class="sc24"> </span><span class="sc0">bb</span><span class="sc13">)</span><span class="sc24">
    </span><span class="sc13">)</span><span class="sc24"> </span><span class="sc4">else</span><span class="sc24"> </span><span class="sc13">(</span><span class="sc24">
        </span><span class="sc0">res</span><span class="sc12">:</span><span class="sc5">subst</span><span class="sc13">(</span><span class="sc2">"^"</span><span class="sc12">=</span><span class="sc2">"^^"</span><span class="sc0">,</span><span class="sc24"> </span><span class="sc5">expr</span><span class="sc13">)</span><span class="sc0">,</span><span class="sc24">
        </span><span class="sc0">res</span><span class="sc12">:</span><span class="sc5">expand</span><span class="sc13">(</span><span class="sc0">res</span><span class="sc13">)</span><span class="sc0">,</span><span class="sc24">
        </span><span class="sc1">/*res:apply1(res, clifsimp3, clifsimp21, clifsimp2),*/</span><span class="sc24">
        </span><span class="sc0">res</span><span class="sc12">:</span><span class="sc5">apply1</span><span class="sc13">(</span><span class="sc0">res,</span><span class="sc24"> </span><span class="sc0">clifsimp3,</span><span class="sc24"> </span><span class="sc0">clifsimp21</span><span class="sc13">)</span><span class="sc0">,</span><span class="sc24">
        </span><span class="sc0">res</span><span class="sc12">:</span><span class="sc5">apply1</span><span class="sc13">(</span><span class="sc0">res,</span><span class="sc24"> </span><span class="sc0">clifsimp1,</span><span class="sc24"> </span><span class="sc0">clifsimp10</span><span class="sc13">)</span><span class="sc0">,</span><span class="sc24">
        </span><span class="sc1">/*if not freeof(%e, res) then 
            res:cliexpsimp(res),*/</span><span class="sc24">
        </span><span class="sc4">if</span><span class="sc24"> </span><span class="sc0">trigp</span><span class="sc13">(</span><span class="sc0">res</span><span class="sc13">)</span><span class="sc24"> </span><span class="sc4">then</span><span class="sc24"> 
            </span><span class="sc0">res</span><span class="sc12">:</span><span class="sc24"> </span><span class="sc5">trigsimp</span><span class="sc13">(</span><span class="sc0">res</span><span class="sc13">)</span><span class="sc0">,</span><span class="sc24">
        </span><span class="sc5">ratsimp</span><span class="sc13">(</span><span class="sc0">res</span><span class="sc13">)</span><span class="sc24">
    </span><span class="sc13">)</span><span class="sc24">
</span><span class="sc13">)</span><span class="sc0">;</span><span class="sc24">

</span><span class="sc1">/*
simplification of dot-products
*/</span><span class="sc24">
</span><span class="sc0">cliffsimp1</span><span class="sc13">(</span><span class="sc5">expr</span><span class="sc13">)</span><span class="sc12">:=</span><span class="sc4">block</span><span class="sc13">(</span><span class="sc0">[res],</span><span class="sc24">
    </span><span class="sc0">res</span><span class="sc12">:</span><span class="sc5">expand</span><span class="sc13">(</span><span class="sc5">expr</span><span class="sc13">)</span><span class="sc0">,</span><span class="sc24">
    </span><span class="sc5">apply1</span><span class="sc13">(</span><span class="sc0">res,</span><span class="sc24"> </span><span class="sc0">clifsimp1,</span><span class="sc24"> </span><span class="sc0">clifsimp10</span><span class="sc13">)</span><span class="sc24">
</span><span class="sc13">)</span><span class="sc0">;</span><span class="sc24">


</span><span class="sc1">/*
 simplification of inverses
*/</span><span class="sc24">
</span><span class="sc4">declare</span><span class="sc24"> </span><span class="sc13">(</span><span class="sc0">dotinvsimp,</span><span class="sc24"> </span><span class="sc7">evfun</span><span class="sc13">)</span><span class="sc0">;</span><span class="sc24">
</span><span class="sc0">dotinvsimp</span><span class="sc13">(</span><span class="sc0">ab</span><span class="sc13">)</span><span class="sc12">:=</span><span class="sc4">block</span><span class="sc13">(</span><span class="sc24"> </span><span class="sc0">[a,b,c,s],</span><span class="sc24">
 </span><span class="sc4">mode_declare</span><span class="sc13">(</span><span class="sc0">[a,b,s],</span><span class="sc24"> </span><span class="sc9">any</span><span class="sc13">)</span><span class="sc0">,</span><span class="sc24">
 </span><span class="sc4">if</span><span class="sc24"> </span><span class="sc5">mapatom</span><span class="sc13">(</span><span class="sc0">ab</span><span class="sc13">)</span><span class="sc24"> </span><span class="sc4">or</span><span class="sc24"> </span><span class="sc5">freeof</span><span class="sc13">(</span><span class="sc0">asymbol,</span><span class="sc24"> </span><span class="sc0">ab</span><span class="sc13">)</span><span class="sc24"> </span><span class="sc4">or</span><span class="sc24"> </span><span class="sc5">op</span><span class="sc13">(</span><span class="sc0">ab</span><span class="sc13">)</span><span class="sc12">#</span><span class="sc2">"/"</span><span class="sc24"> </span><span class="sc4">then</span><span class="sc24"> </span><span class="sc4">return</span><span class="sc13">(</span><span class="sc0">ab</span><span class="sc13">)</span><span class="sc0">,</span><span class="sc24">
  </span><span class="sc0">a</span><span class="sc12">:</span><span class="sc5">part</span><span class="sc13">(</span><span class="sc0">ab,1</span><span class="sc13">)</span><span class="sc0">,</span><span class="sc24">
  </span><span class="sc0">b</span><span class="sc12">:</span><span class="sc5">part</span><span class="sc13">(</span><span class="sc0">ab,2</span><span class="sc13">)</span><span class="sc0">,</span><span class="sc24">
  </span><span class="sc0">c</span><span class="sc12">:</span><span class="sc0">dotconjugate</span><span class="sc13">(</span><span class="sc0">b</span><span class="sc13">)</span><span class="sc0">,</span><span class="sc24">
  </span><span class="sc0">s</span><span class="sc12">:</span><span class="sc24"> </span><span class="sc5">expand</span><span class="sc13">(</span><span class="sc0">c.b</span><span class="sc13">)</span><span class="sc0">,</span><span class="sc24">
  </span><span class="sc4">if</span><span class="sc24"> </span><span class="sc0">_debug</span><span class="sc12">=</span><span class="sc8">true</span><span class="sc24"> </span><span class="sc4">then</span><span class="sc24"> </span><span class="sc5">display</span><span class="sc13">(</span><span class="sc0">a,b,s</span><span class="sc13">)</span><span class="sc0">,</span><span class="sc24">
  </span><span class="sc4">if</span><span class="sc24"> </span><span class="sc4">not</span><span class="sc24"> </span><span class="sc5">freeof</span><span class="sc13">(</span><span class="sc0">asymbol,</span><span class="sc24"> </span><span class="sc0">s</span><span class="sc13">)</span><span class="sc24"> </span><span class="sc4">then</span><span class="sc24">  </span><span class="sc0">s</span><span class="sc12">:</span><span class="sc0">cliffsimp1</span><span class="sc13">(</span><span class="sc0">s</span><span class="sc13">)</span><span class="sc0">,</span><span class="sc24">
  </span><span class="sc4">if</span><span class="sc24"> </span><span class="sc0">s</span><span class="sc12">#</span><span class="sc3">0</span><span class="sc24"> </span><span class="sc4">and</span><span class="sc24"> </span><span class="sc5">scalarp</span><span class="sc13">(</span><span class="sc0">s</span><span class="sc13">)</span><span class="sc24"> </span><span class="sc4">then</span><span class="sc24"> </span><span class="sc0">a.c</span><span class="sc12">/</span><span class="sc0">s</span><span class="sc24"> </span><span class="sc4">else</span><span class="sc24"> </span><span class="sc0">ab</span><span class="sc24"> 
</span><span class="sc13">)</span><span class="sc0">;</span><span class="sc24">


</span><span class="sc1">/*
Clifford inverse
*/</span><span class="sc24">
</span><span class="sc0">cinv</span><span class="sc13">(</span><span class="sc0">ab</span><span class="sc13">)</span><span class="sc12">:=</span><span class="sc4">block</span><span class="sc13">(</span><span class="sc24"> </span><span class="sc0">[s,</span><span class="sc24"> </span><span class="sc0">b,</span><span class="sc24"> </span><span class="sc0">u</span><span class="sc12">:</span><span class="sc0">1],</span><span class="sc24">
    </span><span class="sc4">if</span><span class="sc24"> </span><span class="sc5">atom</span><span class="sc13">(</span><span class="sc0">ab</span><span class="sc13">)</span><span class="sc24"> </span><span class="sc4">or</span><span class="sc24"> </span><span class="sc5">freeof</span><span class="sc13">(</span><span class="sc0">asymbol,</span><span class="sc24"> </span><span class="sc0">ab</span><span class="sc13">)</span><span class="sc24"> </span><span class="sc4">then</span><span class="sc24"> 
    </span><span class="sc4">if</span><span class="sc24"> </span><span class="sc0">ab</span><span class="sc12">#</span><span class="sc3">0</span><span class="sc24"> </span><span class="sc4">then</span><span class="sc24"> </span><span class="sc4">return</span><span class="sc13">(</span><span class="sc3">1</span><span class="sc12">/</span><span class="sc0">ab</span><span class="sc13">)</span><span class="sc24"> </span><span class="sc4">else</span><span class="sc24"> </span><span class="sc4">return</span><span class="sc13">(</span><span class="sc12">'</span><span class="sc0">nan</span><span class="sc13">)</span><span class="sc0">,</span><span class="sc24">
    </span><span class="sc2">"first attempt - conjugattion"</span><span class="sc0">,</span><span class="sc24">
    </span><span class="sc0">b</span><span class="sc12">:</span><span class="sc0">dotconjugate</span><span class="sc13">(</span><span class="sc0">ab</span><span class="sc13">)</span><span class="sc0">,</span><span class="sc24">
    </span><span class="sc0">s</span><span class="sc12">:</span><span class="sc5">expand</span><span class="sc13">(</span><span class="sc0">b.ab</span><span class="sc13">)</span><span class="sc0">,</span><span class="sc24">
    </span><span class="sc4">if</span><span class="sc24"> </span><span class="sc4">not</span><span class="sc24"> </span><span class="sc5">freeof</span><span class="sc13">(</span><span class="sc0">asymbol,</span><span class="sc24"> </span><span class="sc0">s</span><span class="sc13">)</span><span class="sc24"> </span><span class="sc4">then</span><span class="sc24"> </span><span class="sc0">s</span><span class="sc12">:</span><span class="sc24"> </span><span class="sc5">apply1</span><span class="sc13">(</span><span class="sc0">s,</span><span class="sc24"> </span><span class="sc0">clifsimp10,</span><span class="sc24"> </span><span class="sc0">clifsimp21</span><span class="sc13">)</span><span class="sc0">,</span><span class="sc24">
    </span><span class="sc2">"second attempt - reversal"</span><span class="sc0">,</span><span class="sc24">
    </span><span class="sc4">if</span><span class="sc24"> </span><span class="sc4">not</span><span class="sc24"> </span><span class="sc5">freeof</span><span class="sc13">(</span><span class="sc0">asymbol,</span><span class="sc24"> </span><span class="sc0">s</span><span class="sc13">)</span><span class="sc24"> </span><span class="sc4">then</span><span class="sc24"> </span><span class="sc13">(</span><span class="sc24">
       </span><span class="sc0">b</span><span class="sc12">:</span><span class="sc0">creverse</span><span class="sc13">(</span><span class="sc0">ab</span><span class="sc13">)</span><span class="sc0">,</span><span class="sc24">
       </span><span class="sc0">s</span><span class="sc12">:</span><span class="sc5">expand</span><span class="sc13">(</span><span class="sc0">b.ab</span><span class="sc13">)</span><span class="sc0">,</span><span class="sc24">
       </span><span class="sc4">if</span><span class="sc24"> </span><span class="sc4">not</span><span class="sc24"> </span><span class="sc5">freeof</span><span class="sc13">(</span><span class="sc0">asymbol,</span><span class="sc24"> </span><span class="sc0">s</span><span class="sc13">)</span><span class="sc24"> </span><span class="sc4">then</span><span class="sc24"> </span><span class="sc0">s</span><span class="sc12">:</span><span class="sc24"> </span><span class="sc5">apply1</span><span class="sc13">(</span><span class="sc0">s,</span><span class="sc24"> </span><span class="sc0">clifsimp10,</span><span class="sc24"> </span><span class="sc0">clifsimp21</span><span class="sc13">)</span><span class="sc24">
    </span><span class="sc13">)</span><span class="sc0">,</span><span class="sc24">
    </span><span class="sc4">if</span><span class="sc24"> </span><span class="sc0">_debug</span><span class="sc12">=</span><span class="sc8">true</span><span class="sc24"> </span><span class="sc4">then</span><span class="sc24">  </span><span class="sc5">display</span><span class="sc13">(</span><span class="sc0">s</span><span class="sc13">)</span><span class="sc0">,</span><span class="sc24">
    </span><span class="sc4">if</span><span class="sc24"> </span><span class="sc0">s</span><span class="sc12">#</span><span class="sc3">0</span><span class="sc24"> </span><span class="sc4">and</span><span class="sc24"> </span><span class="sc5">freeof</span><span class="sc13">(</span><span class="sc0">asymbol,</span><span class="sc24"> </span><span class="sc0">s</span><span class="sc13">)</span><span class="sc24"> </span><span class="sc4">then</span><span class="sc24">
    </span><span class="sc4">return</span><span class="sc13">(</span><span class="sc0">b</span><span class="sc12">/</span><span class="sc0">s</span><span class="sc13">)</span><span class="sc24">
    </span><span class="sc4">else</span><span class="sc24"> </span><span class="sc4">return</span><span class="sc13">(</span><span class="sc3">1</span><span class="sc12">/</span><span class="sc0">ab</span><span class="sc13">)</span><span class="sc24">
</span><span class="sc13">)</span><span class="sc0">;</span><span class="sc24">


</span><span class="sc1">/*
simplification of exponents
*/</span><span class="sc24">
</span><span class="sc0">powsimp</span><span class="sc13">(</span><span class="sc0">aa</span><span class="sc13">)</span><span class="sc12">:=</span><span class="sc4">block</span><span class="sc13">(</span><span class="sc24"> </span><span class="sc0">[a,</span><span class="sc24"> </span><span class="sc0">k,</span><span class="sc24"> </span><span class="sc0">p</span><span class="sc12">:</span><span class="sc0">1],</span><span class="sc24">
  </span><span class="sc4">if</span><span class="sc24"> </span><span class="sc5">atom</span><span class="sc13">(</span><span class="sc0">aa</span><span class="sc13">)</span><span class="sc24"> </span><span class="sc4">then</span><span class="sc24"> </span><span class="sc4">return</span><span class="sc13">(</span><span class="sc0">aa</span><span class="sc13">)</span><span class="sc0">,</span><span class="sc24">
  </span><span class="sc4">if</span><span class="sc24"> </span><span class="sc5">inop</span><span class="sc13">(</span><span class="sc0">aa</span><span class="sc13">)</span><span class="sc12">=</span><span class="sc2">"^^"</span><span class="sc24"> </span><span class="sc4">then</span><span class="sc24"> </span><span class="sc13">(</span><span class="sc24">
      </span><span class="sc0">a</span><span class="sc12">:</span><span class="sc5">inpart</span><span class="sc13">(</span><span class="sc0">aa,1</span><span class="sc13">)</span><span class="sc0">,</span><span class="sc24">
      </span><span class="sc0">k</span><span class="sc12">:</span><span class="sc5">inpart</span><span class="sc13">(</span><span class="sc0">aa,2</span><span class="sc13">)</span><span class="sc0">,</span><span class="sc24">
      </span><span class="sc4">if</span><span class="sc24"> </span><span class="sc5">numberp</span><span class="sc13">(</span><span class="sc0">k</span><span class="sc13">)</span><span class="sc24"> </span><span class="sc4">then</span><span class="sc24"> </span><span class="sc13">(</span><span class="sc24">
          </span><span class="sc4">for</span><span class="sc24"> </span><span class="sc0">j</span><span class="sc12">:</span><span class="sc3">1</span><span class="sc24"> </span><span class="sc4">thru</span><span class="sc24"> </span><span class="sc0">k</span><span class="sc24"> </span><span class="sc4">do</span><span class="sc24"> </span><span class="sc0">p</span><span class="sc12">:</span><span class="sc0">p.a,</span><span class="sc24">
          </span><span class="sc5">dotsimpc</span><span class="sc13">(</span><span class="sc0">p</span><span class="sc13">)</span><span class="sc24">
      </span><span class="sc13">)</span><span class="sc24"> </span><span class="sc4">else</span><span class="sc24"> </span><span class="sc0">aa</span><span class="sc24">
   </span><span class="sc13">)</span><span class="sc24"> </span><span class="sc4">else</span><span class="sc24"> </span><span class="sc0">aa</span><span class="sc24">
</span><span class="sc13">)</span><span class="sc0">;</span><span class="sc24">



</span><span class="sc1">/*
constructor of the algebra
lsig[1] - number of positive elements
lsig[2] - number of negative elements
lsig[3] - number of positive elements
lsig[4] - sets signature
*/</span><span class="sc24">
</span><span class="sc0">clifford</span><span class="sc13">(</span><span class="sc0">var,</span><span class="sc24"> </span><span class="sc0">[lsig]</span><span class="sc13">)</span><span class="sc12">:=</span><span class="sc4">block</span><span class="sc13">(</span><span class="sc0">[m,</span><span class="sc24"> </span><span class="sc0">a,</span><span class="sc24"> </span><span class="sc0">p</span><span class="sc12">:</span><span class="sc0">0,</span><span class="sc24"> </span><span class="sc0">n</span><span class="sc12">:</span><span class="sc0">0,</span><span class="sc24"> </span><span class="sc0">r</span><span class="sc12">:</span><span class="sc0">0,</span><span class="sc24"> </span><span class="sc0">s</span><span class="sc12">:</span><span class="sc0">1],</span><span class="sc24">
    </span><span class="sc4">if</span><span class="sc24"> </span><span class="sc5">emptyp</span><span class="sc13">(</span><span class="sc0">lsig</span><span class="sc13">)</span><span class="sc24"> </span><span class="sc4">or</span><span class="sc24"> </span><span class="sc5">length</span><span class="sc13">(</span><span class="sc0">lsig</span><span class="sc13">)</span><span class="sc12">&gt;</span><span class="sc3">3</span><span class="sc24"> </span><span class="sc4">then</span><span class="sc24"> </span><span class="sc4">error</span><span class="sc13">(</span><span class="sc2">" invalid signature"</span><span class="sc13">)</span><span class="sc0">,</span><span class="sc24">
    </span><span class="sc0">p</span><span class="sc12">:</span><span class="sc0">lsig[1],</span><span class="sc24">
    </span><span class="sc4">if</span><span class="sc24"> </span><span class="sc5">length</span><span class="sc13">(</span><span class="sc0">lsig</span><span class="sc13">)</span><span class="sc12">=</span><span class="sc3">2</span><span class="sc24"> </span><span class="sc4">then</span><span class="sc24"> 
        </span><span class="sc0">n</span><span class="sc12">:</span><span class="sc0">lsig[2],</span><span class="sc24">
    </span><span class="sc4">if</span><span class="sc24"> </span><span class="sc5">length</span><span class="sc13">(</span><span class="sc0">lsig</span><span class="sc13">)</span><span class="sc12">=</span><span class="sc3">3</span><span class="sc24"> </span><span class="sc4">then</span><span class="sc24"> </span><span class="sc13">(</span><span class="sc24">
        </span><span class="sc0">n</span><span class="sc12">:</span><span class="sc0">lsig[2],</span><span class="sc24"> 
        </span><span class="sc0">r</span><span class="sc12">:</span><span class="sc0">lsig[3]</span><span class="sc24">
    </span><span class="sc13">)</span><span class="sc0">,</span><span class="sc24">
    </span><span class="sc1">/* optionally we can reverse the sign convention */</span><span class="sc24">
    </span><span class="sc4">if</span><span class="sc24"> </span><span class="sc5">length</span><span class="sc13">(</span><span class="sc0">lsig</span><span class="sc13">)</span><span class="sc12">=</span><span class="sc3">4</span><span class="sc24"> </span><span class="sc4">then</span><span class="sc24"> </span><span class="sc13">(</span><span class="sc24">
        </span><span class="sc0">n</span><span class="sc12">:</span><span class="sc0">lsig[2],</span><span class="sc24"> 
        </span><span class="sc0">r</span><span class="sc12">:</span><span class="sc0">lsig[3],</span><span class="sc24">
        </span><span class="sc0">s</span><span class="sc12">:</span><span class="sc24"> </span><span class="sc5">signum</span><span class="sc24"> </span><span class="sc13">(</span><span class="sc0">lsig[4]</span><span class="sc13">)</span><span class="sc0">,</span><span class="sc24">
        </span><span class="sc4">if</span><span class="sc24"> </span><span class="sc0">s</span><span class="sc12">=</span><span class="sc3">0</span><span class="sc24"> </span><span class="sc4">then</span><span class="sc24"> </span><span class="sc0">s</span><span class="sc12">:</span><span class="sc3">1</span><span class="sc24">
    </span><span class="sc13">)</span><span class="sc0">,</span><span class="sc24">
    </span><span class="sc4">if</span><span class="sc24"> </span><span class="sc4">not</span><span class="sc24"> </span><span class="sc13">(</span><span class="sc5">numberp</span><span class="sc13">(</span><span class="sc0">n</span><span class="sc13">)</span><span class="sc24"> </span><span class="sc4">or</span><span class="sc24"> </span><span class="sc5">numberp</span><span class="sc13">(</span><span class="sc0">p</span><span class="sc13">)</span><span class="sc24"> </span><span class="sc4">or</span><span class="sc24"> </span><span class="sc5">numberp</span><span class="sc13">(</span><span class="sc0">r</span><span class="sc13">)</span><span class="sc24"> </span><span class="sc4">or</span><span class="sc24"> </span><span class="sc5">numberp</span><span class="sc13">(</span><span class="sc0">s</span><span class="sc13">)</span><span class="sc24"> </span><span class="sc13">)</span><span class="sc24"> </span><span class="sc4">then</span><span class="sc24"> </span><span class="sc4">error</span><span class="sc13">(</span><span class="sc2">" provide numbers"</span><span class="sc13">)</span><span class="sc0">,</span><span class="sc24">
    </span><span class="sc0">m</span><span class="sc12">:</span><span class="sc0">p</span><span class="sc12">+</span><span class="sc0">r</span><span class="sc12">+</span><span class="sc0">n,</span><span class="sc24">
    </span><span class="sc4">if</span><span class="sc24"> </span><span class="sc0">_debug</span><span class="sc12">=</span><span class="sc8">true</span><span class="sc24"> </span><span class="sc4">then</span><span class="sc24"> </span><span class="sc5">print</span><span class="sc13">(</span><span class="sc0">m,p,n,r</span><span class="sc13">)</span><span class="sc0">,</span><span class="sc24">
    </span><span class="sc4">if</span><span class="sc24"> </span><span class="sc0">m</span><span class="sc12">&lt;=</span><span class="sc3">0</span><span class="sc24"> </span><span class="sc4">then</span><span class="sc24"> </span><span class="sc4">return</span><span class="sc24"> </span><span class="sc13">(</span><span class="sc8">false</span><span class="sc13">)</span><span class="sc0">,</span><span class="sc24">
    
    </span><span class="sc4">local</span><span class="sc24"> </span><span class="sc13">(</span><span class="sc0">a</span><span class="sc13">)</span><span class="sc0">,</span><span class="sc24">
    </span><span class="sc0">a[i,j]</span><span class="sc12">:=</span><span class="sc24"> </span><span class="sc4">if</span><span class="sc24"> </span><span class="sc0">i</span><span class="sc12">#</span><span class="sc0">j</span><span class="sc24"> </span><span class="sc4">then</span><span class="sc24"> </span><span class="sc3">0</span><span class="sc24"> </span><span class="sc4">else</span><span class="sc24"> </span><span class="sc13">(</span><span class="sc24">
        </span><span class="sc4">if</span><span class="sc24"> </span><span class="sc0">i</span><span class="sc12">&lt;=</span><span class="sc0">p</span><span class="sc24"> </span><span class="sc4">then</span><span class="sc24"> </span><span class="sc0">s</span><span class="sc24"> </span><span class="sc4">else</span><span class="sc24"> </span><span class="sc4">if</span><span class="sc24"> </span><span class="sc0">i</span><span class="sc12">&gt;</span><span class="sc0">n</span><span class="sc12">+</span><span class="sc0">p</span><span class="sc24"> </span><span class="sc4">then</span><span class="sc24"> </span><span class="sc3">0</span><span class="sc24"> </span><span class="sc4">else</span><span class="sc24"> </span><span class="sc12">-</span><span class="sc0">s</span><span class="sc24">
    </span><span class="sc13">)</span><span class="sc0">,</span><span class="sc24">
    </span><span class="sc0">ndim</span><span class="sc12">:</span><span class="sc0">m,</span><span class="sc24">
    </span><span class="sc0">makebasis</span><span class="sc13">(</span><span class="sc0">var</span><span class="sc13">)</span><span class="sc0">,</span><span class="sc24">
    </span><span class="sc5">signature</span><span class="sc12">:</span><span class="sc4">makelist</span><span class="sc13">(</span><span class="sc0">a[i,i],</span><span class="sc24"> </span><span class="sc0">i,</span><span class="sc24"> </span><span class="sc0">m</span><span class="sc13">)</span><span class="sc0">,</span><span class="sc24">
    </span><span class="sc8">%iv</span><span class="sc12">:</span><span class="sc7">pscalar</span><span class="sc13">()</span><span class="sc0">,</span><span class="sc24">
    </span><span class="sc1">/*aform:genmatrix (a, m, m),*/</span><span class="sc24">
    </span><span class="sc8">%ivnorm</span><span class="sc12">:</span><span class="sc5">dotsimpc</span><span class="sc13">(</span><span class="sc8">%iv.%iv</span><span class="sc13">)</span><span class="sc0">,</span><span class="sc24">
    </span><span class="sc8">%elements</span><span class="sc12">:</span><span class="sc5">elements</span><span class="sc13">()</span><span class="sc0">,</span><span class="sc24">
    </span><span class="sc5">signature</span><span class="sc24">
</span><span class="sc13">)</span><span class="sc0">;</span><span class="sc24">


</span><span class="sc1">/*
sets the signature of the algebra
*/</span><span class="sc24">
</span><span class="sc0">set_signature</span><span class="sc13">(</span><span class="sc0">arr</span><span class="sc13">)</span><span class="sc12">:=</span><span class="sc4">block</span><span class="sc13">(</span><span class="sc24">
    </span><span class="sc4">if</span><span class="sc24"> </span><span class="sc4">not</span><span class="sc24"> </span><span class="sc5">listp</span><span class="sc13">(</span><span class="sc0">arr</span><span class="sc13">)</span><span class="sc24"> </span><span class="sc4">or</span><span class="sc24"> </span><span class="sc5">length</span><span class="sc13">(</span><span class="sc0">arr</span><span class="sc13">)</span><span class="sc12">#</span><span class="sc0">ndim</span><span class="sc24"> </span><span class="sc4">then</span><span class="sc24"> </span><span class="sc4">return</span><span class="sc13">(</span><span class="sc8">false</span><span class="sc13">)</span><span class="sc0">,</span><span class="sc24">
    </span><span class="sc5">signature</span><span class="sc12">:</span><span class="sc0">arr,</span><span class="sc24">
    </span><span class="sc8">%iv</span><span class="sc12">:</span><span class="sc7">pscalar</span><span class="sc13">()</span><span class="sc0">,</span><span class="sc24">
    </span><span class="sc8">%ivnorm</span><span class="sc12">:</span><span class="sc5">dotsimpc</span><span class="sc13">(</span><span class="sc8">%iv.%iv</span><span class="sc13">)</span><span class="sc0">,</span><span class="sc24">
    </span><span class="sc2">"aform"</span><span class="sc24">
</span><span class="sc13">)</span><span class="sc0">;</span><span class="sc24">

</span><span class="sc1">/*
toggles the signature of the algebra
*/</span><span class="sc24">
</span><span class="sc0">toggle_signature</span><span class="sc13">()</span><span class="sc12">:=</span><span class="sc4">block</span><span class="sc13">(</span><span class="sc24">
    </span><span class="sc5">signature</span><span class="sc12">:-</span><span class="sc5">signature,</span><span class="sc24">
    </span><span class="sc8">%iv</span><span class="sc12">:</span><span class="sc7">pscalar</span><span class="sc13">()</span><span class="sc0">,</span><span class="sc24">
    </span><span class="sc8">%ivnorm</span><span class="sc12">:</span><span class="sc5">dotsimpc</span><span class="sc13">(</span><span class="sc8">%iv.%iv</span><span class="sc13">)</span><span class="sc24">
</span><span class="sc13">)</span><span class="sc0">;</span><span class="sc24">

</span><span class="sc1">/*
constructs the complete basis of the algebra
- additional declarations added for compatibility with complex 
operations
*/</span><span class="sc24">
</span><span class="sc0">makebasis</span><span class="sc13">(</span><span class="sc0">var</span><span class="sc13">)</span><span class="sc12">:=</span><span class="sc24"> </span><span class="sc4">block</span><span class="sc13">(</span><span class="sc0">[</span><span class="sc24"> </span><span class="sc0">ee],</span><span class="sc24"> 
    </span><span class="sc0">asymbol</span><span class="sc12">:</span><span class="sc24"> </span><span class="sc0">var,</span><span class="sc24">
    </span><span class="sc0">ee</span><span class="sc12">:</span><span class="sc4">buildq</span><span class="sc13">(</span><span class="sc0">[asymbol],</span><span class="sc24"> </span><span class="sc4">declare</span><span class="sc13">(</span><span class="sc0">asymbol,</span><span class="sc24"> </span><span class="sc9">real</span><span class="sc13">))</span><span class="sc0">,</span><span class="sc24"> 
    </span><span class="sc4">ev</span><span class="sc13">(</span><span class="sc0">ee,nouns</span><span class="sc13">)</span><span class="sc0">,</span><span class="sc24">
    </span><span class="sc0">ee</span><span class="sc12">:</span><span class="sc4">buildq</span><span class="sc13">(</span><span class="sc0">[asymbol],</span><span class="sc24"> </span><span class="sc4">declare</span><span class="sc13">(</span><span class="sc0">asymbol,</span><span class="sc24"> </span><span class="sc9">mainvar</span><span class="sc13">))</span><span class="sc0">,</span><span class="sc24"> 
    </span><span class="sc4">ev</span><span class="sc13">(</span><span class="sc0">ee,nouns</span><span class="sc13">)</span><span class="sc0">,</span><span class="sc24">
    </span><span class="sc0">ee</span><span class="sc12">:</span><span class="sc4">buildq</span><span class="sc13">(</span><span class="sc0">[asymbol],</span><span class="sc24"> </span><span class="sc4">array</span><span class="sc13">(</span><span class="sc0">asymbol,</span><span class="sc24"> </span><span class="sc0">ndim</span><span class="sc13">)</span><span class="sc24">   </span><span class="sc13">)</span><span class="sc0">,</span><span class="sc24"> 
    </span><span class="sc4">ev</span><span class="sc13">(</span><span class="sc0">ee,nouns</span><span class="sc13">)</span><span class="sc24">
</span><span class="sc13">)</span><span class="sc0">;</span><span class="sc24">

</span><span class="sc1">/*
constructs the vectors of the algebra
*/</span><span class="sc24">
</span><span class="sc0">vectors</span><span class="sc13">()</span><span class="sc12">:=</span><span class="sc4">makelist</span><span class="sc13">(</span><span class="sc0">asymbol[i],</span><span class="sc24"> </span><span class="sc0">i,</span><span class="sc24"> </span><span class="sc0">1,</span><span class="sc24"> </span><span class="sc0">ndim</span><span class="sc13">)</span><span class="sc0">;</span><span class="sc24">

</span><span class="sc1">/*
constructs the  bi-vectors of the algebra
*/</span><span class="sc24">
</span><span class="sc0">bivectors</span><span class="sc13">()</span><span class="sc12">:=</span><span class="sc4">makelist</span><span class="sc13">(</span><span class="sc0">asymbol[i].asymbol[mod</span><span class="sc13">(</span><span class="sc0">i,ndim</span><span class="sc13">)</span><span class="sc12">+</span><span class="sc0">1],i,1,ndim</span><span class="sc13">)</span><span class="sc0">;</span><span class="sc24">

</span><span class="sc1">/*
constructs the pseudoscalar of the algebra
*/</span><span class="sc24">
</span><span class="sc7">pscalar</span><span class="sc13">(</span><span class="sc0">[k]</span><span class="sc13">)</span><span class="sc12">:=</span><span class="sc4">block</span><span class="sc13">(</span><span class="sc0">[s</span><span class="sc12">:</span><span class="sc0">1],</span><span class="sc24">
    </span><span class="sc4">if</span><span class="sc24"> </span><span class="sc4">not</span><span class="sc24"> </span><span class="sc5">emptyp</span><span class="sc13">(</span><span class="sc0">k</span><span class="sc13">)</span><span class="sc24"> </span><span class="sc4">then</span><span class="sc24"> </span><span class="sc0">k</span><span class="sc12">:</span><span class="sc5">min</span><span class="sc13">(</span><span class="sc0">k[1],</span><span class="sc24"> </span><span class="sc0">ndim</span><span class="sc13">)</span><span class="sc24"> </span><span class="sc4">else</span><span class="sc24"> </span><span class="sc0">k</span><span class="sc12">:</span><span class="sc24"> </span><span class="sc0">ndim,</span><span class="sc24"> 
    </span><span class="sc4">for</span><span class="sc24"> </span><span class="sc0">i</span><span class="sc12">:</span><span class="sc3">1</span><span class="sc24"> </span><span class="sc4">thru</span><span class="sc24"> </span><span class="sc0">k</span><span class="sc24"> </span><span class="sc4">do</span><span class="sc24"> </span><span class="sc0">s</span><span class="sc12">:</span><span class="sc0">s.asymbol[i],</span><span class="sc24">
    </span><span class="sc0">s</span><span class="sc24">
</span><span class="sc13">)</span><span class="sc0">;</span><span class="sc24">


</span><span class="sc1">/*
releases all rules 
*/</span><span class="sc24">
</span><span class="sc0">release</span><span class="sc13">()</span><span class="sc12">:=</span><span class="sc4">block</span><span class="sc13">(</span><span class="sc24">
    </span><span class="sc5">remrule</span><span class="sc24"> </span><span class="sc13">(</span><span class="sc2">"^^"</span><span class="sc0">,</span><span class="sc24">  </span><span class="sc9">all</span><span class="sc13">)</span><span class="sc0">,</span><span class="sc24">
    </span><span class="sc5">remrule</span><span class="sc24"> </span><span class="sc13">(</span><span class="sc2">"^"</span><span class="sc0">,</span><span class="sc24">  </span><span class="sc9">all</span><span class="sc13">)</span><span class="sc0">,</span><span class="sc24">
    </span><span class="sc5">remrule</span><span class="sc24"> </span><span class="sc13">(</span><span class="sc2">"."</span><span class="sc0">,</span><span class="sc24">  </span><span class="sc9">all</span><span class="sc13">)</span><span class="sc0">,</span><span class="sc24">
    </span><span class="sc5">remrule</span><span class="sc24"> </span><span class="sc13">(</span><span class="sc2">"*"</span><span class="sc0">,</span><span class="sc24">  </span><span class="sc9">all</span><span class="sc13">)</span><span class="sc0">,</span><span class="sc24">
    </span><span class="sc5">remrule</span><span class="sc24"> </span><span class="sc13">(</span><span class="sc2">"/"</span><span class="sc0">,</span><span class="sc24">  </span><span class="sc9">all</span><span class="sc13">)</span><span class="sc0">,</span><span class="sc24">
    </span><span class="sc5">rem</span><span class="sc13">(</span><span class="sc12">'</span><span class="sc0">clifford,</span><span class="sc12">'</span><span class="sc0">version</span><span class="sc13">)</span><span class="sc0">,</span><span class="sc24">
    </span><span class="sc5">rem</span><span class="sc13">(</span><span class="sc12">'</span><span class="sc0">clifford,</span><span class="sc12">'</span><span class="sc0">author</span><span class="sc13">)</span><span class="sc0">,</span><span class="sc24">
    </span><span class="sc5">rem</span><span class="sc13">(</span><span class="sc12">'</span><span class="sc0">clifford,</span><span class="sc12">'</span><span class="sc0">copyright</span><span class="sc13">)</span><span class="sc24">
</span><span class="sc13">)</span><span class="sc0">;</span><span class="sc24">


</span><span class="sc1">/*
counts occurences of a symbol in an expression

countsym(ab, sym):=block([sop, a, b, s:0, inflag:true ],
    if freeof(sym, ab) then return(0),
    if atom(ab) then  
        if sym=ab then return(1),
    if subvarp(ab) then  
        if sym=op(ab) then return(1),
 
    sop:inop(ab),    
    if _debug=true then display(sop),
    if member(sop, ["+", "*","."]) then (
        a: part(ab, 1),
        b: rest (ab, 1),
        if _debug=true then display(a,b),
        s:s+ countsym(a, sym)+ countsym(b, sym)
    ),
    s
);
*/</span><span class="sc24">
 
</span><span class="sc4">alias</span><span class="sc24"> </span><span class="sc13">(</span><span class="sc0">countsym,</span><span class="sc24"> </span><span class="sc0">countsymb</span><span class="sc13">)</span><span class="sc0">;</span><span class="sc24"> 

</span><span class="sc1">/*  
counts occurences of a symbol in an expression
experimental code*/</span><span class="sc24">
</span><span class="sc0">countsymb</span><span class="sc13">(</span><span class="sc0">ab,</span><span class="sc24"> </span><span class="sc0">sym</span><span class="sc13">)</span><span class="sc12">:=</span><span class="sc4">block</span><span class="sc13">(</span><span class="sc0">[inflag</span><span class="sc12">:</span><span class="sc8">true</span><span class="sc24"> </span><span class="sc0">],</span><span class="sc24">
    </span><span class="sc4">if</span><span class="sc24"> </span><span class="sc5">freeof</span><span class="sc13">(</span><span class="sc0">sym,</span><span class="sc24"> </span><span class="sc0">ab</span><span class="sc13">)</span><span class="sc24"> </span><span class="sc4">then</span><span class="sc24"> </span><span class="sc4">return</span><span class="sc13">(</span><span class="sc3">0</span><span class="sc13">)</span><span class="sc0">,</span><span class="sc24">
    </span><span class="sc4">if</span><span class="sc24"> </span><span class="sc5">atom</span><span class="sc13">(</span><span class="sc0">ab</span><span class="sc13">)</span><span class="sc24"> </span><span class="sc4">then</span><span class="sc24">  
        </span><span class="sc4">if</span><span class="sc24"> </span><span class="sc0">sym</span><span class="sc12">=</span><span class="sc0">ab</span><span class="sc24"> </span><span class="sc4">then</span><span class="sc24"> </span><span class="sc4">return</span><span class="sc13">(</span><span class="sc3">1</span><span class="sc13">)</span><span class="sc0">,</span><span class="sc24">
    </span><span class="sc4">if</span><span class="sc24"> </span><span class="sc5">subvarp</span><span class="sc13">(</span><span class="sc0">ab</span><span class="sc13">)</span><span class="sc24"> </span><span class="sc4">then</span><span class="sc24">  
        </span><span class="sc4">if</span><span class="sc24"> </span><span class="sc0">sym</span><span class="sc12">=</span><span class="sc5">op</span><span class="sc13">(</span><span class="sc0">ab</span><span class="sc13">)</span><span class="sc24"> </span><span class="sc4">then</span><span class="sc24"> </span><span class="sc4">return</span><span class="sc13">(</span><span class="sc3">1</span><span class="sc13">)</span><span class="sc0">,</span><span class="sc24">
    </span><span class="sc5">xreduce</span><span class="sc13">(</span><span class="sc2">"+"</span><span class="sc0">,</span><span class="sc24"> </span><span class="sc5">maplist</span><span class="sc13">(</span><span class="sc24"> </span><span class="sc4">lambda</span><span class="sc13">(</span><span class="sc0">[i],</span><span class="sc24"> </span><span class="sc0">countsymb</span><span class="sc13">(</span><span class="sc0">i,</span><span class="sc24"> </span><span class="sc0">sym</span><span class="sc13">))</span><span class="sc0">,</span><span class="sc24"> </span><span class="sc0">ab</span><span class="sc13">))</span><span class="sc24">
 </span><span class="sc13">)</span><span class="sc0">;</span><span class="sc24">

</span><span class="sc1">/*
grade decomposition of expressions
 */</span><span class="sc24">
</span><span class="sc0">grade</span><span class="sc13">(</span><span class="sc5">expr,</span><span class="sc24"> </span><span class="sc0">[gradexpand]</span><span class="sc13">)</span><span class="sc12">:=</span><span class="sc4">block</span><span class="sc13">(</span><span class="sc0">[cc,</span><span class="sc24"> </span><span class="sc0">sop,</span><span class="sc24"> </span><span class="sc0">k</span><span class="sc24"> </span><span class="sc0">],</span><span class="sc24">
    </span><span class="sc4">local</span><span class="sc13">(</span><span class="sc0">cc</span><span class="sc13">)</span><span class="sc0">,</span><span class="sc24">
    </span><span class="sc4">if</span><span class="sc24"> </span><span class="sc0">ndim</span><span class="sc12">=</span><span class="sc3">0</span><span class="sc24"> </span><span class="sc4">then</span><span class="sc24"> </span><span class="sc4">error</span><span class="sc13">(</span><span class="sc2">"ndim =0"</span><span class="sc13">)</span><span class="sc0">,</span><span class="sc24">
    </span><span class="sc4">array</span><span class="sc13">(</span><span class="sc0">cc,</span><span class="sc24"> </span><span class="sc5">fixnum,</span><span class="sc24"> </span><span class="sc0">ndim</span><span class="sc13">)</span><span class="sc0">,</span><span class="sc24">
    
    </span><span class="sc4">if</span><span class="sc24"> </span><span class="sc5">emptyp</span><span class="sc13">(</span><span class="sc0">gradexpand</span><span class="sc13">)</span><span class="sc24"> </span><span class="sc4">then</span><span class="sc24"> </span><span class="sc0">gradexpand</span><span class="sc12">:</span><span class="sc8">true</span><span class="sc24">
    </span><span class="sc4">else</span><span class="sc24"> </span><span class="sc0">gradexpand</span><span class="sc12">:</span><span class="sc0">gradexpand[1],</span><span class="sc24">
    
    </span><span class="sc4">if</span><span class="sc24"> </span><span class="sc4">not</span><span class="sc24"> </span><span class="sc5">mapatom</span><span class="sc13">(</span><span class="sc5">expr</span><span class="sc13">)</span><span class="sc24"> </span><span class="sc4">then</span><span class="sc24"> 
    </span><span class="sc4">if</span><span class="sc24"> </span><span class="sc0">gradexpand</span><span class="sc24"> </span><span class="sc4">then</span><span class="sc24"> </span><span class="sc5">expr</span><span class="sc12">:</span><span class="sc5">expand</span><span class="sc13">(</span><span class="sc5">expr</span><span class="sc13">)</span><span class="sc0">,</span><span class="sc24">
    
    </span><span class="sc0">sop</span><span class="sc12">:</span><span class="sc24"> </span><span class="sc5">inop</span><span class="sc13">(</span><span class="sc5">expr</span><span class="sc13">)</span><span class="sc0">,</span><span class="sc24">
    </span><span class="sc4">if</span><span class="sc24"> </span><span class="sc0">sop</span><span class="sc12">=</span><span class="sc2">"+"</span><span class="sc24"> </span><span class="sc4">then</span><span class="sc24"> </span><span class="sc13">(</span><span class="sc24">
        </span><span class="sc4">for</span><span class="sc24"> </span><span class="sc0">v</span><span class="sc24"> </span><span class="sc4">in</span><span class="sc24"> </span><span class="sc5">expr</span><span class="sc24"> </span><span class="sc4">do</span><span class="sc24"> </span><span class="sc13">(</span><span class="sc24">
            </span><span class="sc0">k</span><span class="sc12">:</span><span class="sc0">countsym</span><span class="sc13">(</span><span class="sc0">v,</span><span class="sc24"> </span><span class="sc0">asymbol</span><span class="sc13">)</span><span class="sc0">,</span><span class="sc24">
            </span><span class="sc4">if</span><span class="sc24"> </span><span class="sc0">_debug</span><span class="sc12">=</span><span class="sc8">true</span><span class="sc24"> </span><span class="sc4">then</span><span class="sc24"> </span><span class="sc5">display</span><span class="sc13">(</span><span class="sc0">k,v</span><span class="sc13">)</span><span class="sc0">,</span><span class="sc24">
            </span><span class="sc0">cc[k]</span><span class="sc12">:</span><span class="sc0">cc[k]</span><span class="sc24"> </span><span class="sc12">+</span><span class="sc0">v</span><span class="sc24"> 
        </span><span class="sc13">)</span><span class="sc24">
    </span><span class="sc13">)</span><span class="sc4">else</span><span class="sc24"> </span><span class="sc13">(</span><span class="sc24"> </span><span class="sc2">"simple expression"</span><span class="sc0">,</span><span class="sc24">
        </span><span class="sc0">k</span><span class="sc12">:</span><span class="sc0">countsym</span><span class="sc13">(</span><span class="sc5">expr,</span><span class="sc24"> </span><span class="sc0">asymbol</span><span class="sc13">)</span><span class="sc0">,</span><span class="sc24">
        </span><span class="sc0">cc[k]</span><span class="sc12">:</span><span class="sc0">cc[k]</span><span class="sc24"> </span><span class="sc12">+</span><span class="sc5">expr</span><span class="sc24"> 
    </span><span class="sc13">)</span><span class="sc0">,</span><span class="sc24">
    </span><span class="sc5">listarray</span><span class="sc13">(</span><span class="sc0">cc</span><span class="sc13">)</span><span class="sc24">
</span><span class="sc13">)</span><span class="sc0">;</span><span class="sc24">

</span><span class="sc1">/*
grade decomposition of expressions
factors and produces a matrix
 */</span><span class="sc24">
</span><span class="sc5">matrixgrade</span><span class="sc13">(</span><span class="sc5">expr</span><span class="sc13">)</span><span class="sc12">:=</span><span class="sc4">block</span><span class="sc13">(</span><span class="sc0">[ret],</span><span class="sc24"> 
    </span><span class="sc0">ret</span><span class="sc12">:</span><span class="sc0">grade</span><span class="sc13">(</span><span class="sc5">expr</span><span class="sc13">)</span><span class="sc0">,</span><span class="sc24">
    </span><span class="sc0">ret</span><span class="sc12">:</span><span class="sc5">maplist</span><span class="sc24"> </span><span class="sc13">(</span><span class="sc24"> </span><span class="sc4">lambda</span><span class="sc13">(</span><span class="sc0">[u],</span><span class="sc24"> </span><span class="sc5">factorby</span><span class="sc13">(</span><span class="sc24"> </span><span class="sc0">u,</span><span class="sc24"> </span><span class="sc8">%elements</span><span class="sc13">))</span><span class="sc24"> </span><span class="sc0">,</span><span class="sc24"> </span><span class="sc0">ret</span><span class="sc13">)</span><span class="sc0">,</span><span class="sc24">
    </span><span class="sc5">transpose</span><span class="sc13">(</span><span class="sc5">matrix</span><span class="sc13">(</span><span class="sc0">ret</span><span class="sc13">))</span><span class="sc24">
</span><span class="sc13">)</span><span class="sc0">;</span><span class="sc24">

</span><span class="sc1">/*
maximal grade of an expression
*/</span><span class="sc24">
</span><span class="sc5">maxgrade</span><span class="sc13">(</span><span class="sc5">expr</span><span class="sc13">)</span><span class="sc12">:=</span><span class="sc4">block</span><span class="sc13">(</span><span class="sc0">[lst</span><span class="sc12">:</span><span class="sc0">[]</span><span class="sc24"> </span><span class="sc0">],</span><span class="sc24">
    </span><span class="sc4">if</span><span class="sc24"> </span><span class="sc5">freeof</span><span class="sc24"> </span><span class="sc13">(</span><span class="sc0">asymbol,</span><span class="sc24"> </span><span class="sc5">expr</span><span class="sc13">)</span><span class="sc24"> </span><span class="sc4">then</span><span class="sc24"> </span><span class="sc4">return</span><span class="sc24"> </span><span class="sc13">(</span><span class="sc3">0</span><span class="sc13">)</span><span class="sc0">,</span><span class="sc24">
    </span><span class="sc4">if</span><span class="sc24"> </span><span class="sc5">inop</span><span class="sc13">(</span><span class="sc5">expr</span><span class="sc13">)</span><span class="sc12">=</span><span class="sc2">"+"</span><span class="sc24"> </span><span class="sc4">then</span><span class="sc24"> </span><span class="sc13">(</span><span class="sc24">
        </span><span class="sc0">lst</span><span class="sc12">:</span><span class="sc5">maplist</span><span class="sc13">(</span><span class="sc5">maxgrade,</span><span class="sc24"> </span><span class="sc5">expr</span><span class="sc13">)</span><span class="sc0">,</span><span class="sc24">
        </span><span class="sc5">lmax</span><span class="sc13">(</span><span class="sc0">lst</span><span class="sc13">)</span><span class="sc24">
    </span><span class="sc13">)</span><span class="sc24"> </span><span class="sc4">else</span><span class="sc24"> 
        </span><span class="sc0">countsymb</span><span class="sc13">(</span><span class="sc5">expr,</span><span class="sc24"> </span><span class="sc0">asymbol</span><span class="sc13">)</span><span class="sc24">
</span><span class="sc13">)</span><span class="sc0">;</span><span class="sc24">

</span><span class="sc1">/*
 Partial factoring by subexpression
*/</span><span class="sc24">
</span><span class="sc5">factorby</span><span class="sc13">(</span><span class="sc5">expr,</span><span class="sc24"> </span><span class="sc0">z</span><span class="sc13">)</span><span class="sc12">:=</span><span class="sc4">block</span><span class="sc13">(</span><span class="sc0">[quot,</span><span class="sc24"> </span><span class="sc0">res,</span><span class="sc24"> </span><span class="sc0">ret,</span><span class="sc24"> </span><span class="sc0">ee,</span><span class="sc24"> </span><span class="sc0">u,</span><span class="sc24"> </span><span class="sc0">n,</span><span class="sc24"> </span><span class="sc0">sop,</span><span class="sc24"> </span><span class="sc8">%qq,</span><span class="sc24"> </span><span class="sc9">radsubstflag</span><span class="sc12">:</span><span class="sc8">true</span><span class="sc24"> </span><span class="sc0">],</span><span class="sc24">
    </span><span class="sc4">if</span><span class="sc24"> </span><span class="sc5">emptyp</span><span class="sc13">(</span><span class="sc0">z</span><span class="sc13">)</span><span class="sc24"> </span><span class="sc4">then</span><span class="sc24"> </span><span class="sc4">return</span><span class="sc24"> </span><span class="sc13">(</span><span class="sc5">expr</span><span class="sc13">)</span><span class="sc0">,</span><span class="sc24">
    </span><span class="sc4">if</span><span class="sc24"> </span><span class="sc5">atom</span><span class="sc13">(</span><span class="sc5">expr</span><span class="sc13">)</span><span class="sc24"> </span><span class="sc4">then</span><span class="sc24"> </span><span class="sc4">return</span><span class="sc24"> </span><span class="sc13">(</span><span class="sc5">expr</span><span class="sc13">)</span><span class="sc0">,</span><span class="sc24">
    </span><span class="sc4">if</span><span class="sc24"> </span><span class="sc5">matrixp</span><span class="sc13">(</span><span class="sc5">expr</span><span class="sc13">)</span><span class="sc24"> </span><span class="sc4">then</span><span class="sc24"> 
        </span><span class="sc4">return</span><span class="sc13">(</span><span class="sc5">matrixmap</span><span class="sc13">(</span><span class="sc4">lambda</span><span class="sc13">(</span><span class="sc0">[u],</span><span class="sc24"> </span><span class="sc5">factorby</span><span class="sc13">(</span><span class="sc0">u,</span><span class="sc24"> </span><span class="sc0">z</span><span class="sc13">))</span><span class="sc0">,</span><span class="sc24"> </span><span class="sc5">expr</span><span class="sc13">))</span><span class="sc0">,</span><span class="sc24">
    </span><span class="sc4">if</span><span class="sc24"> </span><span class="sc5">listp</span><span class="sc13">(</span><span class="sc5">expr</span><span class="sc13">)</span><span class="sc24"> </span><span class="sc4">then</span><span class="sc24"> 
        </span><span class="sc0">ret</span><span class="sc12">:</span><span class="sc24"> </span><span class="sc5">maplist</span><span class="sc13">(</span><span class="sc4">lambda</span><span class="sc13">(</span><span class="sc0">[u],</span><span class="sc24"> </span><span class="sc5">factorby</span><span class="sc13">(</span><span class="sc0">u,</span><span class="sc24"> </span><span class="sc0">z</span><span class="sc13">))</span><span class="sc0">,</span><span class="sc24"> </span><span class="sc5">expr</span><span class="sc13">)</span><span class="sc24">
    </span><span class="sc4">else</span><span class="sc24"> </span><span class="sc13">(</span><span class="sc24">
        </span><span class="sc4">if</span><span class="sc24"> </span><span class="sc5">listp</span><span class="sc13">(</span><span class="sc0">z</span><span class="sc13">)</span><span class="sc24"> </span><span class="sc4">then</span><span class="sc24"> </span><span class="sc0">z</span><span class="sc12">:</span><span class="sc5">flatten</span><span class="sc13">(</span><span class="sc0">z</span><span class="sc13">)</span><span class="sc24">
        </span><span class="sc4">else</span><span class="sc24"> </span><span class="sc0">z</span><span class="sc12">:</span><span class="sc0">[z],</span><span class="sc24"> 
        </span><span class="sc0">sop</span><span class="sc12">:</span><span class="sc5">op</span><span class="sc13">(</span><span class="sc5">expr</span><span class="sc13">)</span><span class="sc0">,</span><span class="sc24">
        </span><span class="sc4">if</span><span class="sc24"> </span><span class="sc0">_debug</span><span class="sc12">=</span><span class="sc8">true</span><span class="sc24"> </span><span class="sc4">then</span><span class="sc24"> </span><span class="sc5">display</span><span class="sc13">(</span><span class="sc5">expr,</span><span class="sc24"> </span><span class="sc0">sop</span><span class="sc24"> </span><span class="sc13">)</span><span class="sc0">,</span><span class="sc24">
        </span><span class="sc4">if</span><span class="sc24"> </span><span class="sc0">sop</span><span class="sc12">=</span><span class="sc2">"*"</span><span class="sc24"> </span><span class="sc4">then</span><span class="sc24"> 
            </span><span class="sc0">ret</span><span class="sc12">:</span><span class="sc5">map</span><span class="sc13">(</span><span class="sc24"> </span><span class="sc4">lambda</span><span class="sc13">(</span><span class="sc0">[u],</span><span class="sc24"> </span><span class="sc5">factorby</span><span class="sc13">(</span><span class="sc0">u,</span><span class="sc24"> </span><span class="sc0">z</span><span class="sc13">)</span><span class="sc24"> </span><span class="sc13">)</span><span class="sc0">,</span><span class="sc24"> </span><span class="sc5">expr</span><span class="sc13">)</span><span class="sc24">
        </span><span class="sc4">else</span><span class="sc24"> </span><span class="sc4">if</span><span class="sc24"> </span><span class="sc0">sop</span><span class="sc12">=</span><span class="sc2">"/"</span><span class="sc24"> </span><span class="sc4">then</span><span class="sc24"> 
            </span><span class="sc0">ret</span><span class="sc12">:</span><span class="sc5">factorby</span><span class="sc13">(</span><span class="sc5">num</span><span class="sc13">(</span><span class="sc5">expr</span><span class="sc13">)</span><span class="sc0">,</span><span class="sc24"> </span><span class="sc0">z</span><span class="sc13">)</span><span class="sc12">/</span><span class="sc5">factorby</span><span class="sc13">(</span><span class="sc5">denom</span><span class="sc13">(</span><span class="sc5">expr</span><span class="sc13">)</span><span class="sc0">,</span><span class="sc24"> </span><span class="sc0">z</span><span class="sc13">)</span><span class="sc24">
        </span><span class="sc4">else</span><span class="sc24">    </span><span class="sc4">if</span><span class="sc24"> </span><span class="sc0">sop</span><span class="sc12">=</span><span class="sc2">"^"</span><span class="sc24"> </span><span class="sc4">then</span><span class="sc24"> </span><span class="sc13">(</span><span class="sc24">
            </span><span class="sc0">[ee,</span><span class="sc24"> </span><span class="sc0">n]</span><span class="sc12">:</span><span class="sc4">args</span><span class="sc13">(</span><span class="sc5">expr</span><span class="sc13">)</span><span class="sc0">,</span><span class="sc24">
            </span><span class="sc0">ret</span><span class="sc12">:</span><span class="sc5">factorby</span><span class="sc13">(</span><span class="sc0">ee,</span><span class="sc24"> </span><span class="sc0">z</span><span class="sc13">)</span><span class="sc0">,</span><span class="sc24">
            </span><span class="sc0">ret</span><span class="sc12">:</span><span class="sc0">ret</span><span class="sc12">^</span><span class="sc0">n</span><span class="sc24">
        </span><span class="sc13">)</span><span class="sc24"> </span><span class="sc4">else</span><span class="sc24"> </span><span class="sc13">(</span><span class="sc24">             
            </span><span class="sc4">if</span><span class="sc24"> </span><span class="sc5">inop</span><span class="sc13">(</span><span class="sc0">z[1]</span><span class="sc13">)</span><span class="sc24"> </span><span class="sc12">=</span><span class="sc24"> </span><span class="sc2">"^"</span><span class="sc24"> </span><span class="sc4">then</span><span class="sc24"> </span><span class="sc13">(</span><span class="sc24">
                </span><span class="sc0">[ee,</span><span class="sc24"> </span><span class="sc0">n]</span><span class="sc12">:</span><span class="sc5">inargs</span><span class="sc13">(</span><span class="sc0">z[1]</span><span class="sc13">)</span><span class="sc0">,</span><span class="sc24">
                </span><span class="sc5">assume</span><span class="sc13">(</span><span class="sc8">%qq</span><span class="sc12">&gt;</span><span class="sc3">0</span><span class="sc13">)</span><span class="sc0">,</span><span class="sc24">
                </span><span class="sc5">expr</span><span class="sc12">:</span><span class="sc5">ratsubst</span><span class="sc13">(</span><span class="sc8">%qq,</span><span class="sc24"> </span><span class="sc0">ee,</span><span class="sc24"> </span><span class="sc5">expr</span><span class="sc13">)</span><span class="sc0">,</span><span class="sc24">
                </span><span class="sc5">expr</span><span class="sc12">:</span><span class="sc5">ratsubst</span><span class="sc13">(</span><span class="sc8">%qq</span><span class="sc12">^</span><span class="sc13">(</span><span class="sc3">1</span><span class="sc12">/</span><span class="sc0">n</span><span class="sc13">)</span><span class="sc0">,</span><span class="sc24"> </span><span class="sc8">%qq,</span><span class="sc24"> </span><span class="sc5">expr</span><span class="sc13">)</span><span class="sc0">,</span><span class="sc24">
                </span><span class="sc1">/*display(ee, n),*/</span><span class="sc24">
                </span><span class="sc0">[quot,</span><span class="sc24"> </span><span class="sc0">res]</span><span class="sc12">:</span><span class="sc5">divide</span><span class="sc13">(</span><span class="sc5">expr,</span><span class="sc24"> </span><span class="sc8">%qq</span><span class="sc13">)</span><span class="sc0">,</span><span class="sc24">
                </span><span class="sc1">/*display(quot, res, expr),*/</span><span class="sc24">
                </span><span class="sc0">res</span><span class="sc12">:</span><span class="sc5">subst</span><span class="sc13">(</span><span class="sc0">z[1],</span><span class="sc24"> </span><span class="sc8">%qq,</span><span class="sc24"> </span><span class="sc0">res</span><span class="sc13">)</span><span class="sc0">,</span><span class="sc24">
                </span><span class="sc0">quot</span><span class="sc12">:</span><span class="sc5">subst</span><span class="sc13">(</span><span class="sc0">z[1],</span><span class="sc24"> </span><span class="sc8">%qq,</span><span class="sc24"> </span><span class="sc0">quot</span><span class="sc13">)</span><span class="sc0">,</span><span class="sc24">
                </span><span class="sc0">quot</span><span class="sc12">:</span><span class="sc5">radcan</span><span class="sc13">(</span><span class="sc0">quot</span><span class="sc13">)</span><span class="sc24">
            </span><span class="sc13">)</span><span class="sc24"> </span><span class="sc4">else</span><span class="sc24">
                </span><span class="sc0">[quot,</span><span class="sc24"> </span><span class="sc0">res]</span><span class="sc12">:</span><span class="sc5">divide</span><span class="sc13">(</span><span class="sc5">expr,</span><span class="sc24"> </span><span class="sc0">z[1]</span><span class="sc13">)</span><span class="sc0">,</span><span class="sc24">
            </span><span class="sc4">if</span><span class="sc24"> </span><span class="sc5">length</span><span class="sc13">(</span><span class="sc0">z</span><span class="sc13">)</span><span class="sc12">&gt;</span><span class="sc3">1</span><span class="sc24"> </span><span class="sc4">then</span><span class="sc24">
                </span><span class="sc0">res</span><span class="sc12">:</span><span class="sc5">factorby</span><span class="sc13">(</span><span class="sc0">res,</span><span class="sc24"> </span><span class="sc5">rest</span><span class="sc13">(</span><span class="sc0">z</span><span class="sc13">))</span><span class="sc0">,</span><span class="sc24">
                </span><span class="sc4">if</span><span class="sc24"> </span><span class="sc0">res</span><span class="sc12">#</span><span class="sc3">0</span><span class="sc24"> </span><span class="sc4">then</span><span class="sc24">
                    </span><span class="sc0">ret</span><span class="sc12">:</span><span class="sc5">factor</span><span class="sc13">(</span><span class="sc0">quot</span><span class="sc13">)</span><span class="sc12">*</span><span class="sc0">z[1]</span><span class="sc12">+</span><span class="sc0">res</span><span class="sc24">
                </span><span class="sc4">else</span><span class="sc24"> </span><span class="sc0">ret</span><span class="sc12">:</span><span class="sc0">quot</span><span class="sc12">*</span><span class="sc0">z[1]</span><span class="sc12">+</span><span class="sc0">res</span><span class="sc24">
        </span><span class="sc13">)</span><span class="sc24">
    </span><span class="sc13">)</span><span class="sc0">,</span><span class="sc24">
    </span><span class="sc0">ret</span><span class="sc24">
</span><span class="sc13">)</span><span class="sc0">;</span><span class="sc24">

</span><span class="sc4">declare</span><span class="sc24"> </span><span class="sc13">(</span><span class="sc0">quotsimp,</span><span class="sc24"> </span><span class="sc7">evfun</span><span class="sc13">)</span><span class="sc0">;</span><span class="sc24">
</span><span class="sc0">quotsimp</span><span class="sc13">(</span><span class="sc5">expr</span><span class="sc13">)</span><span class="sc12">:=</span><span class="sc4">block</span><span class="sc13">(</span><span class="sc0">[quot,</span><span class="sc24"> </span><span class="sc0">res,</span><span class="sc24"> </span><span class="sc0">dd</span><span class="sc12">:</span><span class="sc5">denom</span><span class="sc13">(</span><span class="sc5">expr</span><span class="sc13">)</span><span class="sc24"> </span><span class="sc0">],</span><span class="sc24">
    </span><span class="sc0">[quot,</span><span class="sc24"> </span><span class="sc0">res]</span><span class="sc12">:</span><span class="sc5">divide</span><span class="sc13">(</span><span class="sc5">expr,</span><span class="sc24"> </span><span class="sc0">dd</span><span class="sc13">)</span><span class="sc0">,</span><span class="sc24">
    </span><span class="sc5">factor</span><span class="sc13">(</span><span class="sc0">quot</span><span class="sc13">)</span><span class="sc12">*</span><span class="sc5">factor</span><span class="sc13">(</span><span class="sc0">dd</span><span class="sc13">)</span><span class="sc12">+</span><span class="sc5">factor</span><span class="sc13">(</span><span class="sc0">res</span><span class="sc13">)</span><span class="sc24">
</span><span class="sc13">)</span><span class="sc0">;</span><span class="sc24">


</span><span class="sc0">simpfact</span><span class="sc13">(</span><span class="sc5">expr,</span><span class="sc24"> </span><span class="sc0">z</span><span class="sc13">)</span><span class="sc12">:=</span><span class="sc4">block</span><span class="sc13">(</span><span class="sc0">[ret</span><span class="sc12">:</span><span class="sc5">expr,</span><span class="sc24"> </span><span class="sc0">u],</span><span class="sc24">
    </span><span class="sc0">ret</span><span class="sc12">:</span><span class="sc5">factor</span><span class="sc13">(</span><span class="sc0">ret</span><span class="sc13">)</span><span class="sc0">,</span><span class="sc24">
    </span><span class="sc4">if</span><span class="sc24"> </span><span class="sc4">not</span><span class="sc24"> </span><span class="sc5">mapatom</span><span class="sc13">(</span><span class="sc0">ret</span><span class="sc13">)</span><span class="sc24"> </span><span class="sc4">then</span><span class="sc24">
    </span><span class="sc5">map</span><span class="sc13">(</span><span class="sc4">lambda</span><span class="sc13">(</span><span class="sc0">[u],</span><span class="sc24"> </span><span class="sc5">factorby</span><span class="sc13">(</span><span class="sc0">u,</span><span class="sc24"> </span><span class="sc0">z</span><span class="sc13">))</span><span class="sc0">,</span><span class="sc24"> </span><span class="sc0">ret</span><span class="sc13">)</span><span class="sc24"> </span><span class="sc4">else</span><span class="sc24"> </span><span class="sc0">ret</span><span class="sc24">
</span><span class="sc13">)</span><span class="sc0">;</span><span class="sc24">


</span><span class="sc0">listofclivars</span><span class="sc13">(</span><span class="sc5">expr</span><span class="sc13">)</span><span class="sc12">:=</span><span class="sc13">(</span><span class="sc24">
    </span><span class="sc4">if</span><span class="sc24"> </span><span class="sc5">length</span><span class="sc13">(</span><span class="sc8">%elements</span><span class="sc13">)</span><span class="sc12">=</span><span class="sc3">1</span><span class="sc24"> </span><span class="sc4">then</span><span class="sc24"> </span><span class="sc8">%elements</span><span class="sc12">:</span><span class="sc5">elements</span><span class="sc13">()</span><span class="sc0">,</span><span class="sc24">
    </span><span class="sc5">sublist</span><span class="sc13">(</span><span class="sc8">%elements,</span><span class="sc24"> </span><span class="sc4">lambda</span><span class="sc24"> </span><span class="sc13">(</span><span class="sc0">[u],</span><span class="sc24"> </span><span class="sc4">not</span><span class="sc24"> </span><span class="sc5">freeof</span><span class="sc13">(</span><span class="sc0">u,</span><span class="sc24"> </span><span class="sc5">expr</span><span class="sc13">)))</span><span class="sc24">
</span><span class="sc13">)</span><span class="sc0">;</span><span class="sc24">

</span><span class="sc4">declare</span><span class="sc24"> </span><span class="sc13">(</span><span class="sc0">clifact,</span><span class="sc24"> </span><span class="sc7">evfun</span><span class="sc13">)</span><span class="sc0">;</span><span class="sc24">
</span><span class="sc0">clifact</span><span class="sc13">(</span><span class="sc5">expr</span><span class="sc13">)</span><span class="sc12">:=</span><span class="sc4">block</span><span class="sc13">(</span><span class="sc0">[lcv</span><span class="sc12">:</span><span class="sc0">[],</span><span class="sc24"> </span><span class="sc0">ret</span><span class="sc12">:</span><span class="sc24"> </span><span class="sc5">expr],</span><span class="sc24">
    </span><span class="sc4">if</span><span class="sc24"> </span><span class="sc4">not</span><span class="sc24"> </span><span class="sc5">mapatom</span><span class="sc13">(</span><span class="sc5">expr</span><span class="sc13">)</span><span class="sc24"> </span><span class="sc4">then</span><span class="sc24"> </span><span class="sc13">(</span><span class="sc24">
        </span><span class="sc5">lcv</span><span class="sc12">:</span><span class="sc24"> </span><span class="sc0">listofclivars</span><span class="sc13">(</span><span class="sc5">expr</span><span class="sc13">)</span><span class="sc0">,</span><span class="sc24">
        </span><span class="sc4">if</span><span class="sc24"> </span><span class="sc4">not</span><span class="sc24"> </span><span class="sc5">emptyp</span><span class="sc13">(</span><span class="sc5">lcv</span><span class="sc13">)</span><span class="sc24"> </span><span class="sc4">then</span><span class="sc24">
            </span><span class="sc0">ret</span><span class="sc12">:</span><span class="sc5">factorby</span><span class="sc13">(</span><span class="sc5">expr,</span><span class="sc24"> </span><span class="sc5">lcv</span><span class="sc13">)</span><span class="sc24"> 
    </span><span class="sc13">)</span><span class="sc0">,</span><span class="sc24">
    </span><span class="sc0">ret</span><span class="sc24">
</span><span class="sc13">)</span><span class="sc0">;</span><span class="sc24">

</span><span class="sc4">alias</span><span class="sc13">(</span><span class="sc0">clicoeff2,</span><span class="sc24"> </span><span class="sc0">clicoeff</span><span class="sc13">)</span><span class="sc0">;</span><span class="sc24"> 
</span><span class="sc1">/* 
computes the element decomposition
clicoeff2 depreciated
*/</span><span class="sc24">
</span><span class="sc0">clicoeff</span><span class="sc13">(</span><span class="sc5">expr,</span><span class="sc24"> </span><span class="sc0">smat</span><span class="sc13">)</span><span class="sc12">:=</span><span class="sc4">block</span><span class="sc13">(</span><span class="sc0">[u,</span><span class="sc24"> </span><span class="sc0">ee</span><span class="sc12">:</span><span class="sc0">[],</span><span class="sc24"> </span><span class="sc0">z</span><span class="sc12">:</span><span class="sc0">[],</span><span class="sc24"> </span><span class="sc0">cc</span><span class="sc12">:</span><span class="sc0">[],</span><span class="sc24"> </span><span class="sc5">qq</span><span class="sc24"> </span><span class="sc0">],</span><span class="sc24">
    </span><span class="sc4">if</span><span class="sc24"> </span><span class="sc5">length</span><span class="sc13">(</span><span class="sc8">%elements</span><span class="sc13">)</span><span class="sc12">=</span><span class="sc3">1</span><span class="sc24"> </span><span class="sc4">then</span><span class="sc24"> </span><span class="sc8">%elements</span><span class="sc12">:</span><span class="sc5">elements</span><span class="sc13">()</span><span class="sc0">,</span><span class="sc24">
    </span><span class="sc0">cc</span><span class="sc12">:</span><span class="sc5">map</span><span class="sc13">(</span><span class="sc4">lambda</span><span class="sc13">(</span><span class="sc0">[u],</span><span class="sc24"> </span><span class="sc5">coeff</span><span class="sc13">(</span><span class="sc5">expr,</span><span class="sc24"> </span><span class="sc0">u</span><span class="sc13">))</span><span class="sc0">,</span><span class="sc24"> </span><span class="sc8">%elements</span><span class="sc13">)</span><span class="sc0">,</span><span class="sc24">
    </span><span class="sc0">z</span><span class="sc12">:</span><span class="sc5">sublist_indices</span><span class="sc13">(</span><span class="sc0">cc,</span><span class="sc24"> </span><span class="sc4">lambda</span><span class="sc13">(</span><span class="sc0">[u],</span><span class="sc24"> </span><span class="sc0">u</span><span class="sc12">#</span><span class="sc3">0</span><span class="sc13">))</span><span class="sc0">,</span><span class="sc24">
    </span><span class="sc0">ee</span><span class="sc12">:</span><span class="sc4">makelist</span><span class="sc13">(</span><span class="sc8">%elements[i],</span><span class="sc24"> </span><span class="sc0">i,</span><span class="sc24"> </span><span class="sc0">z</span><span class="sc13">)</span><span class="sc0">,</span><span class="sc24">
    </span><span class="sc5">qq</span><span class="sc12">:</span><span class="sc5">expand</span><span class="sc13">(</span><span class="sc5">expr</span><span class="sc12">-</span><span class="sc5">substinpart</span><span class="sc13">(</span><span class="sc2">"+"</span><span class="sc0">,</span><span class="sc24"> </span><span class="sc4">makelist</span><span class="sc24"> </span><span class="sc13">(</span><span class="sc0">cc[i]</span><span class="sc12">*</span><span class="sc8">%elements[i],</span><span class="sc24"> </span><span class="sc0">i,</span><span class="sc24"> </span><span class="sc0">z</span><span class="sc13">)</span><span class="sc0">,</span><span class="sc24"> </span><span class="sc3">0</span><span class="sc13">))</span><span class="sc0">,</span><span class="sc24">
    </span><span class="sc0">cc</span><span class="sc12">:</span><span class="sc4">makelist</span><span class="sc13">(</span><span class="sc0">cc[i],</span><span class="sc24"> </span><span class="sc0">i,</span><span class="sc24"> </span><span class="sc0">z</span><span class="sc13">)</span><span class="sc0">,</span><span class="sc24">
    </span><span class="sc4">if</span><span class="sc24"> </span><span class="sc5">qq</span><span class="sc12">#</span><span class="sc3">0</span><span class="sc24"> </span><span class="sc4">then</span><span class="sc24">  </span><span class="sc13">(</span><span class="sc24">
        </span><span class="sc0">cc</span><span class="sc12">:</span><span class="sc24"> </span><span class="sc5">cons</span><span class="sc13">(</span><span class="sc5">qq,</span><span class="sc24"> </span><span class="sc0">cc</span><span class="sc13">)</span><span class="sc0">,</span><span class="sc24">
        </span><span class="sc0">ee</span><span class="sc12">:</span><span class="sc24"> </span><span class="sc5">cons</span><span class="sc13">(</span><span class="sc0">1,</span><span class="sc24"> </span><span class="sc0">ee</span><span class="sc13">)</span><span class="sc24">
    </span><span class="sc13">)</span><span class="sc0">,</span><span class="sc24">
    </span><span class="sc4">if</span><span class="sc24"> </span><span class="sc0">smat</span><span class="sc12">='</span><span class="sc0">list</span><span class="sc24"> </span><span class="sc4">then</span><span class="sc24"> 
        </span><span class="sc0">[ee,</span><span class="sc24"> </span><span class="sc0">cc]</span><span class="sc24">
    </span><span class="sc4">else</span><span class="sc24"> </span><span class="sc4">if</span><span class="sc24"> </span><span class="sc0">smat</span><span class="sc12">='</span><span class="sc0">mat</span><span class="sc24"> </span><span class="sc4">and</span><span class="sc24"> </span><span class="sc4">not</span><span class="sc24"> </span><span class="sc5">emptyp</span><span class="sc13">(</span><span class="sc0">cc</span><span class="sc13">)</span><span class="sc24"> </span><span class="sc4">then</span><span class="sc24">  
        </span><span class="sc0">[ee,</span><span class="sc24"> </span><span class="sc5">transpose</span><span class="sc13">(</span><span class="sc5">matrix</span><span class="sc13">(</span><span class="sc0">cc</span><span class="sc13">))</span><span class="sc0">]</span><span class="sc24"> </span><span class="sc4">else</span><span class="sc24"> </span><span class="sc0">[</span><span class="sc24"> </span><span class="sc0">]</span><span class="sc24">
        
</span><span class="sc13">)</span><span class="sc0">;</span><span class="sc24">

</span><span class="sc1">/*
computes the blade decomposition
*/</span><span class="sc24">
</span><span class="sc0">bdecompose</span><span class="sc13">(</span><span class="sc5">expr</span><span class="sc13">)</span><span class="sc12">:=</span><span class="sc4">block</span><span class="sc13">(</span><span class="sc0">[gr</span><span class="sc12">:</span><span class="sc5">expr,</span><span class="sc24"> </span><span class="sc0">v],</span><span class="sc24">
    </span><span class="sc4">if</span><span class="sc24"> </span><span class="sc4">not</span><span class="sc24"> </span><span class="sc5">freeof</span><span class="sc13">(</span><span class="sc2">"."</span><span class="sc0">,</span><span class="sc24"> </span><span class="sc5">expr</span><span class="sc13">)</span><span class="sc24"> </span><span class="sc4">then</span><span class="sc24"> 
        </span><span class="sc0">gr</span><span class="sc12">:</span><span class="sc24"> </span><span class="sc5">expand</span><span class="sc13">(</span><span class="sc5">expr</span><span class="sc13">)</span><span class="sc0">,</span><span class="sc24">
    </span><span class="sc4">if</span><span class="sc24"> </span><span class="sc5">length</span><span class="sc13">(</span><span class="sc8">%elements</span><span class="sc13">)</span><span class="sc12">=</span><span class="sc3">1</span><span class="sc24"> </span><span class="sc4">then</span><span class="sc24"> 
            </span><span class="sc8">%elements</span><span class="sc12">:</span><span class="sc5">elements</span><span class="sc13">()</span><span class="sc0">,</span><span class="sc24"> 
    </span><span class="sc0">gr</span><span class="sc12">:</span><span class="sc5">map</span><span class="sc13">(</span><span class="sc24"> </span><span class="sc4">lambda</span><span class="sc13">(</span><span class="sc0">[v],</span><span class="sc24"> </span><span class="sc5">factorby</span><span class="sc13">(</span><span class="sc0">v,</span><span class="sc24"> </span><span class="sc8">%elements</span><span class="sc13">)</span><span class="sc24"> </span><span class="sc13">)</span><span class="sc0">,</span><span class="sc24"> </span><span class="sc0">gr</span><span class="sc24"> </span><span class="sc13">)</span><span class="sc0">,</span><span class="sc24">
    </span><span class="sc0">gr</span><span class="sc12">:</span><span class="sc0">grade</span><span class="sc13">(</span><span class="sc0">gr</span><span class="sc13">)</span><span class="sc0">,</span><span class="sc24">
    </span><span class="sc5">map</span><span class="sc13">(</span><span class="sc4">lambda</span><span class="sc13">(</span><span class="sc0">[v],</span><span class="sc24"> </span><span class="sc0">clicoeff</span><span class="sc13">(</span><span class="sc0">v,</span><span class="sc24"> </span><span class="sc12">'</span><span class="sc0">mat</span><span class="sc13">))</span><span class="sc0">,gr</span><span class="sc13">)</span><span class="sc24">
</span><span class="sc13">)</span><span class="sc0">;</span><span class="sc24">

</span><span class="sc0">clisolve</span><span class="sc13">(</span><span class="sc5">expr,</span><span class="sc24"> </span><span class="sc0">lst</span><span class="sc13">)</span><span class="sc12">:=</span><span class="sc4">block</span><span class="sc13">(</span><span class="sc0">[ee,</span><span class="sc24"> </span><span class="sc0">al,</span><span class="sc24"> </span><span class="sc0">ret</span><span class="sc12">:</span><span class="sc5">expr],</span><span class="sc24">
    </span><span class="sc4">if</span><span class="sc24"> </span><span class="sc5">inop</span><span class="sc13">(</span><span class="sc5">expr</span><span class="sc13">)</span><span class="sc12">=</span><span class="sc2">"="</span><span class="sc24"> </span><span class="sc4">then</span><span class="sc24"> 
        </span><span class="sc0">ret</span><span class="sc12">:</span><span class="sc5">expand</span><span class="sc13">(</span><span class="sc5">lhs</span><span class="sc13">(</span><span class="sc5">expr</span><span class="sc13">)</span><span class="sc12">-</span><span class="sc5">rhs</span><span class="sc13">(</span><span class="sc5">expr</span><span class="sc13">))</span><span class="sc0">,</span><span class="sc24">
    </span><span class="sc0">[ee,</span><span class="sc24"> </span><span class="sc0">al]</span><span class="sc12">:</span><span class="sc0">clicoeff</span><span class="sc13">(</span><span class="sc0">ret,</span><span class="sc12">'</span><span class="sc0">list</span><span class="sc13">)</span><span class="sc0">,</span><span class="sc24">
    </span><span class="sc5">solve</span><span class="sc13">(</span><span class="sc0">al,</span><span class="sc24"> </span><span class="sc0">lst</span><span class="sc13">)</span><span class="sc24">
</span><span class="sc13">)</span><span class="sc0">;</span><span class="sc24">

</span><span class="sc1">/*
Clifford reverse of expressions
*/</span><span class="sc24">
</span><span class="sc1">/* canonical implementation*/</span><span class="sc24">
</span><span class="sc0">creverse</span><span class="sc13">(</span><span class="sc0">x</span><span class="sc13">)</span><span class="sc12">:=</span><span class="sc4">block</span><span class="sc24"> </span><span class="sc13">(</span><span class="sc0">[l,</span><span class="sc24"> </span><span class="sc0">v</span><span class="sc12">:</span><span class="sc0">0,</span><span class="sc24"> </span><span class="sc0">len,</span><span class="sc24"> </span><span class="sc0">k],</span><span class="sc24">
    </span><span class="sc4">if</span><span class="sc24"> </span><span class="sc4">not</span><span class="sc24"> </span><span class="sc5">freeof</span><span class="sc13">(</span><span class="sc2">"."</span><span class="sc0">,x</span><span class="sc13">)</span><span class="sc24"> </span><span class="sc4">then</span><span class="sc24"> 
        </span><span class="sc0">l</span><span class="sc12">:</span><span class="sc0">grade</span><span class="sc13">(</span><span class="sc5">expand</span><span class="sc13">(</span><span class="sc0">x</span><span class="sc13">))</span><span class="sc24">
    </span><span class="sc4">else</span><span class="sc24"> 
        </span><span class="sc0">l</span><span class="sc12">:</span><span class="sc0">grade</span><span class="sc13">(</span><span class="sc0">x</span><span class="sc13">)</span><span class="sc0">,</span><span class="sc24">
    </span><span class="sc0">len</span><span class="sc12">:</span><span class="sc24"> </span><span class="sc5">length</span><span class="sc13">(</span><span class="sc0">l</span><span class="sc13">)</span><span class="sc0">,</span><span class="sc24">
    </span><span class="sc4">for</span><span class="sc24"> </span><span class="sc0">i</span><span class="sc12">:</span><span class="sc3">1</span><span class="sc24"> </span><span class="sc4">thru</span><span class="sc24"> </span><span class="sc0">len</span><span class="sc24"> </span><span class="sc4">do</span><span class="sc24"> </span><span class="sc13">(</span><span class="sc24">
        </span><span class="sc0">k</span><span class="sc12">:</span><span class="sc5">mod</span><span class="sc13">(</span><span class="sc0">i</span><span class="sc12">-</span><span class="sc0">1,4</span><span class="sc13">)</span><span class="sc0">,</span><span class="sc24"> 
        </span><span class="sc0">k</span><span class="sc12">:</span><span class="sc24"> </span><span class="sc13">(</span><span class="sc4">if</span><span class="sc24"> </span><span class="sc0">k</span><span class="sc12">=</span><span class="sc3">0</span><span class="sc24"> </span><span class="sc4">or</span><span class="sc24"> </span><span class="sc0">k</span><span class="sc12">=</span><span class="sc3">1</span><span class="sc24"> </span><span class="sc4">then</span><span class="sc24"> </span><span class="sc3">1</span><span class="sc24"> </span><span class="sc4">else</span><span class="sc24"> </span><span class="sc3">-1</span><span class="sc13">)</span><span class="sc0">,</span><span class="sc24">
        </span><span class="sc0">v</span><span class="sc12">:</span><span class="sc0">v</span><span class="sc12">+</span><span class="sc24"> </span><span class="sc0">k</span><span class="sc24"> </span><span class="sc12">*</span><span class="sc24"> </span><span class="sc0">l[i]</span><span class="sc24"> 
    </span><span class="sc13">)</span><span class="sc0">,</span><span class="sc24">
    </span><span class="sc0">v</span><span class="sc24">
</span><span class="sc13">)</span><span class="sc0">;</span><span class="sc24">

</span><span class="sc1">/* functional implementation*/</span><span class="sc24">
</span><span class="sc4">declare</span><span class="sc24"> </span><span class="sc13">(</span><span class="sc0">dotreverse,</span><span class="sc24"> </span><span class="sc7">evfun</span><span class="sc13">)</span><span class="sc0">;</span><span class="sc24">
</span><span class="sc0">dotreverse</span><span class="sc13">(</span><span class="sc5">expr</span><span class="sc13">)</span><span class="sc12">:=</span><span class="sc4">block</span><span class="sc24"> </span><span class="sc13">(</span><span class="sc24"> </span><span class="sc0">[ret,</span><span class="sc24"> </span><span class="sc0">l,</span><span class="sc24"> </span><span class="sc0">r],</span><span class="sc24">
    </span><span class="sc4">if</span><span class="sc24"> </span><span class="sc4">not</span><span class="sc24"> </span><span class="sc5">freeof</span><span class="sc13">(</span><span class="sc2">"."</span><span class="sc0">,</span><span class="sc24"> </span><span class="sc5">expr</span><span class="sc13">)</span><span class="sc24"> </span><span class="sc4">then</span><span class="sc24"> 
        </span><span class="sc0">ret</span><span class="sc12">:</span><span class="sc24"> </span><span class="sc5">expand</span><span class="sc13">(</span><span class="sc5">expr</span><span class="sc13">)</span><span class="sc24"> 
    </span><span class="sc4">else</span><span class="sc24"> </span><span class="sc0">ret</span><span class="sc12">:</span><span class="sc5">expr,</span><span class="sc24">
    </span><span class="sc4">if</span><span class="sc24"> </span><span class="sc5">matrixp</span><span class="sc13">(</span><span class="sc5">expr</span><span class="sc13">)</span><span class="sc24"> </span><span class="sc4">then</span><span class="sc24">
        </span><span class="sc4">return</span><span class="sc13">(</span><span class="sc5">matrixmap</span><span class="sc13">(</span><span class="sc0">dotreverse,</span><span class="sc24"> </span><span class="sc5">expr</span><span class="sc24"> </span><span class="sc13">))</span><span class="sc0">,</span><span class="sc24">
    </span><span class="sc4">if</span><span class="sc24"> </span><span class="sc5">inop</span><span class="sc13">(</span><span class="sc0">ret</span><span class="sc13">)</span><span class="sc12">=</span><span class="sc2">"+"</span><span class="sc24"> </span><span class="sc4">or</span><span class="sc24"> </span><span class="sc5">listp</span><span class="sc13">(</span><span class="sc0">ret</span><span class="sc13">)</span><span class="sc24"> </span><span class="sc4">then</span><span class="sc24"> 
        </span><span class="sc5">map</span><span class="sc13">(</span><span class="sc0">dotreverse,</span><span class="sc24"> </span><span class="sc0">ret</span><span class="sc24"> </span><span class="sc13">)</span><span class="sc24">
    </span><span class="sc4">elseif</span><span class="sc24"> </span><span class="sc5">inop</span><span class="sc13">(</span><span class="sc0">ret</span><span class="sc13">)</span><span class="sc12">=</span><span class="sc2">"^"</span><span class="sc24"> </span><span class="sc4">then</span><span class="sc24"> </span><span class="sc13">(</span><span class="sc24">
        </span><span class="sc0">[l,</span><span class="sc24"> </span><span class="sc0">r]</span><span class="sc12">:</span><span class="sc24"> </span><span class="sc5">inargs</span><span class="sc13">(</span><span class="sc0">ret</span><span class="sc13">)</span><span class="sc0">,</span><span class="sc24">
        </span><span class="sc0">r</span><span class="sc12">:</span><span class="sc0">dotreverse</span><span class="sc13">(</span><span class="sc0">r</span><span class="sc13">)</span><span class="sc0">,</span><span class="sc24">
        </span><span class="sc0">l</span><span class="sc12">^</span><span class="sc0">r</span><span class="sc24">
    </span><span class="sc13">)</span><span class="sc4">elseif</span><span class="sc24"> </span><span class="sc5">inop</span><span class="sc13">(</span><span class="sc0">ret</span><span class="sc13">)</span><span class="sc12">=</span><span class="sc2">"*"</span><span class="sc24"> </span><span class="sc4">then</span><span class="sc24"> </span><span class="sc13">(</span><span class="sc24">
        </span><span class="sc0">[l,</span><span class="sc24"> </span><span class="sc0">r]</span><span class="sc12">:</span><span class="sc24"> </span><span class="sc5">oppart</span><span class="sc13">(</span><span class="sc0">ret,</span><span class="sc24"> </span><span class="sc4">lambda</span><span class="sc13">(</span><span class="sc0">[u],</span><span class="sc24"> </span><span class="sc5">freeof</span><span class="sc13">(</span><span class="sc0">asymbol,</span><span class="sc24"> </span><span class="sc0">u</span><span class="sc13">)))</span><span class="sc0">,</span><span class="sc24">
        </span><span class="sc0">r</span><span class="sc12">:</span><span class="sc0">dotreverse</span><span class="sc13">(</span><span class="sc0">r</span><span class="sc13">)</span><span class="sc0">,</span><span class="sc24">
        </span><span class="sc0">l</span><span class="sc12">*</span><span class="sc0">r</span><span class="sc24">
    </span><span class="sc13">)</span><span class="sc24"> </span><span class="sc4">else</span><span class="sc24"> </span><span class="sc13">(</span><span class="sc24">
        </span><span class="sc0">[l,</span><span class="sc24"> </span><span class="sc0">r]</span><span class="sc12">:</span><span class="sc24"> </span><span class="sc5">oppart</span><span class="sc13">(</span><span class="sc0">ret,</span><span class="sc24"> </span><span class="sc4">lambda</span><span class="sc13">(</span><span class="sc0">[u],</span><span class="sc24"> </span><span class="sc5">freeof</span><span class="sc13">(</span><span class="sc0">asymbol,</span><span class="sc24"> </span><span class="sc0">u</span><span class="sc13">)))</span><span class="sc0">,</span><span class="sc24">
        </span><span class="sc4">if</span><span class="sc24"> </span><span class="sc0">l</span><span class="sc12">='</span><span class="sc8">nil</span><span class="sc24"> </span><span class="sc4">then</span><span class="sc24"> </span><span class="sc0">l</span><span class="sc12">:</span><span class="sc0">1,</span><span class="sc24">
        </span><span class="sc4">if</span><span class="sc24"> </span><span class="sc0">r</span><span class="sc12">#'</span><span class="sc8">nil</span><span class="sc24"> </span><span class="sc4">then</span><span class="sc24"> </span><span class="sc13">(</span><span class="sc24">
            </span><span class="sc0">r</span><span class="sc12">:</span><span class="sc5">reverse</span><span class="sc13">(</span><span class="sc0">r</span><span class="sc13">)</span><span class="sc0">,</span><span class="sc24"> 
            </span><span class="sc0">r</span><span class="sc12">:</span><span class="sc5">dotsimpc</span><span class="sc13">(</span><span class="sc0">r</span><span class="sc13">)</span><span class="sc24"> 
        </span><span class="sc13">)</span><span class="sc24"> </span><span class="sc4">else</span><span class="sc24"> </span><span class="sc0">r</span><span class="sc12">:</span><span class="sc0">1,</span><span class="sc24">
        </span><span class="sc0">l</span><span class="sc12">*</span><span class="sc0">r</span><span class="sc24">
    </span><span class="sc13">)</span><span class="sc24"> 
</span><span class="sc13">)</span><span class="sc0">;</span><span class="sc24">


</span><span class="sc1">/*  
Clifford involution of expressions
*/</span><span class="sc24">
</span><span class="sc4">declare</span><span class="sc13">(</span><span class="sc0">cinvolve,</span><span class="sc24"> </span><span class="sc9">linear</span><span class="sc13">)</span><span class="sc0">;</span><span class="sc24">

</span><span class="sc0">cinvolve</span><span class="sc13">(</span><span class="sc0">x</span><span class="sc13">)</span><span class="sc12">:=</span><span class="sc4">block</span><span class="sc24"> </span><span class="sc13">(</span><span class="sc24">  
    </span><span class="sc4">if</span><span class="sc24"> </span><span class="sc4">not</span><span class="sc24"> </span><span class="sc5">freeof</span><span class="sc13">(</span><span class="sc0">asymbol,</span><span class="sc24"> </span><span class="sc0">x</span><span class="sc13">)</span><span class="sc24"> </span><span class="sc4">then</span><span class="sc24"> 
         </span><span class="sc5">expand</span><span class="sc13">(</span><span class="sc5">subst</span><span class="sc13">(</span><span class="sc0">asymbol</span><span class="sc12">=</span><span class="sc4">lambda</span><span class="sc13">(</span><span class="sc0">[k],</span><span class="sc24"> </span><span class="sc12">-</span><span class="sc24"> </span><span class="sc5">subvar</span><span class="sc24"> </span><span class="sc13">(</span><span class="sc0">asymbol,</span><span class="sc24"> </span><span class="sc0">k</span><span class="sc13">)</span><span class="sc24"> </span><span class="sc13">)</span><span class="sc0">,</span><span class="sc24"> </span><span class="sc0">x</span><span class="sc13">))</span><span class="sc24">  
    </span><span class="sc4">elseif</span><span class="sc24"> </span><span class="sc5">scalarp</span><span class="sc13">(</span><span class="sc0">x</span><span class="sc13">)</span><span class="sc24"> </span><span class="sc4">then</span><span class="sc24"> </span><span class="sc0">x</span><span class="sc24"> 
    </span><span class="sc4">elseif</span><span class="sc24"> </span><span class="sc5">mapatom</span><span class="sc13">(</span><span class="sc0">x</span><span class="sc13">)</span><span class="sc24"> </span><span class="sc4">then</span><span class="sc24"> </span><span class="sc12">'</span><span class="sc0">cinvolve</span><span class="sc13">(</span><span class="sc0">x</span><span class="sc13">)</span><span class="sc24">
    </span><span class="sc4">else</span><span class="sc24"> </span><span class="sc5">map</span><span class="sc13">(</span><span class="sc12">'</span><span class="sc0">cinvolve,</span><span class="sc24"> </span><span class="sc0">x</span><span class="sc13">)</span><span class="sc24">
</span><span class="sc13">)</span><span class="sc0">;</span><span class="sc24">


</span><span class="sc1">/*
Clifford conjugate of expressions
*/</span><span class="sc24">
</span><span class="sc1">/* canonical implementation*/</span><span class="sc24">
</span><span class="sc0">cconjugate</span><span class="sc13">(</span><span class="sc0">x</span><span class="sc13">)</span><span class="sc12">:=</span><span class="sc4">block</span><span class="sc24"> </span><span class="sc13">(</span><span class="sc0">[l,</span><span class="sc24"> </span><span class="sc0">v</span><span class="sc12">:</span><span class="sc0">0,</span><span class="sc24"> </span><span class="sc0">len,</span><span class="sc24"> </span><span class="sc0">k],</span><span class="sc24">
    </span><span class="sc4">if</span><span class="sc24"> </span><span class="sc4">not</span><span class="sc24"> </span><span class="sc5">freeof</span><span class="sc13">(</span><span class="sc2">"."</span><span class="sc0">,x</span><span class="sc13">)</span><span class="sc24"> </span><span class="sc4">then</span><span class="sc24"> 
        </span><span class="sc0">l</span><span class="sc12">:</span><span class="sc24"> </span><span class="sc0">grade</span><span class="sc13">(</span><span class="sc5">expand</span><span class="sc13">(</span><span class="sc0">x</span><span class="sc13">))</span><span class="sc24">
    </span><span class="sc4">else</span><span class="sc24"> 
        </span><span class="sc0">l</span><span class="sc12">:</span><span class="sc0">grade</span><span class="sc13">(</span><span class="sc0">x</span><span class="sc13">)</span><span class="sc0">,</span><span class="sc24">
    </span><span class="sc0">len</span><span class="sc12">:</span><span class="sc24"> </span><span class="sc5">length</span><span class="sc13">(</span><span class="sc0">l</span><span class="sc13">)</span><span class="sc0">,</span><span class="sc24">
    </span><span class="sc4">for</span><span class="sc24"> </span><span class="sc0">i</span><span class="sc12">:</span><span class="sc3">1</span><span class="sc24"> </span><span class="sc4">thru</span><span class="sc24"> </span><span class="sc0">len</span><span class="sc24"> </span><span class="sc4">do</span><span class="sc24"> </span><span class="sc13">(</span><span class="sc24">
        </span><span class="sc0">k</span><span class="sc12">:</span><span class="sc5">mod</span><span class="sc13">(</span><span class="sc0">i</span><span class="sc12">-</span><span class="sc0">1,4</span><span class="sc13">)</span><span class="sc0">,</span><span class="sc24"> 
        </span><span class="sc0">k</span><span class="sc12">:</span><span class="sc24"> </span><span class="sc13">(</span><span class="sc4">if</span><span class="sc24"> </span><span class="sc0">k</span><span class="sc12">=</span><span class="sc3">1</span><span class="sc24"> </span><span class="sc4">or</span><span class="sc24"> </span><span class="sc0">k</span><span class="sc12">=</span><span class="sc3">2</span><span class="sc24"> </span><span class="sc4">then</span><span class="sc24"> </span><span class="sc3">-1</span><span class="sc24"> </span><span class="sc4">else</span><span class="sc24"> </span><span class="sc3">1</span><span class="sc13">)</span><span class="sc0">,</span><span class="sc24">
        </span><span class="sc0">v</span><span class="sc12">:</span><span class="sc0">v</span><span class="sc12">+</span><span class="sc24"> </span><span class="sc0">k</span><span class="sc24"> </span><span class="sc12">*</span><span class="sc24"> </span><span class="sc0">l[i]</span><span class="sc24"> 
    </span><span class="sc13">)</span><span class="sc0">,</span><span class="sc24">
    </span><span class="sc0">v</span><span class="sc24">
</span><span class="sc13">)</span><span class="sc0">;</span><span class="sc24">


</span><span class="sc1">/* functional implementation*/</span><span class="sc24">
</span><span class="sc4">declare</span><span class="sc24"> </span><span class="sc13">(</span><span class="sc0">dotconjugate,</span><span class="sc24"> </span><span class="sc7">evfun</span><span class="sc13">)</span><span class="sc0">;</span><span class="sc24">
</span><span class="sc0">dotconjugate</span><span class="sc13">(</span><span class="sc5">expr</span><span class="sc13">)</span><span class="sc12">:=</span><span class="sc4">block</span><span class="sc13">(</span><span class="sc0">[ret],</span><span class="sc24">
    </span><span class="sc0">ret</span><span class="sc12">:</span><span class="sc24"> </span><span class="sc0">cinvolve</span><span class="sc13">(</span><span class="sc5">expr</span><span class="sc13">)</span><span class="sc0">,</span><span class="sc24">
    </span><span class="sc0">dotreverse</span><span class="sc13">(</span><span class="sc0">ret</span><span class="sc13">)</span><span class="sc24">
</span><span class="sc13">)</span><span class="sc0">;</span><span class="sc24">

</span><span class="sc1">/*
constructs all  irreducible elements of the algebra,
optionally includes 1
*/</span><span class="sc24">
</span><span class="sc5">elements</span><span class="sc13">(</span><span class="sc0">[cpl]</span><span class="sc13">)</span><span class="sc12">:=</span><span class="sc4">block</span><span class="sc13">(</span><span class="sc0">[c</span><span class="sc12">:</span><span class="sc0">1,</span><span class="sc24"> </span><span class="sc0">lst</span><span class="sc12">:</span><span class="sc0">[]</span><span class="sc24"> </span><span class="sc0">],</span><span class="sc24">
    </span><span class="sc4">for</span><span class="sc24"> </span><span class="sc0">i</span><span class="sc12">:</span><span class="sc3">1</span><span class="sc24"> </span><span class="sc4">thru</span><span class="sc24"> </span><span class="sc0">ndim</span><span class="sc24"> </span><span class="sc4">do</span><span class="sc24"> </span><span class="sc0">c</span><span class="sc12">:</span><span class="sc0">c.</span><span class="sc13">(</span><span class="sc3">1</span><span class="sc12">+</span><span class="sc24"> </span><span class="sc0">asymbol[i]</span><span class="sc24"> </span><span class="sc13">)</span><span class="sc0">,</span><span class="sc24">
    </span><span class="sc4">if</span><span class="sc24"> </span><span class="sc5">emptyp</span><span class="sc13">(</span><span class="sc0">cpl</span><span class="sc13">)</span><span class="sc24"> </span><span class="sc4">then</span><span class="sc24"> </span><span class="sc0">cpl</span><span class="sc12">:</span><span class="sc8">true</span><span class="sc24"> 
    </span><span class="sc4">else</span><span class="sc24"> </span><span class="sc0">cpl</span><span class="sc12">:</span><span class="sc8">false,</span><span class="sc24">
    </span><span class="sc0">c</span><span class="sc12">:</span><span class="sc5">expand</span><span class="sc13">(</span><span class="sc0">c</span><span class="sc13">)</span><span class="sc0">,</span><span class="sc24">
    </span><span class="sc0">lst</span><span class="sc12">:</span><span class="sc5">inargs</span><span class="sc13">(</span><span class="sc0">c</span><span class="sc13">)</span><span class="sc0">,</span><span class="sc24">
    </span><span class="sc4">if</span><span class="sc24"> </span><span class="sc0">cpl</span><span class="sc24"> </span><span class="sc4">then</span><span class="sc24"> </span><span class="sc5">pop</span><span class="sc13">(</span><span class="sc0">lst</span><span class="sc13">)</span><span class="sc0">,</span><span class="sc24">
    </span><span class="sc5">sort</span><span class="sc13">(</span><span class="sc0">lst,</span><span class="sc24"> </span><span class="sc4">lambda</span><span class="sc13">(</span><span class="sc0">[u,v],</span><span class="sc24"> 
            </span><span class="sc5">ordergreatp</span><span class="sc13">(</span><span class="sc0">u,v</span><span class="sc13">)</span><span class="sc24"> </span><span class="sc4">and</span><span class="sc24"> </span><span class="sc4">if</span><span class="sc24"> </span><span class="sc4">not</span><span class="sc24"> </span><span class="sc13">(</span><span class="sc5">numberp</span><span class="sc13">(</span><span class="sc0">u</span><span class="sc13">)</span><span class="sc24"> </span><span class="sc4">or</span><span class="sc24"> </span><span class="sc5">numberp</span><span class="sc13">(</span><span class="sc0">v</span><span class="sc13">))</span><span class="sc24"> </span><span class="sc4">then</span><span class="sc24"> </span><span class="sc5">length</span><span class="sc13">(</span><span class="sc0">u</span><span class="sc13">)</span><span class="sc12">&lt;</span><span class="sc24"> </span><span class="sc5">length</span><span class="sc13">(</span><span class="sc0">v</span><span class="sc13">)</span><span class="sc24">
            </span><span class="sc13">)</span><span class="sc24">
    </span><span class="sc13">)</span><span class="sc24">
</span><span class="sc13">)</span><span class="sc0">;</span><span class="sc24">

</span><span class="sc1">/**
 multiplication table, all elements,
 it also has a debugging functionality
*/</span><span class="sc24"> 
</span><span class="sc0">mtable2</span><span class="sc13">()</span><span class="sc12">:=</span><span class="sc4">block</span><span class="sc13">(</span><span class="sc0">[n,</span><span class="sc24"> </span><span class="sc0">a,</span><span class="sc24"> </span><span class="sc0">lst],</span><span class="sc24">
    </span><span class="sc4">local</span><span class="sc24"> </span><span class="sc13">(</span><span class="sc0">a</span><span class="sc13">)</span><span class="sc0">,</span><span class="sc24">
    </span><span class="sc0">lst</span><span class="sc12">:</span><span class="sc24"> </span><span class="sc5">elements</span><span class="sc13">(</span><span class="sc9">all</span><span class="sc13">)</span><span class="sc0">,</span><span class="sc24">
    </span><span class="sc0">n</span><span class="sc12">:</span><span class="sc5">length</span><span class="sc13">(</span><span class="sc0">lst</span><span class="sc13">)</span><span class="sc0">,</span><span class="sc24">
    </span><span class="sc4">if</span><span class="sc24"> </span><span class="sc0">_debug</span><span class="sc24"> </span><span class="sc4">then</span><span class="sc24"> 
    </span><span class="sc0">a[i,j]</span><span class="sc12">:=</span><span class="sc24"> </span><span class="sc12">'</span><span class="sc13">(</span><span class="sc0">lst[i].lst[j]</span><span class="sc13">)</span><span class="sc24"> </span><span class="sc4">else</span><span class="sc24">
        </span><span class="sc0">a[i,j]</span><span class="sc12">:=</span><span class="sc24"> </span><span class="sc5">dotsimpc</span><span class="sc13">(</span><span class="sc0">lst[i].lst[j]</span><span class="sc13">)</span><span class="sc0">,</span><span class="sc24">
    </span><span class="sc5">genmatrix</span><span class="sc13">(</span><span class="sc0">a,n</span><span class="sc13">)</span><span class="sc24">
</span><span class="sc13">)</span><span class="sc0">;</span><span class="sc24">

</span><span class="sc1">/**
 inner product table, all elements
*/</span><span class="sc24"> 
</span><span class="sc0">mtable2i</span><span class="sc13">()</span><span class="sc12">:=</span><span class="sc4">block</span><span class="sc13">(</span><span class="sc0">[n,</span><span class="sc24">   </span><span class="sc0">lst],</span><span class="sc24">
    </span><span class="sc0">lst</span><span class="sc12">:</span><span class="sc24"> </span><span class="sc5">elements</span><span class="sc13">(</span><span class="sc9">all</span><span class="sc13">)</span><span class="sc0">,</span><span class="sc24">
    </span><span class="sc0">n</span><span class="sc12">:</span><span class="sc5">length</span><span class="sc13">(</span><span class="sc0">lst</span><span class="sc13">)</span><span class="sc0">,</span><span class="sc24">
    </span><span class="sc5">genmatrix</span><span class="sc13">(</span><span class="sc24"> </span><span class="sc4">lambda</span><span class="sc13">(</span><span class="sc0">[i,j],</span><span class="sc24"> </span><span class="sc5">dotsimpc</span><span class="sc13">(</span><span class="sc0">lst[i]</span><span class="sc24"> </span><span class="sc12">|</span><span class="sc24"> </span><span class="sc0">lst[j]</span><span class="sc24"> </span><span class="sc13">)</span><span class="sc24"> </span><span class="sc13">)</span><span class="sc0">,</span><span class="sc24"> </span><span class="sc0">n</span><span class="sc13">)</span><span class="sc24">
</span><span class="sc13">)</span><span class="sc0">;</span><span class="sc24">

</span><span class="sc1">/**
 outer product table, all elements
*/</span><span class="sc24"> 
</span><span class="sc0">mtable2o</span><span class="sc13">()</span><span class="sc12">:=</span><span class="sc4">block</span><span class="sc13">(</span><span class="sc0">[n,</span><span class="sc24"> </span><span class="sc0">a,</span><span class="sc24"> </span><span class="sc0">lst],</span><span class="sc24">
    </span><span class="sc0">lst</span><span class="sc12">:</span><span class="sc24"> </span><span class="sc5">elements</span><span class="sc13">(</span><span class="sc9">all</span><span class="sc13">)</span><span class="sc0">,</span><span class="sc24">
    </span><span class="sc0">n</span><span class="sc12">:</span><span class="sc5">length</span><span class="sc13">(</span><span class="sc0">lst</span><span class="sc13">)</span><span class="sc0">,</span><span class="sc24">
    </span><span class="sc5">genmatrix</span><span class="sc13">(</span><span class="sc24"> </span><span class="sc4">lambda</span><span class="sc13">(</span><span class="sc0">[i,j],</span><span class="sc24"> </span><span class="sc5">dotsimpc</span><span class="sc13">(</span><span class="sc0">lst[i]</span><span class="sc24"> </span><span class="sc12">&amp;</span><span class="sc24"> </span><span class="sc0">lst[j]</span><span class="sc24"> </span><span class="sc13">)</span><span class="sc24"> </span><span class="sc13">)</span><span class="sc0">,</span><span class="sc24"> </span><span class="sc0">n</span><span class="sc13">)</span><span class="sc24">
</span><span class="sc13">)</span><span class="sc0">;</span><span class="sc24">

</span><span class="sc1">/**
 regressive product table, all elements
*/</span><span class="sc24"> 
</span><span class="sc0">mtable2r</span><span class="sc13">()</span><span class="sc12">:=</span><span class="sc4">block</span><span class="sc13">(</span><span class="sc0">[n,</span><span class="sc24"> </span><span class="sc0">a,</span><span class="sc24"> </span><span class="sc0">lst],</span><span class="sc24">
    </span><span class="sc0">lst</span><span class="sc12">:</span><span class="sc24"> </span><span class="sc5">elements</span><span class="sc13">(</span><span class="sc9">all</span><span class="sc13">)</span><span class="sc0">,</span><span class="sc24">
    </span><span class="sc0">n</span><span class="sc12">:</span><span class="sc5">length</span><span class="sc13">(</span><span class="sc0">lst</span><span class="sc13">)</span><span class="sc0">,</span><span class="sc24">
    </span><span class="sc5">genmatrix</span><span class="sc13">(</span><span class="sc24"> </span><span class="sc4">lambda</span><span class="sc13">(</span><span class="sc0">[i,j],</span><span class="sc24">  </span><span class="sc5">dotsimpc</span><span class="sc13">(</span><span class="sc0">lst[i]</span><span class="sc24"> </span><span class="sc0">.</span><span class="sc24"> </span><span class="sc0">dual</span><span class="sc13">(</span><span class="sc0">lst[j]</span><span class="sc13">)))</span><span class="sc0">,</span><span class="sc24"> </span><span class="sc0">n</span><span class="sc13">)</span><span class="sc24">
</span><span class="sc13">)</span><span class="sc0">;</span><span class="sc24">

</span><span class="sc1">/**
 scalar product table, all elements
*/</span><span class="sc24"> 
</span><span class="sc0">mtable2s</span><span class="sc13">()</span><span class="sc12">:=</span><span class="sc4">block</span><span class="sc13">(</span><span class="sc0">[n,</span><span class="sc24"> </span><span class="sc0">a,</span><span class="sc24"> </span><span class="sc0">lst],</span><span class="sc24">
    </span><span class="sc0">lst</span><span class="sc12">:</span><span class="sc24"> </span><span class="sc5">elements</span><span class="sc13">(</span><span class="sc9">all</span><span class="sc13">)</span><span class="sc0">,</span><span class="sc24">
    </span><span class="sc0">n</span><span class="sc12">:</span><span class="sc5">length</span><span class="sc13">(</span><span class="sc0">lst</span><span class="sc13">)</span><span class="sc0">,</span><span class="sc24">
    </span><span class="sc5">genmatrix</span><span class="sc13">(</span><span class="sc24"> </span><span class="sc4">lambda</span><span class="sc13">(</span><span class="sc0">[i,j],</span><span class="sc24">  </span><span class="sc5">scalarpart</span><span class="sc24"> </span><span class="sc13">(</span><span class="sc24"> </span><span class="sc5">dotsimpc</span><span class="sc13">(</span><span class="sc0">lst[i]</span><span class="sc24"> </span><span class="sc0">.</span><span class="sc24"> </span><span class="sc0">lst[j]</span><span class="sc24"> </span><span class="sc13">)</span><span class="sc24"> </span><span class="sc13">))</span><span class="sc0">,</span><span class="sc24"> </span><span class="sc0">n</span><span class="sc13">)</span><span class="sc24">
</span><span class="sc13">)</span><span class="sc0">;</span><span class="sc24">


</span><span class="sc1">/**
 multiplication table, reduced
*/</span><span class="sc24">
</span><span class="sc0">mtable1</span><span class="sc13">(</span><span class="sc0">[lst]</span><span class="sc13">)</span><span class="sc12">:=</span><span class="sc4">block</span><span class="sc13">(</span><span class="sc0">[n],</span><span class="sc24">
    </span><span class="sc4">if</span><span class="sc24"> </span><span class="sc5">emptyp</span><span class="sc13">(</span><span class="sc0">lst</span><span class="sc13">)</span><span class="sc24"> </span><span class="sc4">then</span><span class="sc24"> 
        </span><span class="sc0">lst</span><span class="sc12">:</span><span class="sc4">makelist</span><span class="sc13">(</span><span class="sc0">asymbol[i],</span><span class="sc24"> </span><span class="sc0">i,</span><span class="sc24"> </span><span class="sc0">ndim</span><span class="sc13">)</span><span class="sc24"> 
    </span><span class="sc4">else</span><span class="sc24"> 
        </span><span class="sc0">lst</span><span class="sc12">:</span><span class="sc0">lst[1],</span><span class="sc24">
    </span><span class="sc0">lst</span><span class="sc12">:</span><span class="sc5">push</span><span class="sc13">(</span><span class="sc0">1,</span><span class="sc24"> </span><span class="sc0">lst</span><span class="sc13">)</span><span class="sc0">,</span><span class="sc24">
    </span><span class="sc0">n</span><span class="sc12">:</span><span class="sc5">length</span><span class="sc13">(</span><span class="sc0">lst</span><span class="sc13">)</span><span class="sc0">,</span><span class="sc24">
    </span><span class="sc5">genmatrix</span><span class="sc13">(</span><span class="sc24"> </span><span class="sc4">lambda</span><span class="sc13">(</span><span class="sc0">[i,j],</span><span class="sc24"> </span><span class="sc5">dotsimpc</span><span class="sc13">(</span><span class="sc0">lst[i]</span><span class="sc24"> </span><span class="sc0">.</span><span class="sc24"> </span><span class="sc0">lst[j]</span><span class="sc24"> </span><span class="sc13">)</span><span class="sc24"> </span><span class="sc13">)</span><span class="sc0">,</span><span class="sc24"> </span><span class="sc0">n</span><span class="sc13">)</span><span class="sc24">
</span><span class="sc13">)</span><span class="sc0">;</span><span class="sc24">

</span><span class="sc1">/**
 inner product table, reduced
*/</span><span class="sc24">
</span><span class="sc0">mtable1i</span><span class="sc13">(</span><span class="sc0">[lst]</span><span class="sc13">)</span><span class="sc12">:=</span><span class="sc4">block</span><span class="sc13">(</span><span class="sc0">[n],</span><span class="sc24">
    </span><span class="sc4">if</span><span class="sc24"> </span><span class="sc5">emptyp</span><span class="sc13">(</span><span class="sc0">lst</span><span class="sc13">)</span><span class="sc24"> </span><span class="sc4">then</span><span class="sc24"> 
        </span><span class="sc0">lst</span><span class="sc12">:</span><span class="sc4">makelist</span><span class="sc13">(</span><span class="sc0">asymbol[i],</span><span class="sc24"> </span><span class="sc0">i,</span><span class="sc24"> </span><span class="sc0">ndim</span><span class="sc13">)</span><span class="sc24"> 
    </span><span class="sc4">else</span><span class="sc24"> 
        </span><span class="sc0">lst</span><span class="sc12">:</span><span class="sc0">lst[1],</span><span class="sc24">
    </span><span class="sc0">lst</span><span class="sc12">:</span><span class="sc5">push</span><span class="sc13">(</span><span class="sc0">1,lst</span><span class="sc13">)</span><span class="sc0">,</span><span class="sc24">
    </span><span class="sc0">n</span><span class="sc12">:</span><span class="sc5">length</span><span class="sc13">(</span><span class="sc0">lst</span><span class="sc13">)</span><span class="sc0">,</span><span class="sc24">
    </span><span class="sc5">genmatrix</span><span class="sc13">(</span><span class="sc24"> </span><span class="sc4">lambda</span><span class="sc13">(</span><span class="sc0">[i,j],</span><span class="sc24"> </span><span class="sc5">dotsimpc</span><span class="sc13">(</span><span class="sc0">lst[i]</span><span class="sc24"> </span><span class="sc12">|</span><span class="sc24"> </span><span class="sc0">lst[j]</span><span class="sc24"> </span><span class="sc13">)</span><span class="sc24"> </span><span class="sc13">)</span><span class="sc0">,</span><span class="sc24"> </span><span class="sc0">n</span><span class="sc13">)</span><span class="sc24">
</span><span class="sc13">)</span><span class="sc0">;</span><span class="sc24">

</span><span class="sc1">/**
 multiplication table, reduced
*/</span><span class="sc24">
</span><span class="sc0">mtable1o</span><span class="sc13">(</span><span class="sc0">[lst]</span><span class="sc13">)</span><span class="sc12">:=</span><span class="sc4">block</span><span class="sc13">(</span><span class="sc0">[n],</span><span class="sc24">
    </span><span class="sc4">if</span><span class="sc24"> </span><span class="sc5">emptyp</span><span class="sc13">(</span><span class="sc0">lst</span><span class="sc13">)</span><span class="sc24"> </span><span class="sc4">then</span><span class="sc24"> 
        </span><span class="sc0">lst</span><span class="sc12">:</span><span class="sc4">makelist</span><span class="sc13">(</span><span class="sc0">asymbol[i],</span><span class="sc24"> </span><span class="sc0">i,</span><span class="sc24"> </span><span class="sc0">ndim</span><span class="sc13">)</span><span class="sc24"> 
    </span><span class="sc4">else</span><span class="sc24"> 
        </span><span class="sc0">lst</span><span class="sc12">:</span><span class="sc0">lst[1],</span><span class="sc24">
    </span><span class="sc0">lst</span><span class="sc12">:</span><span class="sc5">push</span><span class="sc13">(</span><span class="sc0">1,</span><span class="sc24"> </span><span class="sc0">lst</span><span class="sc13">)</span><span class="sc0">,</span><span class="sc24">
    </span><span class="sc0">n</span><span class="sc12">:</span><span class="sc5">length</span><span class="sc13">(</span><span class="sc0">lst</span><span class="sc13">)</span><span class="sc0">,</span><span class="sc24">
    </span><span class="sc5">genmatrix</span><span class="sc13">(</span><span class="sc24"> </span><span class="sc4">lambda</span><span class="sc13">(</span><span class="sc0">[i,j],</span><span class="sc24"> </span><span class="sc5">dotsimpc</span><span class="sc13">(</span><span class="sc0">lst[i]</span><span class="sc24"> </span><span class="sc12">&amp;</span><span class="sc24"> </span><span class="sc0">lst[j]</span><span class="sc24"> </span><span class="sc13">)</span><span class="sc24"> </span><span class="sc13">)</span><span class="sc0">,</span><span class="sc24"> </span><span class="sc0">n</span><span class="sc13">)</span><span class="sc24">
</span><span class="sc13">)</span><span class="sc0">;</span><span class="sc24">

</span><span class="sc0">mtable1r</span><span class="sc13">(</span><span class="sc0">[lst]</span><span class="sc13">)</span><span class="sc12">:=</span><span class="sc4">block</span><span class="sc13">(</span><span class="sc0">[n],</span><span class="sc24">
    </span><span class="sc4">if</span><span class="sc24"> </span><span class="sc5">emptyp</span><span class="sc13">(</span><span class="sc0">lst</span><span class="sc13">)</span><span class="sc24"> </span><span class="sc4">then</span><span class="sc24"> 
        </span><span class="sc0">lst</span><span class="sc12">:</span><span class="sc4">makelist</span><span class="sc13">(</span><span class="sc0">asymbol[i],</span><span class="sc24"> </span><span class="sc0">i,</span><span class="sc24"> </span><span class="sc0">ndim</span><span class="sc13">)</span><span class="sc24"> 
    </span><span class="sc4">else</span><span class="sc24"> 
        </span><span class="sc0">lst</span><span class="sc12">:</span><span class="sc0">lst[1],</span><span class="sc24">
    </span><span class="sc0">lst</span><span class="sc12">:</span><span class="sc5">push</span><span class="sc13">(</span><span class="sc0">1,</span><span class="sc24"> </span><span class="sc0">lst</span><span class="sc13">)</span><span class="sc0">,</span><span class="sc24">
    </span><span class="sc0">n</span><span class="sc12">:</span><span class="sc5">length</span><span class="sc13">(</span><span class="sc0">lst</span><span class="sc13">)</span><span class="sc0">,</span><span class="sc24">
    </span><span class="sc5">genmatrix</span><span class="sc13">(</span><span class="sc24"> </span><span class="sc4">lambda</span><span class="sc13">(</span><span class="sc0">[i,j],</span><span class="sc24">  </span><span class="sc5">dotsimpc</span><span class="sc13">(</span><span class="sc0">lst[i]</span><span class="sc24"> </span><span class="sc0">.</span><span class="sc24"> </span><span class="sc0">dual</span><span class="sc13">(</span><span class="sc0">lst[j]</span><span class="sc13">)))</span><span class="sc0">,</span><span class="sc24"> </span><span class="sc0">n</span><span class="sc13">)</span><span class="sc24">
</span><span class="sc13">)</span><span class="sc0">;</span><span class="sc24">

</span><span class="sc0">mtable1s</span><span class="sc13">(</span><span class="sc0">[lst]</span><span class="sc13">)</span><span class="sc12">:=</span><span class="sc4">block</span><span class="sc13">(</span><span class="sc0">[n],</span><span class="sc24">
    </span><span class="sc4">if</span><span class="sc24"> </span><span class="sc5">emptyp</span><span class="sc13">(</span><span class="sc0">lst</span><span class="sc13">)</span><span class="sc24"> </span><span class="sc4">then</span><span class="sc24"> 
        </span><span class="sc0">lst</span><span class="sc12">:</span><span class="sc4">makelist</span><span class="sc13">(</span><span class="sc0">asymbol[i],</span><span class="sc24"> </span><span class="sc0">i,</span><span class="sc24"> </span><span class="sc0">ndim</span><span class="sc13">)</span><span class="sc24"> 
    </span><span class="sc4">else</span><span class="sc24"> 
        </span><span class="sc0">lst</span><span class="sc12">:</span><span class="sc0">lst[1],</span><span class="sc24">
    </span><span class="sc0">lst</span><span class="sc12">:</span><span class="sc5">push</span><span class="sc13">(</span><span class="sc0">1,lst</span><span class="sc13">)</span><span class="sc0">,</span><span class="sc24">
    </span><span class="sc0">n</span><span class="sc12">:</span><span class="sc5">length</span><span class="sc13">(</span><span class="sc0">lst</span><span class="sc13">)</span><span class="sc0">,</span><span class="sc24">
    </span><span class="sc5">genmatrix</span><span class="sc13">(</span><span class="sc24"> </span><span class="sc4">lambda</span><span class="sc13">(</span><span class="sc0">[i,j],</span><span class="sc24">  </span><span class="sc5">scalarpart</span><span class="sc24"> </span><span class="sc13">(</span><span class="sc24"> </span><span class="sc5">dotsimpc</span><span class="sc13">(</span><span class="sc0">lst[i]</span><span class="sc24"> </span><span class="sc0">.</span><span class="sc24"> </span><span class="sc0">lst[j]</span><span class="sc24"> </span><span class="sc13">)</span><span class="sc24"> </span><span class="sc13">))</span><span class="sc0">,</span><span class="sc24"> </span><span class="sc0">n</span><span class="sc13">)</span><span class="sc24">
</span><span class="sc13">)</span><span class="sc0">;</span><span class="sc24">
 

</span><span class="sc1">/*
 matrix representation of the algebra;
experimental code
*/</span><span class="sc24">

</span><span class="sc1">/*
diagnoal transposition of a matrix
*/</span><span class="sc24">
</span><span class="sc0">dtranspose</span><span class="sc13">(</span><span class="sc0">M</span><span class="sc13">)</span><span class="sc12">:=</span><span class="sc24"> </span><span class="sc5">map</span><span class="sc13">(</span><span class="sc5">reverse,</span><span class="sc24"> </span><span class="sc0">M</span><span class="sc13">)</span><span class="sc0">;</span><span class="sc24">

</span><span class="sc0">diag</span><span class="sc13">(</span><span class="sc0">MM</span><span class="sc13">)</span><span class="sc12">:=</span><span class="sc4">block</span><span class="sc13">(</span><span class="sc0">[n],</span><span class="sc24">
    </span><span class="sc4">if</span><span class="sc24"> </span><span class="sc4">not</span><span class="sc24"> </span><span class="sc5">matrixp</span><span class="sc13">(</span><span class="sc0">MM</span><span class="sc13">)</span><span class="sc24"> </span><span class="sc4">then</span><span class="sc24"> </span><span class="sc4">error</span><span class="sc13">(</span><span class="sc2">"matrix required"</span><span class="sc13">)</span><span class="sc0">,</span><span class="sc24">
    </span><span class="sc0">n</span><span class="sc12">:</span><span class="sc5">length</span><span class="sc13">(</span><span class="sc0">MM</span><span class="sc13">)</span><span class="sc0">,</span><span class="sc24">
    </span><span class="sc5">genmatrix</span><span class="sc13">(</span><span class="sc24"> </span><span class="sc4">lambda</span><span class="sc13">(</span><span class="sc0">[i,j],</span><span class="sc24">  </span><span class="sc4">if</span><span class="sc24"> </span><span class="sc0">i</span><span class="sc12">=</span><span class="sc0">j</span><span class="sc24"> </span><span class="sc4">then</span><span class="sc24"> </span><span class="sc0">MM[i,j]</span><span class="sc24"> </span><span class="sc4">else</span><span class="sc24"> </span><span class="sc3">0</span><span class="sc24"> </span><span class="sc13">)</span><span class="sc0">,</span><span class="sc24"> </span><span class="sc0">n</span><span class="sc13">)</span><span class="sc24">
</span><span class="sc13">)</span><span class="sc0">;</span><span class="sc24">

</span><span class="sc0">adiag</span><span class="sc13">(</span><span class="sc0">MM</span><span class="sc13">)</span><span class="sc12">:=</span><span class="sc4">block</span><span class="sc13">(</span><span class="sc0">[n],</span><span class="sc24">
    </span><span class="sc4">if</span><span class="sc24"> </span><span class="sc4">not</span><span class="sc24"> </span><span class="sc5">matrixp</span><span class="sc13">(</span><span class="sc0">MM</span><span class="sc13">)</span><span class="sc24"> </span><span class="sc4">then</span><span class="sc24"> </span><span class="sc4">error</span><span class="sc13">(</span><span class="sc2">"matrix required"</span><span class="sc13">)</span><span class="sc0">,</span><span class="sc24">
    </span><span class="sc0">n</span><span class="sc12">:</span><span class="sc5">length</span><span class="sc13">(</span><span class="sc0">MM</span><span class="sc13">)</span><span class="sc0">,</span><span class="sc24">
    </span><span class="sc5">genmatrix</span><span class="sc13">(</span><span class="sc24"> </span><span class="sc4">lambda</span><span class="sc13">(</span><span class="sc0">[i,j],</span><span class="sc24">  </span><span class="sc4">if</span><span class="sc24"> </span><span class="sc0">i</span><span class="sc12">=</span><span class="sc0">j</span><span class="sc24"> </span><span class="sc4">then</span><span class="sc24"> </span><span class="sc0">MM[n</span><span class="sc12">-</span><span class="sc0">i</span><span class="sc24"> </span><span class="sc12">+</span><span class="sc0">1,</span><span class="sc24"> </span><span class="sc0">j]</span><span class="sc24"> </span><span class="sc4">else</span><span class="sc24"> </span><span class="sc3">0</span><span class="sc24"> </span><span class="sc13">)</span><span class="sc0">,</span><span class="sc24"> </span><span class="sc0">n</span><span class="sc13">)</span><span class="sc24">
</span><span class="sc13">)</span><span class="sc0">;</span><span class="sc24">

</span><span class="sc0">diaglist</span><span class="sc13">(</span><span class="sc0">MM</span><span class="sc13">)</span><span class="sc12">:=</span><span class="sc4">block</span><span class="sc13">(</span><span class="sc0">[n,</span><span class="sc24"> </span><span class="sc0">LL],</span><span class="sc24">
    </span><span class="sc4">if</span><span class="sc24"> </span><span class="sc4">not</span><span class="sc24"> </span><span class="sc5">matrixp</span><span class="sc13">(</span><span class="sc0">MM</span><span class="sc13">)</span><span class="sc24"> </span><span class="sc4">then</span><span class="sc24"> </span><span class="sc4">error</span><span class="sc13">(</span><span class="sc2">"matrix required"</span><span class="sc13">)</span><span class="sc0">,</span><span class="sc24">
    </span><span class="sc0">n</span><span class="sc12">:</span><span class="sc5">length</span><span class="sc13">(</span><span class="sc0">MM</span><span class="sc13">)</span><span class="sc0">,</span><span class="sc24">
    </span><span class="sc4">local</span><span class="sc13">(</span><span class="sc0">LL</span><span class="sc13">)</span><span class="sc0">,</span><span class="sc24">
    </span><span class="sc0">LL</span><span class="sc12">:</span><span class="sc5">genmatrix</span><span class="sc13">(</span><span class="sc24"> </span><span class="sc4">lambda</span><span class="sc13">(</span><span class="sc0">[i,j],</span><span class="sc24">  </span><span class="sc4">if</span><span class="sc24"> </span><span class="sc0">i</span><span class="sc12">=</span><span class="sc0">j</span><span class="sc24"> </span><span class="sc4">then</span><span class="sc24"> </span><span class="sc0">MM[i,j]</span><span class="sc24"> </span><span class="sc4">else</span><span class="sc24"> </span><span class="sc3">0</span><span class="sc24"> </span><span class="sc13">)</span><span class="sc0">,</span><span class="sc24"> </span><span class="sc0">n</span><span class="sc13">)</span><span class="sc0">,</span><span class="sc24">
    </span><span class="sc5">list_matrix_entries</span><span class="sc13">(</span><span class="sc5">matrix</span><span class="sc13">(</span><span class="sc4">makelist</span><span class="sc13">(</span><span class="sc0">1,</span><span class="sc24"> </span><span class="sc0">n</span><span class="sc13">))</span><span class="sc0">.LL</span><span class="sc13">)</span><span class="sc24">
</span><span class="sc13">)</span><span class="sc0">;</span><span class="sc24">

</span><span class="sc0">mdiag</span><span class="sc13">(</span><span class="sc0">MM</span><span class="sc13">)</span><span class="sc12">:=</span><span class="sc4">block</span><span class="sc13">(</span><span class="sc0">[n],</span><span class="sc24">
    </span><span class="sc4">if</span><span class="sc24"> </span><span class="sc4">not</span><span class="sc24"> </span><span class="sc5">listp</span><span class="sc13">(</span><span class="sc0">MM</span><span class="sc13">)</span><span class="sc24"> </span><span class="sc4">then</span><span class="sc24"> </span><span class="sc4">error</span><span class="sc13">(</span><span class="sc2">"list required"</span><span class="sc13">)</span><span class="sc0">,</span><span class="sc24">
    </span><span class="sc0">n</span><span class="sc12">:</span><span class="sc5">length</span><span class="sc13">(</span><span class="sc0">MM</span><span class="sc13">)</span><span class="sc0">,</span><span class="sc24">
    </span><span class="sc5">genmatrix</span><span class="sc13">(</span><span class="sc24"> </span><span class="sc4">lambda</span><span class="sc13">(</span><span class="sc0">[i,j],</span><span class="sc24">  </span><span class="sc4">if</span><span class="sc24"> </span><span class="sc0">i</span><span class="sc12">=</span><span class="sc0">j</span><span class="sc24"> </span><span class="sc4">then</span><span class="sc24"> </span><span class="sc0">MM[i]</span><span class="sc24"> </span><span class="sc4">else</span><span class="sc24"> </span><span class="sc3">0</span><span class="sc24"> </span><span class="sc13">)</span><span class="sc0">,</span><span class="sc24"> </span><span class="sc0">n</span><span class="sc13">)</span><span class="sc24">
</span><span class="sc13">)</span><span class="sc0">;</span><span class="sc24">
 
</span><span class="sc1">/*
 computes the commutation table with all basis vectors
*/</span><span class="sc24">
</span><span class="sc0">commtable</span><span class="sc13">(</span><span class="sc0">ee</span><span class="sc13">)</span><span class="sc12">:=</span><span class="sc24">
    </span><span class="sc5">matrix</span><span class="sc13">(</span><span class="sc4">makelist</span><span class="sc13">(</span><span class="sc0">asymbol[i],</span><span class="sc24"> </span><span class="sc0">i,</span><span class="sc24"> </span><span class="sc0">1,</span><span class="sc24"> </span><span class="sc0">ndim</span><span class="sc13">)</span><span class="sc0">,</span><span class="sc24"> 
          </span><span class="sc4">makelist</span><span class="sc13">(</span><span class="sc24"> </span><span class="sc0">cliffsimpall</span><span class="sc24"> </span><span class="sc13">(</span><span class="sc24"> </span><span class="sc0">asymbol[i].</span><span class="sc24"> </span><span class="sc0">ee</span><span class="sc24"> </span><span class="sc12">-</span><span class="sc24"> </span><span class="sc0">ee.</span><span class="sc24"> </span><span class="sc0">asymbol[i]</span><span class="sc13">)</span><span class="sc12">/</span><span class="sc0">2,</span><span class="sc24"> </span><span class="sc0">i,</span><span class="sc24"> </span><span class="sc0">1,</span><span class="sc24"> </span><span class="sc0">ndim</span><span class="sc13">)</span><span class="sc24">
          </span><span class="sc13">)</span><span class="sc0">;</span><span class="sc24">

</span><span class="sc1">/**
 norm
*/</span><span class="sc24">
</span><span class="sc0">cliabs</span><span class="sc13">(</span><span class="sc0">x</span><span class="sc13">)</span><span class="sc12">:=</span><span class="sc4">block</span><span class="sc13">(</span><span class="sc0">[u</span><span class="sc12">:</span><span class="sc5">expand</span><span class="sc13">(</span><span class="sc0">x</span><span class="sc13">)</span><span class="sc0">],</span><span class="sc24">
    </span><span class="sc0">u</span><span class="sc12">:</span><span class="sc5">expand</span><span class="sc13">(</span><span class="sc0">u.cconjugate</span><span class="sc13">(</span><span class="sc0">u</span><span class="sc13">))</span><span class="sc0">,</span><span class="sc24">
    </span><span class="sc0">u</span><span class="sc12">:</span><span class="sc5">scalarpart</span><span class="sc13">(</span><span class="sc0">u</span><span class="sc13">)</span><span class="sc0">,</span><span class="sc24">
    </span><span class="sc0">u</span><span class="sc12">:</span><span class="sc5">sqrt</span><span class="sc13">(</span><span class="sc5">abs</span><span class="sc13">(</span><span class="sc0">u</span><span class="sc13">))</span><span class="sc0">,</span><span class="sc24">
    </span><span class="sc5">radcan</span><span class="sc13">(</span><span class="sc0">u</span><span class="sc13">)</span><span class="sc24">
</span><span class="sc13">)</span><span class="sc0">;</span><span class="sc24">


</span><span class="sc1">/**
 multiplication table, trace
*/</span><span class="sc24">
</span><span class="sc0">multtrace</span><span class="sc13">()</span><span class="sc12">:=</span><span class="sc4">block</span><span class="sc13">(</span><span class="sc0">[s</span><span class="sc12">:</span><span class="sc0">[1],</span><span class="sc24"> </span><span class="sc0">lst],</span><span class="sc24">
    </span><span class="sc0">lst</span><span class="sc12">:</span><span class="sc5">elements</span><span class="sc13">(</span><span class="sc9">all</span><span class="sc13">)</span><span class="sc0">,</span><span class="sc24">
    </span><span class="sc4">for</span><span class="sc24"> </span><span class="sc0">i</span><span class="sc12">:</span><span class="sc3">1</span><span class="sc24"> </span><span class="sc4">thru</span><span class="sc24"> </span><span class="sc5">length</span><span class="sc13">(</span><span class="sc0">lst</span><span class="sc13">)</span><span class="sc24"> </span><span class="sc4">do</span><span class="sc24"> 
        </span><span class="sc0">s</span><span class="sc12">:</span><span class="sc5">endcons</span><span class="sc13">(</span><span class="sc5">dotsimpc</span><span class="sc13">(</span><span class="sc0">lst[i].lst[i]</span><span class="sc13">)</span><span class="sc0">,</span><span class="sc24"> </span><span class="sc0">s</span><span class="sc13">)</span><span class="sc0">,</span><span class="sc24">
    </span><span class="sc0">s</span><span class="sc24">
</span><span class="sc13">)</span><span class="sc0">;</span><span class="sc24">

</span><span class="sc0">cnorm</span><span class="sc13">(</span><span class="sc0">x</span><span class="sc13">)</span><span class="sc12">:=</span><span class="sc4">block</span><span class="sc13">(</span><span class="sc0">[u</span><span class="sc12">:</span><span class="sc5">expand</span><span class="sc13">(</span><span class="sc0">x</span><span class="sc13">)</span><span class="sc0">,</span><span class="sc24"> </span><span class="sc0">z,</span><span class="sc24"> </span><span class="sc0">v],</span><span class="sc24">
    </span><span class="sc0">u</span><span class="sc12">:</span><span class="sc5">expand</span><span class="sc13">(</span><span class="sc0">u</span><span class="sc24"> </span><span class="sc12">|</span><span class="sc24"> </span><span class="sc0">cconjugate</span><span class="sc13">(</span><span class="sc0">u</span><span class="sc13">))</span><span class="sc0">,</span><span class="sc24">
    </span><span class="sc0">u</span><span class="sc12">:</span><span class="sc0">cliffsimpall</span><span class="sc13">(</span><span class="sc0">u</span><span class="sc13">)</span><span class="sc0">,</span><span class="sc24">
    </span><span class="sc0">u</span><span class="sc12">:</span><span class="sc5">expand</span><span class="sc13">(</span><span class="sc0">u</span><span class="sc13">)</span><span class="sc0">,</span><span class="sc24">
    </span><span class="sc0">u</span><span class="sc12">:</span><span class="sc5">scalarpart</span><span class="sc13">(</span><span class="sc0">u</span><span class="sc13">)</span><span class="sc0">,</span><span class="sc24">
    </span><span class="sc0">u</span><span class="sc12">:</span><span class="sc5">ratsimp</span><span class="sc13">(</span><span class="sc0">u</span><span class="sc13">)</span><span class="sc24">
</span><span class="sc13">)</span><span class="sc0">;</span><span class="sc24">

</span><span class="sc1">/*
symmetric bilinear form of the algebra; 
*/</span><span class="sc24">
</span><span class="sc7">psnorm</span><span class="sc13">(</span><span class="sc0">x,</span><span class="sc24"> </span><span class="sc0">sgn</span><span class="sc13">)</span><span class="sc12">:=</span><span class="sc4">block</span><span class="sc13">(</span><span class="sc0">[u,</span><span class="sc24"> </span><span class="sc0">z,</span><span class="sc24"> </span><span class="sc0">v,</span><span class="sc24"> </span><span class="sc0">ss</span><span class="sc12">:</span><span class="sc0">0,</span><span class="sc24"> </span><span class="sc0">neg</span><span class="sc12">:-</span><span class="sc0">1,</span><span class="sc24"> </span><span class="sc0">l,</span><span class="sc24"> </span><span class="sc0">r,</span><span class="sc24"> </span><span class="sc0">ret</span><span class="sc24"> </span><span class="sc0">],</span><span class="sc24">
    </span><span class="sc4">if</span><span class="sc24"> </span><span class="sc4">not</span><span class="sc24"> </span><span class="sc13">(</span><span class="sc0">sgn</span><span class="sc12">='</span><span class="sc5">minus</span><span class="sc24"> </span><span class="sc4">or</span><span class="sc24"> </span><span class="sc0">sgn</span><span class="sc12">='</span><span class="sc0">neg</span><span class="sc24"> </span><span class="sc4">or</span><span class="sc24">  </span><span class="sc0">sgn</span><span class="sc12">='</span><span class="sc0">plus</span><span class="sc24"> </span><span class="sc4">or</span><span class="sc24"> </span><span class="sc0">sgn</span><span class="sc12">='</span><span class="sc0">pos</span><span class="sc24"> </span><span class="sc13">)</span><span class="sc24"> </span><span class="sc4">then</span><span class="sc24"> 
        </span><span class="sc4">error</span><span class="sc13">(</span><span class="sc2">"plus, pos, neg or minus expected"</span><span class="sc13">)</span><span class="sc0">,</span><span class="sc24">  
    
    </span><span class="sc4">if</span><span class="sc24"> </span><span class="sc5">mapatom</span><span class="sc13">(</span><span class="sc0">x</span><span class="sc13">)</span><span class="sc24"> </span><span class="sc4">then</span><span class="sc24"> </span><span class="sc4">return</span><span class="sc24"> </span><span class="sc13">(</span><span class="sc0">x.x</span><span class="sc13">)</span><span class="sc0">,</span><span class="sc24">
    </span><span class="sc4">if</span><span class="sc24"> </span><span class="sc0">sgn</span><span class="sc12">=</span><span class="sc0">plus</span><span class="sc24"> </span><span class="sc4">or</span><span class="sc24"> </span><span class="sc0">sgn</span><span class="sc12">=</span><span class="sc0">pos</span><span class="sc24"> </span><span class="sc4">then</span><span class="sc24"> </span><span class="sc0">neg</span><span class="sc12">:</span><span class="sc0">1,</span><span class="sc24">
    </span><span class="sc4">if</span><span class="sc24"> </span><span class="sc4">not</span><span class="sc24"> </span><span class="sc5">freeof</span><span class="sc13">(</span><span class="sc2">"."</span><span class="sc0">,x</span><span class="sc13">)</span><span class="sc24"> </span><span class="sc4">then</span><span class="sc24"> </span><span class="sc0">u</span><span class="sc12">:</span><span class="sc5">expand</span><span class="sc13">(</span><span class="sc0">x</span><span class="sc13">)</span><span class="sc24"> 
    </span><span class="sc4">else</span><span class="sc24"> </span><span class="sc0">u</span><span class="sc12">:</span><span class="sc0">x,</span><span class="sc24">
    
    </span><span class="sc4">if</span><span class="sc24"> </span><span class="sc5">nterms</span><span class="sc13">(</span><span class="sc0">u</span><span class="sc13">)</span><span class="sc12">&gt;</span><span class="sc3">1</span><span class="sc24"> </span><span class="sc4">then</span><span class="sc24"> </span><span class="sc13">(</span><span class="sc24">
        </span><span class="sc0">[l,r]</span><span class="sc12">:</span><span class="sc24"> </span><span class="sc5">oppart</span><span class="sc24"> </span><span class="sc13">(</span><span class="sc0">u,</span><span class="sc24"> </span><span class="sc4">lambda</span><span class="sc24"> </span><span class="sc13">(</span><span class="sc0">[u],</span><span class="sc24"> </span><span class="sc5">freeof</span><span class="sc13">(</span><span class="sc0">asymbol,</span><span class="sc24"> </span><span class="sc0">u</span><span class="sc13">)))</span><span class="sc0">,</span><span class="sc24">
        </span><span class="sc4">if</span><span class="sc24"> </span><span class="sc0">_debug</span><span class="sc12">=</span><span class="sc8">true</span><span class="sc24"> </span><span class="sc4">then</span><span class="sc24"> </span><span class="sc5">display</span><span class="sc13">(</span><span class="sc0">l,r</span><span class="sc13">)</span><span class="sc0">,</span><span class="sc24">
        </span><span class="sc4">if</span><span class="sc24"> </span><span class="sc5">nterms</span><span class="sc13">(</span><span class="sc0">r</span><span class="sc13">)</span><span class="sc12">&gt;</span><span class="sc3">1</span><span class="sc24"> </span><span class="sc4">then</span><span class="sc24"> </span><span class="sc13">(</span><span class="sc24">
            </span><span class="sc4">for</span><span class="sc24"> </span><span class="sc0">v</span><span class="sc24"> </span><span class="sc4">in</span><span class="sc24"> </span><span class="sc0">r</span><span class="sc24"> </span><span class="sc4">do</span><span class="sc24"> 
                </span><span class="sc0">ss</span><span class="sc12">:</span><span class="sc0">ss</span><span class="sc24"> </span><span class="sc12">+</span><span class="sc24"> </span><span class="sc5">apply1</span><span class="sc13">(</span><span class="sc0">v.v,</span><span class="sc24"> </span><span class="sc0">clifsimp10</span><span class="sc13">)</span><span class="sc0">,</span><span class="sc24">
            </span><span class="sc0">ret</span><span class="sc12">:</span><span class="sc0">neg</span><span class="sc12">*</span><span class="sc0">ss</span><span class="sc24"> </span><span class="sc12">+</span><span class="sc24"> </span><span class="sc0">l</span><span class="sc12">^</span><span class="sc3">2</span><span class="sc24">
        </span><span class="sc13">)</span><span class="sc24"> </span><span class="sc4">else</span><span class="sc24">
            </span><span class="sc0">ret</span><span class="sc12">:</span><span class="sc24"> </span><span class="sc0">l</span><span class="sc12">^</span><span class="sc3">2</span><span class="sc12">+</span><span class="sc24"> </span><span class="sc0">neg</span><span class="sc12">*</span><span class="sc5">apply1</span><span class="sc13">(</span><span class="sc0">r.r,</span><span class="sc24"> </span><span class="sc0">clifsimp10</span><span class="sc13">)</span><span class="sc24">
    </span><span class="sc13">)</span><span class="sc4">else</span><span class="sc24"> 
        </span><span class="sc0">ret</span><span class="sc12">:</span><span class="sc0">neg</span><span class="sc12">*</span><span class="sc5">apply1</span><span class="sc13">(</span><span class="sc0">u.u,</span><span class="sc24"> </span><span class="sc0">clifsimp10</span><span class="sc13">)</span><span class="sc0">,</span><span class="sc24">
    </span><span class="sc5">subst</span><span class="sc13">(</span><span class="sc12">'</span><span class="sc8">nil</span><span class="sc12">=</span><span class="sc0">0,</span><span class="sc24"> </span><span class="sc0">ret</span><span class="sc13">)</span><span class="sc24">  
</span><span class="sc13">)</span><span class="sc0">;</span><span class="sc24">

</span><span class="sc1">/**
vector predicate
*/</span><span class="sc24">
</span><span class="sc0">vectorp</span><span class="sc13">(</span><span class="sc0">v</span><span class="sc13">)</span><span class="sc12">:=</span><span class="sc24"> </span><span class="sc13">(</span><span class="sc24">
    </span><span class="sc4">if</span><span class="sc24"> </span><span class="sc4">not</span><span class="sc24"> </span><span class="sc5">freeof</span><span class="sc13">(</span><span class="sc2">"."</span><span class="sc0">,</span><span class="sc24"> </span><span class="sc0">v</span><span class="sc13">)</span><span class="sc24"> </span><span class="sc4">then</span><span class="sc24"> </span><span class="sc0">v</span><span class="sc12">:</span><span class="sc5">expand</span><span class="sc13">(</span><span class="sc0">v</span><span class="sc13">)</span><span class="sc0">,</span><span class="sc24">
    </span><span class="sc5">freeof</span><span class="sc13">(</span><span class="sc2">"."</span><span class="sc0">,</span><span class="sc24"> </span><span class="sc0">v</span><span class="sc13">)</span><span class="sc24"> </span><span class="sc4">and</span><span class="sc24"> </span><span class="sc4">not</span><span class="sc24"> </span><span class="sc5">freeof</span><span class="sc13">(</span><span class="sc0">asymbol,</span><span class="sc24"> </span><span class="sc0">v</span><span class="sc13">)</span><span class="sc24">
</span><span class="sc13">)</span><span class="sc0">;</span><span class="sc24">

</span><span class="sc1">/*
 grading functions
*/</span><span class="sc24">

</span><span class="sc1">/*
 scalar part
*/</span><span class="sc24">
</span><span class="sc5">scalarpart</span><span class="sc13">(</span><span class="sc0">v</span><span class="sc13">)</span><span class="sc12">:=</span><span class="sc4">block</span><span class="sc13">(</span><span class="sc0">[</span><span class="sc24"> </span><span class="sc0">r,</span><span class="sc24"> </span><span class="sc0">l,</span><span class="sc24"> </span><span class="sc0">sop</span><span class="sc24"> </span><span class="sc0">],</span><span class="sc24">
    </span><span class="sc4">if</span><span class="sc24"> </span><span class="sc5">freeof</span><span class="sc13">(</span><span class="sc0">asymbol,</span><span class="sc24"> </span><span class="sc0">v</span><span class="sc13">)</span><span class="sc24"> </span><span class="sc4">then</span><span class="sc24"> </span><span class="sc4">return</span><span class="sc24"> </span><span class="sc13">(</span><span class="sc0">v</span><span class="sc13">)</span><span class="sc0">,</span><span class="sc24">
    </span><span class="sc4">if</span><span class="sc24"> </span><span class="sc4">not</span><span class="sc24"> </span><span class="sc5">freeof</span><span class="sc13">(</span><span class="sc2">"."</span><span class="sc0">,</span><span class="sc24"> </span><span class="sc0">v</span><span class="sc13">)</span><span class="sc24"> </span><span class="sc4">then</span><span class="sc24"> </span><span class="sc0">v</span><span class="sc12">:</span><span class="sc5">expand</span><span class="sc13">(</span><span class="sc0">v</span><span class="sc13">)</span><span class="sc0">,</span><span class="sc24">
    </span><span class="sc0">sop</span><span class="sc12">:</span><span class="sc24"> </span><span class="sc5">inop</span><span class="sc13">(</span><span class="sc0">v</span><span class="sc13">)</span><span class="sc0">,</span><span class="sc24">
    </span><span class="sc4">if</span><span class="sc24"> </span><span class="sc0">sop</span><span class="sc12">=</span><span class="sc2">"+"</span><span class="sc24"> </span><span class="sc4">then</span><span class="sc24"> </span><span class="sc13">(</span><span class="sc24">
        </span><span class="sc0">[r,l]</span><span class="sc12">:</span><span class="sc24"> </span><span class="sc5">oppart</span><span class="sc13">(</span><span class="sc0">v,</span><span class="sc24"> </span><span class="sc4">lambda</span><span class="sc13">(</span><span class="sc0">[u],</span><span class="sc24"> </span><span class="sc5">freeof</span><span class="sc13">(</span><span class="sc0">asymbol,</span><span class="sc24"> </span><span class="sc0">u</span><span class="sc13">)))</span><span class="sc0">,</span><span class="sc24">
        </span><span class="sc0">r</span><span class="sc12">:</span><span class="sc5">subst</span><span class="sc13">(</span><span class="sc12">'</span><span class="sc8">nil</span><span class="sc12">=</span><span class="sc0">0,</span><span class="sc24"> </span><span class="sc0">r</span><span class="sc13">)</span><span class="sc24">
    </span><span class="sc13">)</span><span class="sc24"> </span><span class="sc4">else</span><span class="sc24"> 
        </span><span class="sc4">if</span><span class="sc24"> </span><span class="sc5">freeof</span><span class="sc13">(</span><span class="sc0">asymbol,</span><span class="sc24"> </span><span class="sc0">v</span><span class="sc13">)</span><span class="sc24"> </span><span class="sc4">then</span><span class="sc24">  </span><span class="sc0">r</span><span class="sc12">:</span><span class="sc0">v</span><span class="sc24"> 
        </span><span class="sc4">else</span><span class="sc24"> </span><span class="sc0">r</span><span class="sc12">:</span><span class="sc0">0,</span><span class="sc24">
    </span><span class="sc0">r</span><span class="sc24">
</span><span class="sc13">)</span><span class="sc0">;</span><span class="sc24">

</span><span class="sc1">/*
 non scalar part
*/</span><span class="sc24">
</span><span class="sc0">nscalarpart</span><span class="sc13">(</span><span class="sc0">v</span><span class="sc13">)</span><span class="sc12">:=</span><span class="sc4">block</span><span class="sc13">(</span><span class="sc0">[</span><span class="sc24"> </span><span class="sc0">r,</span><span class="sc24"> </span><span class="sc0">l,</span><span class="sc24"> </span><span class="sc0">sop</span><span class="sc24"> </span><span class="sc0">],</span><span class="sc24">
    </span><span class="sc4">if</span><span class="sc24"> </span><span class="sc5">freeof</span><span class="sc13">(</span><span class="sc0">asymbol,</span><span class="sc24"> </span><span class="sc0">v</span><span class="sc13">)</span><span class="sc24"> </span><span class="sc4">then</span><span class="sc24"> </span><span class="sc4">return</span><span class="sc24"> </span><span class="sc13">(</span><span class="sc3">0</span><span class="sc13">)</span><span class="sc0">,</span><span class="sc24">
    </span><span class="sc4">if</span><span class="sc24"> </span><span class="sc4">not</span><span class="sc24"> </span><span class="sc5">freeof</span><span class="sc13">(</span><span class="sc2">"."</span><span class="sc0">,</span><span class="sc24"> </span><span class="sc0">v</span><span class="sc13">)</span><span class="sc24"> </span><span class="sc4">then</span><span class="sc24"> </span><span class="sc0">v</span><span class="sc12">:</span><span class="sc5">expand</span><span class="sc13">(</span><span class="sc0">v</span><span class="sc13">)</span><span class="sc0">,</span><span class="sc24">
    </span><span class="sc0">sop</span><span class="sc12">:</span><span class="sc24"> </span><span class="sc5">inop</span><span class="sc13">(</span><span class="sc0">v</span><span class="sc13">)</span><span class="sc0">,</span><span class="sc24">
    </span><span class="sc4">if</span><span class="sc24"> </span><span class="sc0">sop</span><span class="sc12">=</span><span class="sc2">"+"</span><span class="sc24"> </span><span class="sc4">then</span><span class="sc24"> </span><span class="sc13">(</span><span class="sc24">
        </span><span class="sc0">[r,l]</span><span class="sc12">:</span><span class="sc24"> </span><span class="sc5">oppart</span><span class="sc13">(</span><span class="sc0">v,</span><span class="sc24"> </span><span class="sc4">lambda</span><span class="sc13">(</span><span class="sc0">[u],</span><span class="sc24">  </span><span class="sc4">not</span><span class="sc24"> </span><span class="sc5">freeof</span><span class="sc13">(</span><span class="sc0">asymbol,</span><span class="sc24"> </span><span class="sc0">u</span><span class="sc13">)))</span><span class="sc0">,</span><span class="sc24">
        </span><span class="sc1">/*display(r,l),*/</span><span class="sc24">
        </span><span class="sc0">r</span><span class="sc12">:</span><span class="sc5">subst</span><span class="sc13">(</span><span class="sc12">'</span><span class="sc8">nil</span><span class="sc12">=</span><span class="sc0">0,</span><span class="sc24"> </span><span class="sc0">r</span><span class="sc13">)</span><span class="sc24">
    </span><span class="sc13">)</span><span class="sc24"> </span><span class="sc4">else</span><span class="sc24"> 
        </span><span class="sc4">if</span><span class="sc24"> </span><span class="sc4">not</span><span class="sc24"> </span><span class="sc5">freeof</span><span class="sc13">(</span><span class="sc0">asymbol,</span><span class="sc24"> </span><span class="sc0">v</span><span class="sc13">)</span><span class="sc24"> </span><span class="sc4">then</span><span class="sc24">  </span><span class="sc0">r</span><span class="sc12">:</span><span class="sc0">v</span><span class="sc24"> 
        </span><span class="sc4">else</span><span class="sc24"> </span><span class="sc0">r</span><span class="sc12">:</span><span class="sc0">0,</span><span class="sc24">
    </span><span class="sc0">clifact</span><span class="sc13">(</span><span class="sc0">r</span><span class="sc13">)</span><span class="sc24">
</span><span class="sc13">)</span><span class="sc0">;</span><span class="sc24">

</span><span class="sc1">/*
 vector part
*/</span><span class="sc24">
</span><span class="sc0">vectorpart</span><span class="sc13">(</span><span class="sc0">v</span><span class="sc13">)</span><span class="sc12">:=</span><span class="sc4">block</span><span class="sc13">(</span><span class="sc0">[gr],</span><span class="sc24">
    </span><span class="sc4">if</span><span class="sc24"> </span><span class="sc5">freeof</span><span class="sc13">(</span><span class="sc0">asymbol,</span><span class="sc24"> </span><span class="sc0">v</span><span class="sc13">)</span><span class="sc24"> </span><span class="sc4">then</span><span class="sc24"> </span><span class="sc4">return</span><span class="sc24"> </span><span class="sc13">(</span><span class="sc3">0</span><span class="sc13">)</span><span class="sc0">,</span><span class="sc24">
    </span><span class="sc0">gr</span><span class="sc12">:</span><span class="sc0">grade</span><span class="sc13">(</span><span class="sc0">v</span><span class="sc13">)</span><span class="sc0">,</span><span class="sc24">
    </span><span class="sc0">clifact</span><span class="sc13">(</span><span class="sc0">gr[2]</span><span class="sc13">)</span><span class="sc24">
</span><span class="sc13">)</span><span class="sc0">;</span><span class="sc24">

</span><span class="sc1">/*
 multivector part
*/</span><span class="sc24">
</span><span class="sc0">mvectorpart</span><span class="sc13">(</span><span class="sc0">v</span><span class="sc13">)</span><span class="sc12">:=</span><span class="sc4">block</span><span class="sc13">(</span><span class="sc0">[</span><span class="sc24"> </span><span class="sc0">r,</span><span class="sc24"> </span><span class="sc0">l,</span><span class="sc24"> </span><span class="sc0">gr</span><span class="sc24"> </span><span class="sc0">],</span><span class="sc24">
    </span><span class="sc4">if</span><span class="sc24"> </span><span class="sc5">freeof</span><span class="sc13">(</span><span class="sc0">asymbol,</span><span class="sc24"> </span><span class="sc0">v</span><span class="sc13">)</span><span class="sc24"> </span><span class="sc4">then</span><span class="sc24"> </span><span class="sc4">return</span><span class="sc24"> </span><span class="sc13">(</span><span class="sc3">0</span><span class="sc13">)</span><span class="sc0">,</span><span class="sc24">
    </span><span class="sc0">gr</span><span class="sc12">:</span><span class="sc0">grade</span><span class="sc13">(</span><span class="sc0">v</span><span class="sc13">)</span><span class="sc0">,</span><span class="sc24">
    </span><span class="sc0">gr</span><span class="sc12">:</span><span class="sc5">sublist</span><span class="sc13">(</span><span class="sc0">gr,</span><span class="sc24"> </span><span class="sc4">lambda</span><span class="sc13">(</span><span class="sc0">[u],</span><span class="sc24"> </span><span class="sc4">not</span><span class="sc24"> </span><span class="sc5">freeof</span><span class="sc13">(</span><span class="sc2">"."</span><span class="sc0">,</span><span class="sc24"> </span><span class="sc0">u</span><span class="sc13">)))</span><span class="sc0">,</span><span class="sc24">
    </span><span class="sc4">if</span><span class="sc24"> </span><span class="sc5">emptyp</span><span class="sc13">(</span><span class="sc0">gr</span><span class="sc13">)</span><span class="sc24"> </span><span class="sc4">then</span><span class="sc24"> </span><span class="sc3">0</span><span class="sc24"> </span><span class="sc4">else</span><span class="sc24">
        </span><span class="sc0">gr</span><span class="sc12">:</span><span class="sc5">substinpart</span><span class="sc13">(</span><span class="sc2">"+"</span><span class="sc0">,</span><span class="sc24"> </span><span class="sc0">gr,</span><span class="sc24"> </span><span class="sc3">0</span><span class="sc13">)</span><span class="sc0">,</span><span class="sc24">
    </span><span class="sc0">clifact</span><span class="sc13">(</span><span class="sc0">gr</span><span class="sc13">)</span><span class="sc24">
</span><span class="sc13">)</span><span class="sc0">;</span><span class="sc24">

</span><span class="sc1">/**
 grade of order k
*/</span><span class="sc24">
</span><span class="sc0">grpart</span><span class="sc13">(</span><span class="sc0">v,</span><span class="sc24"> </span><span class="sc0">k</span><span class="sc13">)</span><span class="sc12">:=</span><span class="sc4">block</span><span class="sc13">(</span><span class="sc0">[gr,</span><span class="sc24"> </span><span class="sc0">u],</span><span class="sc24">
    </span><span class="sc4">if</span><span class="sc24"> </span><span class="sc5">listp</span><span class="sc13">(</span><span class="sc0">k</span><span class="sc13">)</span><span class="sc24"> </span><span class="sc4">then</span><span class="sc24">  
        </span><span class="sc5">substinpart</span><span class="sc13">(</span><span class="sc2">"+"</span><span class="sc0">,</span><span class="sc24"> </span><span class="sc5">map</span><span class="sc13">(</span><span class="sc4">lambda</span><span class="sc13">(</span><span class="sc0">[u],</span><span class="sc24"> </span><span class="sc0">grpart</span><span class="sc24"> </span><span class="sc13">(</span><span class="sc0">v,</span><span class="sc24"> </span><span class="sc0">u</span><span class="sc13">))</span><span class="sc0">,</span><span class="sc24"> </span><span class="sc0">k</span><span class="sc13">)</span><span class="sc0">,</span><span class="sc24"> </span><span class="sc3">0</span><span class="sc13">)</span><span class="sc24">  
    </span><span class="sc4">else</span><span class="sc24"> </span><span class="sc13">(</span><span class="sc24">
        </span><span class="sc0">k</span><span class="sc12">:</span><span class="sc0">k</span><span class="sc12">+</span><span class="sc0">1,</span><span class="sc24">
        </span><span class="sc4">if</span><span class="sc24"> </span><span class="sc0">k</span><span class="sc12">&gt;</span><span class="sc0">ndim</span><span class="sc12">+</span><span class="sc3">1</span><span class="sc24"> </span><span class="sc4">then</span><span class="sc24"> </span><span class="sc0">k</span><span class="sc12">:</span><span class="sc0">ndim</span><span class="sc12">+</span><span class="sc0">1,</span><span class="sc24">
        </span><span class="sc0">gr</span><span class="sc12">:</span><span class="sc0">grade</span><span class="sc13">(</span><span class="sc0">v</span><span class="sc13">)</span><span class="sc0">,</span><span class="sc24">
        </span><span class="sc0">clifact</span><span class="sc13">(</span><span class="sc0">gr[k]</span><span class="sc13">)</span><span class="sc24">
    </span><span class="sc13">)</span><span class="sc24">
</span><span class="sc13">)</span><span class="sc0">;</span><span class="sc24">

</span><span class="sc1">/**
 grade of order k, list version
*/</span><span class="sc24">
</span><span class="sc0">grpartl</span><span class="sc13">(</span><span class="sc0">lst,</span><span class="sc24"> </span><span class="sc0">k</span><span class="sc13">)</span><span class="sc12">:=</span><span class="sc4">block</span><span class="sc24"> </span><span class="sc13">(</span><span class="sc24">
    </span><span class="sc4">if</span><span class="sc24"> </span><span class="sc5">listp</span><span class="sc13">(</span><span class="sc0">lst</span><span class="sc13">)</span><span class="sc24"> </span><span class="sc4">then</span><span class="sc24"> </span><span class="sc5">substinpart</span><span class="sc13">(</span><span class="sc2">"+"</span><span class="sc0">,</span><span class="sc24"> </span><span class="sc5">map</span><span class="sc13">(</span><span class="sc4">lambda</span><span class="sc13">(</span><span class="sc0">[u],</span><span class="sc24"> </span><span class="sc0">grpart</span><span class="sc24"> </span><span class="sc13">(</span><span class="sc0">u,</span><span class="sc24"> </span><span class="sc0">k</span><span class="sc13">))</span><span class="sc0">,</span><span class="sc24"> </span><span class="sc0">lst</span><span class="sc13">)</span><span class="sc0">,</span><span class="sc24"> </span><span class="sc3">0</span><span class="sc13">)</span><span class="sc24">  
</span><span class="sc13">)</span><span class="sc0">;</span><span class="sc24">

</span><span class="sc1">/**
returns non-zero grade indices
*/</span><span class="sc24">
</span><span class="sc0">grades</span><span class="sc13">(</span><span class="sc0">vv</span><span class="sc13">)</span><span class="sc12">:=</span><span class="sc4">block</span><span class="sc13">(</span><span class="sc0">[lst,</span><span class="sc24"> </span><span class="sc0">uu,</span><span class="sc24"> </span><span class="sc7">listarith</span><span class="sc12">:</span><span class="sc8">true],</span><span class="sc24">
    </span><span class="sc0">lst</span><span class="sc12">:</span><span class="sc0">grade</span><span class="sc13">(</span><span class="sc0">vv</span><span class="sc13">)</span><span class="sc0">,</span><span class="sc24">
    </span><span class="sc5">sublist_indices</span><span class="sc24"> </span><span class="sc13">(</span><span class="sc0">lst,</span><span class="sc24"> </span><span class="sc4">lambda</span><span class="sc13">(</span><span class="sc0">[uu],</span><span class="sc24"> </span><span class="sc0">uu</span><span class="sc12">#</span><span class="sc3">0</span><span class="sc13">))</span><span class="sc3">-1</span><span class="sc24">
</span><span class="sc13">)</span><span class="sc0">;</span><span class="sc24">


</span><span class="sc1">/* 
 constructs a vector
*/</span><span class="sc24">
</span><span class="sc0">cvect</span><span class="sc13">(</span><span class="sc0">x,</span><span class="sc24"> </span><span class="sc0">[cc]</span><span class="sc13">)</span><span class="sc12">:=</span><span class="sc4">block</span><span class="sc24"> </span><span class="sc13">(</span><span class="sc0">[ss</span><span class="sc12">:</span><span class="sc0">0,</span><span class="sc24"> </span><span class="sc5">qq],</span><span class="sc24">
    </span><span class="sc4">if</span><span class="sc24"> </span><span class="sc5">emptyp</span><span class="sc13">(</span><span class="sc0">cc</span><span class="sc13">)</span><span class="sc24"> </span><span class="sc4">then</span><span class="sc24">
        </span><span class="sc0">ss</span><span class="sc12">:</span><span class="sc5">sum</span><span class="sc24"> </span><span class="sc13">(</span><span class="sc0">x[i]</span><span class="sc12">*</span><span class="sc0">asymbol[i],</span><span class="sc24"> </span><span class="sc0">i,</span><span class="sc24"> </span><span class="sc0">1,</span><span class="sc24"> </span><span class="sc0">ndim</span><span class="sc13">)</span><span class="sc24">
    </span><span class="sc4">else</span><span class="sc24"> </span><span class="sc13">(</span><span class="sc24">
        </span><span class="sc0">cc</span><span class="sc12">:</span><span class="sc0">cc[1],</span><span class="sc24">
        </span><span class="sc4">for</span><span class="sc24"> </span><span class="sc0">i</span><span class="sc12">:</span><span class="sc3">1</span><span class="sc24"> </span><span class="sc4">thru</span><span class="sc24"> </span><span class="sc5">length</span><span class="sc13">(</span><span class="sc0">cc</span><span class="sc13">)</span><span class="sc24"> </span><span class="sc4">do</span><span class="sc24"> 
            </span><span class="sc4">if</span><span class="sc24"> </span><span class="sc4">not</span><span class="sc24"> </span><span class="sc5">emptyp</span><span class="sc13">(</span><span class="sc0">cc[i]</span><span class="sc13">)</span><span class="sc24"> </span><span class="sc4">then</span><span class="sc24"> </span><span class="sc13">(</span><span class="sc24">
                </span><span class="sc5">qq</span><span class="sc12">:</span><span class="sc5">subst</span><span class="sc13">(</span><span class="sc0">x</span><span class="sc12">=</span><span class="sc0">cc[i],</span><span class="sc24"> </span><span class="sc4">buildq</span><span class="sc13">(</span><span class="sc0">[x],</span><span class="sc24"> </span><span class="sc4">declare</span><span class="sc13">(</span><span class="sc0">x,</span><span class="sc24"> </span><span class="sc9">scalar</span><span class="sc13">)))</span><span class="sc0">,</span><span class="sc24">
                </span><span class="sc4">ev</span><span class="sc13">(</span><span class="sc5">qq,</span><span class="sc24"> </span><span class="sc9">nouns</span><span class="sc13">)</span><span class="sc0">,</span><span class="sc24">
                </span><span class="sc0">ss</span><span class="sc12">:</span><span class="sc24"> </span><span class="sc0">ss</span><span class="sc12">+</span><span class="sc24"> </span><span class="sc0">x[</span><span class="sc24"> </span><span class="sc0">cc[i]</span><span class="sc24"> </span><span class="sc0">]</span><span class="sc12">*</span><span class="sc0">asymbol[i]</span><span class="sc24">
            </span><span class="sc13">)</span><span class="sc24">
        </span><span class="sc13">)</span><span class="sc0">,</span><span class="sc24">
    </span><span class="sc5">qq</span><span class="sc12">:</span><span class="sc4">buildq</span><span class="sc13">(</span><span class="sc0">[x],</span><span class="sc24"> </span><span class="sc4">declare</span><span class="sc13">(</span><span class="sc0">x,</span><span class="sc24"> </span><span class="sc9">scalar</span><span class="sc13">))</span><span class="sc0">,</span><span class="sc24">
    </span><span class="sc4">ev</span><span class="sc13">(</span><span class="sc5">qq,</span><span class="sc24"> </span><span class="sc9">nouns</span><span class="sc13">)</span><span class="sc0">,</span><span class="sc24">
    </span><span class="sc0">ss</span><span class="sc24">
</span><span class="sc13">)</span><span class="sc0">;</span><span class="sc24">

</span><span class="sc1">/* 
 constructs a multivector
*/</span><span class="sc24">
</span><span class="sc0">celem</span><span class="sc13">(</span><span class="sc0">x,</span><span class="sc24"> </span><span class="sc0">[cc]</span><span class="sc13">)</span><span class="sc12">:=</span><span class="sc4">block</span><span class="sc13">(</span><span class="sc0">[ee,</span><span class="sc24"> </span><span class="sc0">ss</span><span class="sc12">:</span><span class="sc0">0,</span><span class="sc24"> </span><span class="sc0">n,</span><span class="sc24"> </span><span class="sc5">qq],</span><span class="sc24">
     </span><span class="sc0">ee</span><span class="sc12">:</span><span class="sc5">elements</span><span class="sc13">(</span><span class="sc9">all</span><span class="sc13">)</span><span class="sc0">,</span><span class="sc24">
    </span><span class="sc0">n</span><span class="sc12">:</span><span class="sc5">length</span><span class="sc13">(</span><span class="sc0">ee</span><span class="sc13">)</span><span class="sc0">,</span><span class="sc24">
    </span><span class="sc4">if</span><span class="sc24"> </span><span class="sc5">emptyp</span><span class="sc13">(</span><span class="sc0">cc</span><span class="sc13">)</span><span class="sc24"> </span><span class="sc4">then</span><span class="sc24">
        </span><span class="sc0">ss</span><span class="sc12">:</span><span class="sc5">sum</span><span class="sc24"> </span><span class="sc13">(</span><span class="sc0">x[i]</span><span class="sc12">*</span><span class="sc0">ee[i],</span><span class="sc24"> </span><span class="sc0">i,</span><span class="sc24"> </span><span class="sc0">1,</span><span class="sc24"> </span><span class="sc0">n</span><span class="sc13">)</span><span class="sc24">
    </span><span class="sc4">else</span><span class="sc24"> </span><span class="sc13">(</span><span class="sc24">
        </span><span class="sc0">cc</span><span class="sc12">:</span><span class="sc0">cc[1],</span><span class="sc24">
        </span><span class="sc4">for</span><span class="sc24"> </span><span class="sc0">i</span><span class="sc12">:</span><span class="sc3">1</span><span class="sc24"> </span><span class="sc4">thru</span><span class="sc24"> </span><span class="sc5">length</span><span class="sc13">(</span><span class="sc0">cc</span><span class="sc13">)</span><span class="sc24"> </span><span class="sc4">do</span><span class="sc24"> 
            </span><span class="sc4">if</span><span class="sc24"> </span><span class="sc4">not</span><span class="sc24"> </span><span class="sc5">emptyp</span><span class="sc13">(</span><span class="sc0">cc[i]</span><span class="sc13">)</span><span class="sc24"> </span><span class="sc4">then</span><span class="sc24"> </span><span class="sc13">(</span><span class="sc24">
                </span><span class="sc4">if</span><span class="sc24"> </span><span class="sc5">symbolp</span><span class="sc13">(</span><span class="sc0">cc[i]</span><span class="sc13">)</span><span class="sc24"> </span><span class="sc4">then</span><span class="sc24"> </span><span class="sc13">(</span><span class="sc24">
                    </span><span class="sc5">qq</span><span class="sc12">:</span><span class="sc5">subst</span><span class="sc13">(</span><span class="sc0">x</span><span class="sc12">=</span><span class="sc0">cc[i],</span><span class="sc24"> </span><span class="sc4">buildq</span><span class="sc13">(</span><span class="sc0">[x],</span><span class="sc24"> </span><span class="sc4">declare</span><span class="sc13">(</span><span class="sc0">x,</span><span class="sc24"> </span><span class="sc9">scalar</span><span class="sc13">)))</span><span class="sc0">,</span><span class="sc24">
                    </span><span class="sc4">ev</span><span class="sc13">(</span><span class="sc5">qq,</span><span class="sc24"> </span><span class="sc9">nouns</span><span class="sc13">)</span><span class="sc24">
                </span><span class="sc13">)</span><span class="sc0">,</span><span class="sc24">
                </span><span class="sc0">ss</span><span class="sc12">:</span><span class="sc24"> </span><span class="sc0">ss</span><span class="sc12">+</span><span class="sc24"> </span><span class="sc0">x[</span><span class="sc24"> </span><span class="sc0">cc[i]</span><span class="sc24"> </span><span class="sc0">]</span><span class="sc12">*</span><span class="sc0">ee[i]</span><span class="sc24">
            </span><span class="sc13">)</span><span class="sc24">
        </span><span class="sc13">)</span><span class="sc0">,</span><span class="sc24">
    </span><span class="sc5">qq</span><span class="sc12">:</span><span class="sc4">buildq</span><span class="sc13">(</span><span class="sc0">[x],</span><span class="sc24"> </span><span class="sc4">declare</span><span class="sc13">(</span><span class="sc0">x,</span><span class="sc24"> </span><span class="sc9">scalar</span><span class="sc13">))</span><span class="sc0">,</span><span class="sc24">
    </span><span class="sc4">ev</span><span class="sc13">(</span><span class="sc5">qq,</span><span class="sc24"> </span><span class="sc9">nouns</span><span class="sc13">)</span><span class="sc0">,</span><span class="sc24">
    </span><span class="sc0">ss</span><span class="sc24">
</span><span class="sc13">)</span><span class="sc0">;</span><span class="sc24">

</span><span class="sc1">/**
 Application functions
*/</span><span class="sc24">

</span><span class="sc1">/**
   algebraical dual element
 */</span><span class="sc24">
</span><span class="sc0">dual</span><span class="sc13">(</span><span class="sc5">expr</span><span class="sc13">)</span><span class="sc12">:=</span><span class="sc4">block</span><span class="sc13">(</span><span class="sc0">[lste</span><span class="sc12">:</span><span class="sc0">[],</span><span class="sc24"> </span><span class="sc0">lsti</span><span class="sc12">:</span><span class="sc0">[],</span><span class="sc24"> </span><span class="sc0">r,</span><span class="sc24"> </span><span class="sc0">l],</span><span class="sc24">
    </span><span class="sc4">if</span><span class="sc24"> </span><span class="sc5">matrixp</span><span class="sc13">(</span><span class="sc5">expr</span><span class="sc13">)</span><span class="sc24"> </span><span class="sc4">then</span><span class="sc24">
        </span><span class="sc4">return</span><span class="sc13">(</span><span class="sc5">matrixmap</span><span class="sc13">(</span><span class="sc0">dual,</span><span class="sc24"> </span><span class="sc5">expr</span><span class="sc24"> </span><span class="sc13">))</span><span class="sc0">,</span><span class="sc24">
    </span><span class="sc4">if</span><span class="sc24"> </span><span class="sc5">listp</span><span class="sc13">(</span><span class="sc5">expr</span><span class="sc13">)</span><span class="sc24"> </span><span class="sc4">then</span><span class="sc24">
        </span><span class="sc4">return</span><span class="sc13">(</span><span class="sc5">maplist</span><span class="sc13">(</span><span class="sc0">dual,</span><span class="sc24"> </span><span class="sc5">expr</span><span class="sc24"> </span><span class="sc13">))</span><span class="sc0">,</span><span class="sc24">
        </span><span class="sc4">if</span><span class="sc24"> </span><span class="sc4">not</span><span class="sc24"> </span><span class="sc5">mapatom</span><span class="sc13">(</span><span class="sc5">expr</span><span class="sc13">)</span><span class="sc24"> </span><span class="sc4">and</span><span class="sc24"> </span><span class="sc5">op</span><span class="sc13">(</span><span class="sc5">expr</span><span class="sc13">)</span><span class="sc12">=</span><span class="sc2">"/"</span><span class="sc24"> </span><span class="sc4">then</span><span class="sc24"> </span><span class="sc13">(</span><span class="sc24">
        </span><span class="sc0">nn</span><span class="sc12">:</span><span class="sc5">num</span><span class="sc13">(</span><span class="sc5">expr</span><span class="sc13">)</span><span class="sc0">,</span><span class="sc24">
        </span><span class="sc0">dd</span><span class="sc12">:</span><span class="sc5">denom</span><span class="sc13">(</span><span class="sc5">expr</span><span class="sc13">)</span><span class="sc0">,</span><span class="sc24">
        </span><span class="sc4">return</span><span class="sc13">(</span><span class="sc5">map</span><span class="sc13">(</span><span class="sc0">dual,</span><span class="sc24"> </span><span class="sc0">nn</span><span class="sc13">)</span><span class="sc12">/</span><span class="sc0">dd</span><span class="sc13">))</span><span class="sc24">   
    </span><span class="sc4">elseif</span><span class="sc24"> </span><span class="sc4">not</span><span class="sc24"> </span><span class="sc5">mapatom</span><span class="sc13">(</span><span class="sc5">expr</span><span class="sc13">)</span><span class="sc24"> </span><span class="sc4">and</span><span class="sc24"> </span><span class="sc5">inop</span><span class="sc13">(</span><span class="sc5">expr</span><span class="sc13">)</span><span class="sc12">=</span><span class="sc2">"+"</span><span class="sc24"> </span><span class="sc4">then</span><span class="sc24"> 
        </span><span class="sc5">map</span><span class="sc13">(</span><span class="sc0">dual,</span><span class="sc24"> </span><span class="sc5">expr</span><span class="sc13">)</span><span class="sc24">
    </span><span class="sc4">else</span><span class="sc24"> </span><span class="sc13">(</span><span class="sc24">
        </span><span class="sc0">[l,</span><span class="sc24"> </span><span class="sc0">r]</span><span class="sc12">:</span><span class="sc5">subst</span><span class="sc13">(</span><span class="sc12">'</span><span class="sc8">nil</span><span class="sc12">=</span><span class="sc0">1,</span><span class="sc24"> </span><span class="sc5">oppart</span><span class="sc13">(</span><span class="sc5">expr,</span><span class="sc24"> </span><span class="sc4">lambda</span><span class="sc13">(</span><span class="sc0">[u],</span><span class="sc24"> </span><span class="sc5">freeof</span><span class="sc13">(</span><span class="sc0">asymbol,</span><span class="sc24"> </span><span class="sc0">u</span><span class="sc13">))))</span><span class="sc0">,</span><span class="sc24">
        </span><span class="sc0">lste</span><span class="sc12">:</span><span class="sc0">clv</span><span class="sc13">(</span><span class="sc0">r</span><span class="sc13">)</span><span class="sc0">,</span><span class="sc24">
        </span><span class="sc0">lsti</span><span class="sc12">:</span><span class="sc24"> </span><span class="sc0">vectors</span><span class="sc13">()</span><span class="sc0">,</span><span class="sc24">
        </span><span class="sc0">lste</span><span class="sc12">:</span><span class="sc24"> </span><span class="sc0">lste</span><span class="sc24"> </span><span class="sc0">xor</span><span class="sc24"> </span><span class="sc0">lsti,</span><span class="sc24">
        </span><span class="sc0">r</span><span class="sc12">:</span><span class="sc5">substinpart</span><span class="sc13">(</span><span class="sc2">"."</span><span class="sc0">,</span><span class="sc24"> </span><span class="sc0">lste,</span><span class="sc24"> </span><span class="sc3">0</span><span class="sc13">)</span><span class="sc0">,</span><span class="sc24">
        </span><span class="sc0">l</span><span class="sc12">*</span><span class="sc0">r</span><span class="sc24">
    </span><span class="sc13">)</span><span class="sc24">
</span><span class="sc13">)</span><span class="sc0">;</span><span class="sc24">

</span><span class="sc1">/**
   clifford dual element
 */</span><span class="sc24">
</span><span class="sc0">clidual</span><span class="sc13">(</span><span class="sc5">expr</span><span class="sc13">)</span><span class="sc12">:=</span><span class="sc4">block</span><span class="sc13">(</span><span class="sc0">[lste</span><span class="sc12">:</span><span class="sc0">[],</span><span class="sc24"> </span><span class="sc0">lsti</span><span class="sc12">:</span><span class="sc0">[],</span><span class="sc24"> </span><span class="sc0">r,</span><span class="sc24"> </span><span class="sc0">l,</span><span class="sc24"> </span><span class="sc0">ss</span><span class="sc12">:</span><span class="sc0">1,</span><span class="sc24"> </span><span class="sc0">nn,</span><span class="sc24"> </span><span class="sc0">dd],</span><span class="sc24">
    </span><span class="sc4">if</span><span class="sc24"> </span><span class="sc5">matrixp</span><span class="sc13">(</span><span class="sc5">expr</span><span class="sc13">)</span><span class="sc24"> </span><span class="sc4">then</span><span class="sc24">
        </span><span class="sc4">return</span><span class="sc13">(</span><span class="sc5">matrixmap</span><span class="sc13">(</span><span class="sc0">clidual,</span><span class="sc24"> </span><span class="sc5">expr</span><span class="sc24"> </span><span class="sc13">))</span><span class="sc0">,</span><span class="sc24">
    </span><span class="sc4">if</span><span class="sc24"> </span><span class="sc5">listp</span><span class="sc13">(</span><span class="sc5">expr</span><span class="sc13">)</span><span class="sc24"> </span><span class="sc4">then</span><span class="sc24">
        </span><span class="sc4">return</span><span class="sc13">(</span><span class="sc5">maplist</span><span class="sc13">(</span><span class="sc0">clidual,</span><span class="sc24"> </span><span class="sc5">expr</span><span class="sc24"> </span><span class="sc13">))</span><span class="sc0">,</span><span class="sc24">
    </span><span class="sc4">if</span><span class="sc24"> </span><span class="sc4">not</span><span class="sc24"> </span><span class="sc5">mapatom</span><span class="sc13">(</span><span class="sc5">expr</span><span class="sc13">)</span><span class="sc24"> </span><span class="sc4">and</span><span class="sc24"> </span><span class="sc5">op</span><span class="sc13">(</span><span class="sc5">expr</span><span class="sc13">)</span><span class="sc12">=</span><span class="sc2">"/"</span><span class="sc24"> </span><span class="sc4">then</span><span class="sc24"> </span><span class="sc13">(</span><span class="sc24">
        </span><span class="sc0">nn</span><span class="sc12">:</span><span class="sc5">num</span><span class="sc13">(</span><span class="sc5">expr</span><span class="sc13">)</span><span class="sc0">,</span><span class="sc24">
        </span><span class="sc0">dd</span><span class="sc12">:</span><span class="sc24"> </span><span class="sc5">denom</span><span class="sc13">(</span><span class="sc5">expr</span><span class="sc13">)</span><span class="sc0">,</span><span class="sc24">
        </span><span class="sc4">return</span><span class="sc13">(</span><span class="sc5">map</span><span class="sc13">(</span><span class="sc0">clidual,</span><span class="sc24"> </span><span class="sc0">nn</span><span class="sc13">)</span><span class="sc12">/</span><span class="sc0">dd</span><span class="sc13">))</span><span class="sc24">    
    </span><span class="sc4">elseif</span><span class="sc24"> </span><span class="sc4">not</span><span class="sc24"> </span><span class="sc5">mapatom</span><span class="sc13">(</span><span class="sc5">expr</span><span class="sc13">)</span><span class="sc24"> </span><span class="sc4">and</span><span class="sc24"> </span><span class="sc5">inop</span><span class="sc13">(</span><span class="sc5">expr</span><span class="sc13">)</span><span class="sc12">=</span><span class="sc2">"+"</span><span class="sc24"> </span><span class="sc4">then</span><span class="sc24"> 
        </span><span class="sc4">return</span><span class="sc13">(</span><span class="sc5">map</span><span class="sc13">(</span><span class="sc0">clidual,</span><span class="sc24"> </span><span class="sc5">expr</span><span class="sc13">))</span><span class="sc24">
    </span><span class="sc4">else</span><span class="sc24"> </span><span class="sc13">(</span><span class="sc24">
        </span><span class="sc0">[l,</span><span class="sc24"> </span><span class="sc0">r]</span><span class="sc12">:</span><span class="sc5">subst</span><span class="sc13">(</span><span class="sc12">'</span><span class="sc8">nil</span><span class="sc12">=</span><span class="sc0">1,</span><span class="sc24"> </span><span class="sc5">oppart</span><span class="sc13">(</span><span class="sc5">expr,</span><span class="sc24"> </span><span class="sc4">lambda</span><span class="sc13">(</span><span class="sc0">[u],</span><span class="sc24"> </span><span class="sc5">freeof</span><span class="sc13">(</span><span class="sc0">asymbol,</span><span class="sc24"> </span><span class="sc0">u</span><span class="sc13">))))</span><span class="sc0">,</span><span class="sc24">
        </span><span class="sc5">display</span><span class="sc13">(</span><span class="sc0">l,r</span><span class="sc13">)</span><span class="sc0">,</span><span class="sc24">
        </span><span class="sc0">lste</span><span class="sc12">:</span><span class="sc0">clv</span><span class="sc13">(</span><span class="sc0">r</span><span class="sc13">)</span><span class="sc0">,</span><span class="sc24">
        </span><span class="sc0">lsti</span><span class="sc12">:</span><span class="sc0">vectors</span><span class="sc13">()</span><span class="sc0">,</span><span class="sc24">
        </span><span class="sc4">if</span><span class="sc24"> </span><span class="sc8">%ivnorm</span><span class="sc12">#</span><span class="sc3">0</span><span class="sc24"> </span><span class="sc4">then</span><span class="sc24"> </span><span class="sc0">ss</span><span class="sc12">:</span><span class="sc8">%ivnorm,</span><span class="sc24">
        </span><span class="sc0">ss</span><span class="sc12">:</span><span class="sc0">ss</span><span class="sc12">*</span><span class="sc0">permsign</span><span class="sc13">(</span><span class="sc24"> </span><span class="sc5">append</span><span class="sc24"> </span><span class="sc13">(</span><span class="sc0">lste,</span><span class="sc24"> </span><span class="sc0">lsti</span><span class="sc13">))</span><span class="sc0">,</span><span class="sc24">
        </span><span class="sc0">lste</span><span class="sc12">:</span><span class="sc24"> </span><span class="sc0">lste</span><span class="sc24"> </span><span class="sc0">xor</span><span class="sc24"> </span><span class="sc0">lsti,</span><span class="sc24">
        </span><span class="sc0">r</span><span class="sc12">:</span><span class="sc5">substinpart</span><span class="sc13">(</span><span class="sc2">"."</span><span class="sc0">,</span><span class="sc24"> </span><span class="sc0">lste,</span><span class="sc24"> </span><span class="sc3">0</span><span class="sc13">)</span><span class="sc0">,</span><span class="sc24">
        </span><span class="sc0">ss</span><span class="sc12">*</span><span class="sc0">l</span><span class="sc12">*</span><span class="sc0">r</span><span class="sc24">
    </span><span class="sc13">)</span><span class="sc24">
</span><span class="sc13">)</span><span class="sc0">;</span><span class="sc24">
</span><span class="sc1">/*
 computes a unit  element
*/</span><span class="sc24">
</span><span class="sc0">uelem</span><span class="sc13">(</span><span class="sc0">vv</span><span class="sc13">)</span><span class="sc12">:=</span><span class="sc4">block</span><span class="sc13">(</span><span class="sc24"> </span><span class="sc0">[qq],</span><span class="sc24">
    </span><span class="sc5">qq</span><span class="sc12">:-</span><span class="sc0">cnorm</span><span class="sc13">(</span><span class="sc0">vv</span><span class="sc13">)</span><span class="sc0">,</span><span class="sc24">
    </span><span class="sc4">if</span><span class="sc24"> </span><span class="sc5">qq</span><span class="sc12">=</span><span class="sc3">0</span><span class="sc24"> </span><span class="sc4">then</span><span class="sc24"> </span><span class="sc4">return</span><span class="sc13">(</span><span class="sc0">vv</span><span class="sc13">)</span><span class="sc0">,</span><span class="sc24">
    </span><span class="sc4">if</span><span class="sc24"> </span><span class="sc8">%divsimp</span><span class="sc12">=</span><span class="sc8">true</span><span class="sc24"> </span><span class="sc4">then</span><span class="sc24"> </span><span class="sc13">(</span><span class="sc24">
        </span><span class="sc5">qq</span><span class="sc12">:</span><span class="sc5">trigsimp</span><span class="sc13">(</span><span class="sc5">qq</span><span class="sc13">)</span><span class="sc0">,</span><span class="sc24">
        </span><span class="sc5">qq</span><span class="sc12">:</span><span class="sc5">ratsimp</span><span class="sc13">(</span><span class="sc5">qq</span><span class="sc13">)</span><span class="sc24">
    </span><span class="sc13">)</span><span class="sc0">,</span><span class="sc24">
    </span><span class="sc0">vv</span><span class="sc12">/</span><span class="sc5">sqrt</span><span class="sc13">(</span><span class="sc5">qq</span><span class="sc13">)</span><span class="sc24">
</span><span class="sc13">)</span><span class="sc0">;</span><span class="sc24">

</span><span class="sc1">/*
 Clifford product decomposition
*/</span><span class="sc24">
</span><span class="sc0">prodecomp</span><span class="sc13">(</span><span class="sc0">a,b</span><span class="sc13">)</span><span class="sc12">:=</span><span class="sc4">block</span><span class="sc13">(</span><span class="sc24"> </span><span class="sc0">[ret,</span><span class="sc24"> </span><span class="sc0">gr,</span><span class="sc24"> </span><span class="sc0">l,</span><span class="sc24"> </span><span class="sc0">r,</span><span class="sc24"> </span><span class="sc0">m,</span><span class="sc24"> </span><span class="sc0">inner</span><span class="sc12">:</span><span class="sc0">0,</span><span class="sc24"> </span><span class="sc0">outer</span><span class="sc12">:</span><span class="sc0">0],</span><span class="sc24">
    </span><span class="sc0">a</span><span class="sc12">:</span><span class="sc0">cliffsimp1</span><span class="sc13">(</span><span class="sc0">a</span><span class="sc13">)</span><span class="sc0">,</span><span class="sc24">
    </span><span class="sc0">b</span><span class="sc12">:</span><span class="sc0">cliffsimp1</span><span class="sc13">(</span><span class="sc0">b</span><span class="sc13">)</span><span class="sc0">,</span><span class="sc24">
    </span><span class="sc0">ret</span><span class="sc12">:</span><span class="sc0">cliffsimp1</span><span class="sc13">(</span><span class="sc0">a.b</span><span class="sc13">)</span><span class="sc0">,</span><span class="sc24">
    </span><span class="sc0">l</span><span class="sc12">:</span><span class="sc5">maxgrade</span><span class="sc13">(</span><span class="sc0">a</span><span class="sc13">)</span><span class="sc0">,</span><span class="sc24">
    </span><span class="sc0">r</span><span class="sc12">:</span><span class="sc5">maxgrade</span><span class="sc13">(</span><span class="sc0">b</span><span class="sc13">)</span><span class="sc0">,</span><span class="sc24">
    </span><span class="sc0">m</span><span class="sc12">:</span><span class="sc5">abs</span><span class="sc13">(</span><span class="sc0">l</span><span class="sc12">-</span><span class="sc0">r</span><span class="sc13">)</span><span class="sc0">,</span><span class="sc24">
    </span><span class="sc0">n</span><span class="sc12">:</span><span class="sc0">l</span><span class="sc12">+</span><span class="sc0">r,</span><span class="sc24">  
    </span><span class="sc2">" display(l,r, m,n)"</span><span class="sc24"> </span><span class="sc0">,</span><span class="sc24"> 
    </span><span class="sc0">gr</span><span class="sc12">:</span><span class="sc0">grade</span><span class="sc13">(</span><span class="sc0">ret</span><span class="sc13">)</span><span class="sc0">,</span><span class="sc24">
    </span><span class="sc4">if</span><span class="sc24"> </span><span class="sc0">n</span><span class="sc12">&lt;=</span><span class="sc0">ndim</span><span class="sc24"> </span><span class="sc4">then</span><span class="sc24"> </span><span class="sc0">outer</span><span class="sc12">:</span><span class="sc24"> </span><span class="sc0">gr[n</span><span class="sc12">+</span><span class="sc0">1],</span><span class="sc24">
    </span><span class="sc4">if</span><span class="sc24"> </span><span class="sc0">m</span><span class="sc12">&lt;</span><span class="sc0">n</span><span class="sc24"> </span><span class="sc4">then</span><span class="sc24"> </span><span class="sc0">inner</span><span class="sc12">:</span><span class="sc24"> </span><span class="sc0">gr[m</span><span class="sc12">+</span><span class="sc0">1],</span><span class="sc24">
    </span><span class="sc0">ret</span><span class="sc12">:</span><span class="sc0">ret</span><span class="sc24"> </span><span class="sc12">-</span><span class="sc0">inner</span><span class="sc24"> </span><span class="sc12">-</span><span class="sc24"> </span><span class="sc0">outer,</span><span class="sc24">
    </span><span class="sc0">[inner,</span><span class="sc24"> </span><span class="sc0">outer,</span><span class="sc24"> </span><span class="sc0">ret]</span><span class="sc24">
</span><span class="sc13">)</span><span class="sc0">;</span><span class="sc24">

</span><span class="sc0">comm</span><span class="sc13">(</span><span class="sc0">a,b</span><span class="sc13">)</span><span class="sc12">:=</span><span class="sc24"> </span><span class="sc0">cliffsimp1</span><span class="sc24"> </span><span class="sc13">(</span><span class="sc5">expand</span><span class="sc13">(</span><span class="sc0">a.</span><span class="sc24"> </span><span class="sc0">b</span><span class="sc24"> </span><span class="sc12">-</span><span class="sc24"> </span><span class="sc0">b.</span><span class="sc24"> </span><span class="sc0">a</span><span class="sc13">))</span><span class="sc12">/</span><span class="sc0">2;</span><span class="sc24">
</span><span class="sc0">acomm</span><span class="sc13">(</span><span class="sc0">a,b</span><span class="sc13">)</span><span class="sc12">:=</span><span class="sc0">cliffsimp1</span><span class="sc24"> </span><span class="sc13">(</span><span class="sc5">expand</span><span class="sc13">(</span><span class="sc0">a.</span><span class="sc24"> </span><span class="sc0">b</span><span class="sc24"> </span><span class="sc12">+</span><span class="sc24"> </span><span class="sc0">b.</span><span class="sc24"> </span><span class="sc0">a</span><span class="sc13">))</span><span class="sc12">/</span><span class="sc0">2;</span><span class="sc24">

</span><span class="sc1">/*
reciprocal automorphism
*/</span><span class="sc24">
</span><span class="sc0">invautom</span><span class="sc13">(</span><span class="sc0">vv</span><span class="sc13">)</span><span class="sc12">:=</span><span class="sc4">block</span><span class="sc13">(</span><span class="sc24"> </span><span class="sc0">[ee,</span><span class="sc24"> </span><span class="sc0">aa,</span><span class="sc24"> </span><span class="sc0">ei,</span><span class="sc24"> </span><span class="sc7">listarith</span><span class="sc12">:</span><span class="sc8">true],</span><span class="sc24">
 </span><span class="sc0">[ee,</span><span class="sc24"> </span><span class="sc0">aa]</span><span class="sc12">:</span><span class="sc0">clicoeff</span><span class="sc13">(</span><span class="sc0">vv,</span><span class="sc12">'</span><span class="sc0">list</span><span class="sc13">)</span><span class="sc0">,</span><span class="sc24">
 </span><span class="sc0">ei</span><span class="sc12">:</span><span class="sc24"> </span><span class="sc5">maplist</span><span class="sc13">(</span><span class="sc24"> </span><span class="sc0">cinvblade,</span><span class="sc24"> </span><span class="sc0">ee</span><span class="sc13">)</span><span class="sc0">,</span><span class="sc24">
 </span><span class="sc0">ei.</span><span class="sc24"> </span><span class="sc0">aa</span><span class="sc24">
</span><span class="sc13">)</span><span class="sc0">;</span><span class="sc24">

</span><span class="sc0">cinvblade</span><span class="sc13">(</span><span class="sc0">ab</span><span class="sc13">)</span><span class="sc12">:=</span><span class="sc4">block</span><span class="sc13">(</span><span class="sc24"> </span><span class="sc0">[dd],</span><span class="sc24">
    </span><span class="sc0">dd</span><span class="sc12">:</span><span class="sc5">dotsimpc</span><span class="sc13">(</span><span class="sc0">ab.ab</span><span class="sc13">)</span><span class="sc0">,</span><span class="sc24">
    </span><span class="sc4">if</span><span class="sc24"> </span><span class="sc4">not</span><span class="sc24"> </span><span class="sc5">scalarp</span><span class="sc13">(</span><span class="sc0">dd</span><span class="sc13">)</span><span class="sc24"> </span><span class="sc4">then</span><span class="sc24"> </span><span class="sc4">error</span><span class="sc13">(</span><span class="sc0">dd,</span><span class="sc24"> </span><span class="sc2">"  not a scalar"</span><span class="sc13">)</span><span class="sc0">,</span><span class="sc24">
    </span><span class="sc0">dd</span><span class="sc12">*</span><span class="sc0">ab</span><span class="sc24">
</span><span class="sc13">)</span><span class="sc0">;</span><span class="sc24">

</span><span class="sc1">/*
grade  automorphism by  predicate
predf requires 2 arguments : grade part and grade index
*/</span><span class="sc24">
</span><span class="sc5">predautom</span><span class="sc13">(</span><span class="sc0">vv,</span><span class="sc24"> </span><span class="sc5">predf</span><span class="sc13">)</span><span class="sc12">:=</span><span class="sc4">block</span><span class="sc24"> </span><span class="sc13">(</span><span class="sc0">[gr,</span><span class="sc24"> </span><span class="sc0">v</span><span class="sc12">:</span><span class="sc0">0,</span><span class="sc24"> </span><span class="sc0">k,</span><span class="sc24"> </span><span class="sc0">w],</span><span class="sc24">
    </span><span class="sc4">if</span><span class="sc24"> </span><span class="sc4">not</span><span class="sc24"> </span><span class="sc5">freeof</span><span class="sc13">(</span><span class="sc2">"."</span><span class="sc0">,</span><span class="sc24"> </span><span class="sc0">vv</span><span class="sc13">)</span><span class="sc24"> </span><span class="sc4">then</span><span class="sc24"> 
        </span><span class="sc0">gr</span><span class="sc12">:</span><span class="sc24"> </span><span class="sc0">grade</span><span class="sc13">(</span><span class="sc0">vv,</span><span class="sc24"> </span><span class="sc8">true</span><span class="sc13">)</span><span class="sc24">
    </span><span class="sc4">else</span><span class="sc24"> 
        </span><span class="sc0">gr</span><span class="sc12">:</span><span class="sc24"> </span><span class="sc0">grade</span><span class="sc13">(</span><span class="sc0">vv</span><span class="sc13">)</span><span class="sc0">,</span><span class="sc24">  
    </span><span class="sc4">for</span><span class="sc24"> </span><span class="sc0">i</span><span class="sc12">:</span><span class="sc3">1</span><span class="sc24"> </span><span class="sc4">thru</span><span class="sc24"> </span><span class="sc0">ndim</span><span class="sc12">+</span><span class="sc3">1</span><span class="sc24"> </span><span class="sc4">do</span><span class="sc24"> </span><span class="sc13">(</span><span class="sc24">
        </span><span class="sc0">w</span><span class="sc12">:</span><span class="sc5">apply</span><span class="sc13">(</span><span class="sc5">predf,</span><span class="sc24"> </span><span class="sc0">[gr[i],</span><span class="sc24"> </span><span class="sc0">i]</span><span class="sc13">)</span><span class="sc0">,</span><span class="sc24">
        </span><span class="sc4">if</span><span class="sc24"> </span><span class="sc0">w</span><span class="sc24"> </span><span class="sc4">then</span><span class="sc24"> </span><span class="sc0">k</span><span class="sc12">:</span><span class="sc3">-1</span><span class="sc24"> </span><span class="sc4">else</span><span class="sc24"> </span><span class="sc0">k</span><span class="sc12">:</span><span class="sc0">1,</span><span class="sc24"> 
        </span><span class="sc0">v</span><span class="sc12">:</span><span class="sc0">v</span><span class="sc24"> </span><span class="sc12">+</span><span class="sc24"> </span><span class="sc0">k</span><span class="sc24"> </span><span class="sc12">*</span><span class="sc24"> </span><span class="sc0">gr[i]</span><span class="sc24"> 
    </span><span class="sc13">)</span><span class="sc0">,</span><span class="sc24">
    </span><span class="sc0">v</span><span class="sc24">
</span><span class="sc13">)</span><span class="sc0">;</span><span class="sc24">

</span><span class="sc1">/* 
Hitzer-Sangwine automorphism
*/</span><span class="sc24">
</span><span class="sc0">hautom</span><span class="sc13">(</span><span class="sc0">vv,</span><span class="sc24"> </span><span class="sc0">lst</span><span class="sc13">)</span><span class="sc12">:=</span><span class="sc4">block</span><span class="sc13">(</span><span class="sc0">[listarith</span><span class="sc12">:</span><span class="sc8">true</span><span class="sc24"> </span><span class="sc0">],</span><span class="sc24">
    </span><span class="sc5">predautom</span><span class="sc13">(</span><span class="sc0">vv,</span><span class="sc24"> </span><span class="sc4">lambda</span><span class="sc13">(</span><span class="sc0">[u,v],</span><span class="sc24">  </span><span class="sc5">member</span><span class="sc13">(</span><span class="sc0">v,</span><span class="sc24"> </span><span class="sc0">lst</span><span class="sc12">+</span><span class="sc3">1</span><span class="sc13">)))</span><span class="sc24">
</span><span class="sc13">)</span><span class="sc0">;</span><span class="sc24">

</span><span class="sc1">/* 
scalar part   automorphism
*/</span><span class="sc24">
</span><span class="sc0">sautom</span><span class="sc13">(</span><span class="sc0">vv</span><span class="sc13">)</span><span class="sc12">:=</span><span class="sc5">predautom</span><span class="sc13">(</span><span class="sc0">vv,</span><span class="sc24"> </span><span class="sc4">lambda</span><span class="sc13">(</span><span class="sc0">[u,v],</span><span class="sc24"> </span><span class="sc4">not</span><span class="sc24"> </span><span class="sc5">scalarp</span><span class="sc13">(</span><span class="sc0">u</span><span class="sc13">)))</span><span class="sc0">;</span><span class="sc24">

</span><span class="sc7">psautom</span><span class="sc13">(</span><span class="sc0">vv</span><span class="sc13">)</span><span class="sc12">:=</span><span class="sc5">predautom</span><span class="sc13">(</span><span class="sc0">vv,</span><span class="sc24"> </span><span class="sc4">lambda</span><span class="sc13">(</span><span class="sc0">[u,v],</span><span class="sc24"> </span><span class="sc5">maxgrade</span><span class="sc13">(</span><span class="sc0">u</span><span class="sc13">)</span><span class="sc12">=</span><span class="sc0">ndim</span><span class="sc13">))</span><span class="sc0">;</span><span class="sc24">

</span><span class="sc1">/*  Shirokov quaternion  type classification */</span><span class="sc24">
</span><span class="sc0">qclass</span><span class="sc24"> </span><span class="sc13">(</span><span class="sc0">vv</span><span class="sc13">)</span><span class="sc24"> </span><span class="sc12">:=</span><span class="sc4">block</span><span class="sc24"> </span><span class="sc13">(</span><span class="sc24"> </span><span class="sc0">[ar,</span><span class="sc24"> </span><span class="sc0">ai,</span><span class="sc24"> </span><span class="sc0">as,</span><span class="sc24"> </span><span class="sc0">br,</span><span class="sc24"> </span><span class="sc0">bi,</span><span class="sc24"> </span><span class="sc0">bc],</span><span class="sc24">
    </span><span class="sc0">ar</span><span class="sc12">:</span><span class="sc0">dotreverse</span><span class="sc13">(</span><span class="sc0">vv</span><span class="sc13">)</span><span class="sc0">,</span><span class="sc24">
    </span><span class="sc0">ai</span><span class="sc12">:</span><span class="sc0">cinvolve</span><span class="sc13">(</span><span class="sc0">vv</span><span class="sc13">)</span><span class="sc0">,</span><span class="sc24">    
    </span><span class="sc0">br</span><span class="sc12">:</span><span class="sc13">(</span><span class="sc0">vv</span><span class="sc24"> </span><span class="sc12">-</span><span class="sc24"> </span><span class="sc0">ar</span><span class="sc13">)</span><span class="sc12">/</span><span class="sc0">2,</span><span class="sc24">
    </span><span class="sc0">br</span><span class="sc12">:</span><span class="sc5">apply1</span><span class="sc13">(</span><span class="sc0">br,</span><span class="sc24"> </span><span class="sc0">clifsimp10,</span><span class="sc24"> </span><span class="sc0">clifsimp21</span><span class="sc13">)</span><span class="sc0">,</span><span class="sc24">
    </span><span class="sc0">bi</span><span class="sc12">:</span><span class="sc13">(</span><span class="sc0">vv</span><span class="sc12">-</span><span class="sc0">ai</span><span class="sc13">)</span><span class="sc12">/</span><span class="sc0">2,</span><span class="sc24">
    </span><span class="sc0">bi</span><span class="sc12">:</span><span class="sc5">apply1</span><span class="sc13">(</span><span class="sc0">bi,</span><span class="sc24"> </span><span class="sc0">clifsimp10,</span><span class="sc24"> </span><span class="sc0">clifsimp21</span><span class="sc13">)</span><span class="sc0">,</span><span class="sc24">
    </span><span class="sc4">if</span><span class="sc24"> </span><span class="sc7">verbose</span><span class="sc12">=</span><span class="sc8">true</span><span class="sc24"> </span><span class="sc4">then</span><span class="sc24"> </span><span class="sc5">display</span><span class="sc13">(</span><span class="sc0">bi,</span><span class="sc24"> </span><span class="sc0">ar</span><span class="sc13">)</span><span class="sc0">,</span><span class="sc24">
    </span><span class="sc4">if</span><span class="sc24"> </span><span class="sc0">br</span><span class="sc12">#</span><span class="sc3">0</span><span class="sc24"> </span><span class="sc4">then</span><span class="sc24"> </span><span class="sc0">br</span><span class="sc12">:</span><span class="sc0">1,</span><span class="sc24">
    </span><span class="sc4">if</span><span class="sc24"> </span><span class="sc0">bi</span><span class="sc12">#</span><span class="sc3">0</span><span class="sc24"> </span><span class="sc4">then</span><span class="sc24"> </span><span class="sc0">bi</span><span class="sc12">:</span><span class="sc0">1,</span><span class="sc24">
    </span><span class="sc1">/*disp([br, bi]),*/</span><span class="sc24">
    </span><span class="sc4">if</span><span class="sc24"> </span><span class="sc0">br</span><span class="sc12">=</span><span class="sc3">0</span><span class="sc24"> </span><span class="sc4">and</span><span class="sc24"> </span><span class="sc0">bi</span><span class="sc12">=</span><span class="sc3">0</span><span class="sc24"> </span><span class="sc4">then</span><span class="sc24"> </span><span class="sc3">0</span><span class="sc24">
    </span><span class="sc4">elseif</span><span class="sc24"> </span><span class="sc0">bi</span><span class="sc12">=</span><span class="sc3">1</span><span class="sc24"> </span><span class="sc4">and</span><span class="sc24"> </span><span class="sc0">br</span><span class="sc12">=</span><span class="sc3">0</span><span class="sc24"> </span><span class="sc4">then</span><span class="sc24"> </span><span class="sc3">1</span><span class="sc24"> 
    </span><span class="sc4">elseif</span><span class="sc24"> </span><span class="sc0">bi</span><span class="sc12">=</span><span class="sc3">0</span><span class="sc24"> </span><span class="sc4">and</span><span class="sc24"> </span><span class="sc0">br</span><span class="sc12">=</span><span class="sc3">1</span><span class="sc24"> </span><span class="sc4">then</span><span class="sc24"> </span><span class="sc3">2</span><span class="sc24">
    </span><span class="sc4">elseif</span><span class="sc24"> </span><span class="sc0">bi</span><span class="sc12">=</span><span class="sc3">1</span><span class="sc24"> </span><span class="sc4">and</span><span class="sc24"> </span><span class="sc0">br</span><span class="sc12">=</span><span class="sc3">1</span><span class="sc24"> </span><span class="sc4">then</span><span class="sc24"> </span><span class="sc3">3</span><span class="sc24">
</span><span class="sc13">)</span><span class="sc0">;</span><span class="sc24">

</span><span class="sc1">/**
class-grade decomposition 
*/</span><span class="sc24">
</span><span class="sc0">cdgrade</span><span class="sc13">(</span><span class="sc0">vv,</span><span class="sc24"> </span><span class="sc0">classf</span><span class="sc13">)</span><span class="sc12">:=</span><span class="sc4">block</span><span class="sc24"> </span><span class="sc13">(</span><span class="sc0">[gr,</span><span class="sc24"> </span><span class="sc0">w,</span><span class="sc24"> </span><span class="sc0">k,</span><span class="sc24"> </span><span class="sc0">cs,</span><span class="sc24"> </span><span class="sc0">clist],</span><span class="sc24">
    </span><span class="sc4">if</span><span class="sc24"> </span><span class="sc4">not</span><span class="sc24"> </span><span class="sc5">freeof</span><span class="sc13">(</span><span class="sc2">"."</span><span class="sc0">,</span><span class="sc24"> </span><span class="sc0">vv</span><span class="sc13">)</span><span class="sc24"> </span><span class="sc4">then</span><span class="sc24"> 
        </span><span class="sc0">gr</span><span class="sc12">:</span><span class="sc24"> </span><span class="sc0">grade</span><span class="sc13">(</span><span class="sc5">expand</span><span class="sc13">(</span><span class="sc0">vv</span><span class="sc13">))</span><span class="sc24">
    </span><span class="sc4">else</span><span class="sc24"> 
        </span><span class="sc0">gr</span><span class="sc12">:</span><span class="sc24"> </span><span class="sc0">grade</span><span class="sc13">(</span><span class="sc0">vv</span><span class="sc13">)</span><span class="sc0">,</span><span class="sc24">
    </span><span class="sc4">local</span><span class="sc13">(</span><span class="sc0">cs</span><span class="sc13">)</span><span class="sc0">,</span><span class="sc24"> 
    </span><span class="sc4">for</span><span class="sc24"> </span><span class="sc0">i</span><span class="sc12">:</span><span class="sc3">1</span><span class="sc24"> </span><span class="sc4">thru</span><span class="sc24"> </span><span class="sc0">ndim</span><span class="sc12">+</span><span class="sc3">1</span><span class="sc24"> </span><span class="sc4">do</span><span class="sc24"> </span><span class="sc13">(</span><span class="sc24">
        </span><span class="sc0">k</span><span class="sc12">:</span><span class="sc5">apply</span><span class="sc13">(</span><span class="sc0">classf,</span><span class="sc24"> </span><span class="sc0">[gr[i],</span><span class="sc24"> </span><span class="sc0">i]</span><span class="sc13">)</span><span class="sc0">,</span><span class="sc24">
        </span><span class="sc4">if</span><span class="sc24"> </span><span class="sc5">op</span><span class="sc13">(</span><span class="sc0">cs[k]</span><span class="sc13">)</span><span class="sc12">='</span><span class="sc0">cs</span><span class="sc24"> </span><span class="sc4">then</span><span class="sc24"> </span><span class="sc0">cs[k]</span><span class="sc12">:</span><span class="sc0">0,</span><span class="sc24"> 
        </span><span class="sc0">cs[k]</span><span class="sc12">:</span><span class="sc0">cs[k]</span><span class="sc12">+</span><span class="sc0">gr[i]</span><span class="sc24">
    </span><span class="sc13">)</span><span class="sc0">,</span><span class="sc24">  
    </span><span class="sc5">listarray</span><span class="sc13">(</span><span class="sc0">cs</span><span class="sc13">)</span><span class="sc24">
</span><span class="sc13">)</span><span class="sc0">;</span><span class="sc24">

</span><span class="sc1">/**
even-odd decomposition
*/</span><span class="sc24">
</span><span class="sc0">evdecomp</span><span class="sc13">(</span><span class="sc0">vv</span><span class="sc13">)</span><span class="sc12">:=</span><span class="sc0">cdgrade</span><span class="sc13">(</span><span class="sc0">vv,</span><span class="sc24"> </span><span class="sc4">lambda</span><span class="sc13">(</span><span class="sc0">[u,</span><span class="sc24"> </span><span class="sc0">v</span><span class="sc24"> </span><span class="sc0">],</span><span class="sc24">  </span><span class="sc4">if</span><span class="sc24"> </span><span class="sc5">oddp</span><span class="sc13">(</span><span class="sc0">v</span><span class="sc13">)</span><span class="sc24"> </span><span class="sc4">then</span><span class="sc24"> </span><span class="sc3">1</span><span class="sc24"> </span><span class="sc4">else</span><span class="sc24"> </span><span class="sc3">2</span><span class="sc13">))</span><span class="sc0">;</span><span class="sc24">

</span><span class="sc1">/*  Shirokov quaternion  type  grading */</span><span class="sc24">
</span><span class="sc0">qgrade</span><span class="sc13">(</span><span class="sc0">vv</span><span class="sc13">)</span><span class="sc12">:=</span><span class="sc0">cdgrade</span><span class="sc13">(</span><span class="sc0">vv,</span><span class="sc24"> </span><span class="sc4">lambda</span><span class="sc13">(</span><span class="sc0">[u,v</span><span class="sc24"> </span><span class="sc0">],</span><span class="sc24">  </span><span class="sc0">qclass</span><span class="sc13">(</span><span class="sc0">u</span><span class="sc13">)</span><span class="sc3">+1</span><span class="sc13">))</span><span class="sc0">;</span><span class="sc24">


</span><span class="sc5">put</span><span class="sc13">(</span><span class="sc12">'</span><span class="sc0">clifford,</span><span class="sc24"> </span><span class="sc12">'</span><span class="sc0">v24,</span><span class="sc12">'</span><span class="sc0">version</span><span class="sc13">)</span><span class="sc0">;</span><span class="sc24">
</span><span class="sc5">put</span><span class="sc13">(</span><span class="sc12">'</span><span class="sc0">clifford,</span><span class="sc24"> </span><span class="sc2">"Dimiter Prodanov"</span><span class="sc0">,</span><span class="sc24"> </span><span class="sc12">'</span><span class="sc0">author</span><span class="sc13">)</span><span class="sc0">;</span><span class="sc24">
</span><span class="sc5">put</span><span class="sc13">(</span><span class="sc12">'</span><span class="sc0">clifford,</span><span class="sc24"> </span><span class="sc2">"(C) - Dimiter Prodanov, 2015 - 2019"</span><span class="sc0">,</span><span class="sc24"> </span><span class="sc12">'</span><span class="sc0">copyright</span><span class="sc13">)</span><span class="sc0">;</span><span class="sc24">

</span><span class="sc7">ttyoff</span><span class="sc12">:</span><span class="sc8">false;</span><span class="sc24">

</span><span class="sc5">print</span><span class="sc13">(</span><span class="sc2">"package name: clifford.mac"</span><span class="sc13">)</span><span class="sc0">;</span><span class="sc24">
</span><span class="sc5">print</span><span class="sc13">(</span><span class="sc2">"author: "</span><span class="sc0">,</span><span class="sc24"> </span><span class="sc5">get</span><span class="sc13">(</span><span class="sc12">'</span><span class="sc0">clifford,</span><span class="sc12">'</span><span class="sc0">author</span><span class="sc13">))</span><span class="sc0">;</span><span class="sc24">
</span><span class="sc5">print</span><span class="sc13">(</span><span class="sc2">"version:"</span><span class="sc0">,</span><span class="sc24"> </span><span class="sc5">get</span><span class="sc13">(</span><span class="sc12">'</span><span class="sc0">clifford,</span><span class="sc12">'</span><span class="sc0">version</span><span class="sc13">))</span><span class="sc0">;</span><span class="sc24">
</span><span class="sc5">print</span><span class="sc13">(</span><span class="sc2">"Recommended location: share/contrib"</span><span class="sc13">)</span><span class="sc0">;</span><span class="sc24">
</span><span class="sc5">print</span><span class="sc13">(</span><span class="sc2">"last update: 20 Feb 2019"</span><span class="sc13">)</span><span class="sc0">;</span></div></body>
</html>
